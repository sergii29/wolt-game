<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #00ccff;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff3d00;
            --accent-purple: #d500f9;
            --brand-blue: #0088cc; 
            --taxi-yellow: #ffcc00;
            --taxi-black: #222;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); overflow: hidden; user-select: none; }
        
        /* –ö–ê–†–¢–ê –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù */
        #map { height: 100%; width: 100%; z-index: 1; background: #222; }

        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; border: none; }
        .balance-display { background: rgba(0, 0, 0, 0.8); padding: 8px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .debt-warning { color: var(--accent-red); font-size: 10px; font-weight: bold; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); position: relative; }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; display: block; margin-top: 5px; }
        .tiny-stat { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 900; color: #fff; text-shadow: 0 0 3px #000; z-index: 50; pointer-events: none; }

        .game-toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(0, 0, 0, 0.9); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; z-index: 1001; opacity: 0; transition: all 0.3s; pointer-events: none; display: flex; align-items: center; gap: 8px; white-space: nowrap; border: 1px solid #333; }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-warn { border-color: var(--accent-orange); color: var(--accent-orange); }
        .toast-success { border-color: var(--accent-green); color: var(--accent-green); }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); color: #333; }

        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-top: 10px; transition: background 0.3s; }
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; text-transform: uppercase; font-size: 14px; }
        .slider-knob { position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px; background: var(--brand-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: grab; z-index: 2; transition: transform 0.1s; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 136, 204, 0.2); z-index: 0; }
        
        .slider-container.taxi-mode { background: #fff9c4; border: 1px solid #fbc02d; }
        .slider-container.taxi-mode .slider-knob { background: var(--taxi-yellow); color: black; }
        .slider-container.taxi-mode .slider-fill { background: rgba(255, 204, 0, 0.3); }
        .slider-container.taxi-mode .slider-text { color: #f57f17; }
        
        .slider-container.scheduled { background: #ffebee; border: 1px solid #ffcdd2; }
        .slider-container.scheduled .slider-knob { background: var(--accent-red); }
        .slider-container.scheduled .slider-text { color: var(--accent-red); }

        .controls-row { display: flex; gap: 10px; margin-top: 15px; }
        .pedal-btn { flex: 1; background: var(--brand-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 0 #006699; transition: all 0.1s; }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; }
        .pedal-btn.blocked { background: var(--accent-orange); box-shadow: 0 4px 0 #e65100; cursor: not-allowed; }
        
        .pedal-btn.taxi-pedal { background: var(--taxi-black); color: var(--taxi-yellow); box-shadow: 0 4px 0 #444; }

        .bribe-btn { display:none; flex: 1; background: #222; color: #ff3d00; border: 1px solid #ff3d00; padding: 18px; border-radius: 16px; font-size: 14px; font-weight: 800; text-transform: uppercase; cursor: pointer; animation: pulse 1s infinite; }

        .bag-btn { width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; position: relative; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .quick-inv { position: absolute; bottom: 90px; left: 20px; width: 220px; background: #252525; color: white; padding: 10px; border-radius: 16px; z-index: 1005; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); border: 1px solid #444; }
        .quick-inv.open { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: background 0.2s; }
        .inv-item:active { background: rgba(255,255,255,0.2); }
        .inv-item.link-btn { background: var(--brand-blue); justify-content: center; font-weight: bold; }
        .inv-count { background: var(--brand-blue); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; max-width: 320px; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; align-items: center; }
        .menu-divider { height: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .menu-section-title { font-size: 12px; color: var(--taxi-yellow); text-transform: uppercase; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px; margin-top: 10px; }
        .menu-item.locked { opacity: 0.5; cursor: not-allowed; color: #777; }
        .menu-item.taxi-item { border-bottom: 1px solid #444; }
        .menu-item.taxi-item i { width: 25px; text-align: center; }
        
        .taxi-toggle-btn { background: #333; color: #777; width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #444; font-weight: bold; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .taxi-toggle-btn.active { background: var(--taxi-yellow); color: black; border-color: var(--taxi-yellow); box-shadow: 0 0 15px rgba(255, 204, 0, 0.4); }

        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        .shop-section { margin-bottom: 25px; }
        .shop-section h3 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .shop-card { background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .shop-btn { padding: 8px 14px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; border: 1px solid var(--brand-blue); color: var(--brand-blue); background: white; min-width: 80px; transition: all 0.2s; }
        .shop-btn.buy { background: var(--brand-blue); color: white; }
        .shop-btn.bought { background: var(--accent-green); border-color: var(--accent-green); color: white; transform: scale(1.05); }
        .shop-btn:disabled { background: #eee; color: #aaa; border-color: #eee; cursor: not-allowed; }

        .bank-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 24px; font-weight: bold; margin-bottom: 15px; box-sizing: border-box; }
        .bank-actions { display: flex; gap: 10px; }
        .bank-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-loan { background: var(--accent-green); color: #004d40; }
        .btn-repay { background: var(--accent-orange); color: #3e2723; }
        .debt-alert-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ef9a9a; display: none; }
        .govt-btn { background: #37474f; color: white; border-color: #37474f; }
        
        .accept-timer-bg { width: 100%; height: 6px; background: #eee; margin-top: 8px; border-radius: 3px; overflow: hidden; display: none; }
        .accept-timer-fill { height: 100%; background: var(--accent-red); width: 100%; }
        @keyframes shrinkTimer { from { width: 100%; } to { width: 0%; } }
        .animate-timer { animation: shrinkTimer 15s linear forwards; }
        .delivery-timer { font-size: 11px; color: #666; margin-top: 2px; font-weight: bold; }

        /* AUTH STYLES */
        .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .auth-title { text-align: center; color: white; font-size: 18px; margin-bottom: 20px; text-transform: uppercase; font-weight: bold; }
        .auth-input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 14px; text-transform: uppercase; }
        .btn-login { background: var(--brand-blue); color: white; }
        .btn-register { background: transparent; border: 1px solid var(--accent-green); color: var(--accent-green); margin-top: 10px; }
        .auth-footer { text-align: center; font-size: 10px; color: #666; margin-top: 15px; line-height: 1.4; }
        .close-auth { position: absolute; top: 10px; right: 10px; color: #666; font-size: 20px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å <span id="debt-warning" class="debt-warning">(–î–û–õ–ì!)</span></div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon" id="icon-vehicle"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div><span class="equip-label" id="label-vehicle">–í–ï–õ</span><div class="tiny-stat" id="stat-bike"></div></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon" id="icon-bag"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label" id="label-bag">–°–£–ú–ö–ê</span><div class="tiny-stat" id="stat-bag"></div></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span><div class="tiny-stat" id="stat-phone"></div></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon" id="icon-gear"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label" id="label-gear">–û–î–ï–ñ–î–ê</span><div class="tiny-stat" id="stat-gear"></div></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" id="icon-energy" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label" id="label-energy">–°–ò–õ–´</span><div class="tiny-stat" id="stat-energy"></div></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span><div class="tiny-stat" id="stat-water"></div></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span><div class="tiny-stat" id="stat-mood"></div></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-box">
            <div style="text-align:right; margin-bottom:10px;"><i class="fa-solid fa-xmark" onclick="closeAuthModal()" style="color:#888; font-size:20px; cursor:pointer"></i></div>
            <div class="auth-title"><i class="fa-solid fa-lock"></i> –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            <p style="font-size:11px; color:#aaa; margin-bottom:15px; text-align:center">–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ Android/Web.<br>Telegram –≤—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
            <input type="text" id="auth-login" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn btn-login" onclick="performLogin()">–í–æ–π—Ç–∏</button>
            <button class="auth-btn btn-register" onclick="performRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 5px">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="player-name-display" style="font-size:18px; color:var(--brand-blue); font-weight:bold; margin-bottom:5px"></div>
            <div id="player-id-display" style="font-size:10px; color:#666; display:block; margin-bottom:20px">Loading ID...</div>
            
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store" style="color:var(--brand-blue)"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns" style="color:var(--accent-green)"></i> –ë–∞–Ω–∫ / –ö—Ä–µ–¥–∏—Ç</div>
            <div class="menu-item" onclick="openModal('deflation')"><i class="fa-solid fa-scale-unbalanced-flip" style="color:#90a4ae"></i> –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ / –ò–Ω—Ñ–ª—è—Ü–∏—è</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            
            <div class="menu-divider"></div>
            <div class="menu-section-title">üöñ –¢–∞–∫—Å–∏ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
            <div class="menu-item taxi-item locked" id="taxi-showroom-btn" onclick="openModal('taxi-shop')">
                <i class="fa-solid fa-car" style="color:var(--taxi-yellow)"></i> –ê–≤—Ç–æ—Å–∞–ª–æ–Ω
            </div>
            <div class="menu-item taxi-item locked" id="taxi-licenses-btn" onclick="openModal('taxi-licenses')">
                <i class="fa-solid fa-id-card" style="color:#aaa"></i> –õ–∏—Ü–µ–Ω–∑–∏–∏ / –ü—Ä–∞–≤–∞
            </div>
            
            <button id="taxi-toggle-btn" class="taxi-toggle-btn" onclick="toggleTaxiMode()" style="display:none">
                <i class="fa-solid fa-taxi"></i> <span>–í–ö–õ–Æ–ß–ò–¢–¨ TAXI</span>
            </button>

            <div id="taxi-lock-msg" style="font-size:10px; color:#666; margin-left:15px; margin-top:5px; font-style:italic">
                <i class="fa-solid fa-lock"></i> –¢—Ä–µ–±—É–µ—Ç—Å—è 50 –¥–æ—Å—Ç–∞–≤–æ–∫ (–£ –≤–∞—Å: <span id="career-count">0</span>)
            </div>

            <div style="margin-top:auto">
                <div class="menu-item" id="auth-menu-item" onclick="openAuthModal()" style="display:none; color:var(--accent-green)">
                    <i class="fa-solid fa-key"></i> üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </div>

                <div class="menu-item" onclick="resetGame()" style="color:var(--accent-red); display:flex; flex-direction:column; align-items:flex-start; gap:0">
                    <div style="display:flex; gap:15px; align-items:center"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
                    <div style="font-size:10px; opacity:0.7; margin-left:35px">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ. –¶–µ–Ω–∞: 7000 PLN (–î–æ–ª–≥)</div>
                </div>
            </div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title" id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0" id="city-label">–í–∞—Ä—à–∞–≤–∞</h3>
            <div id="demo-mode-alert" style="color:#ff3d00; font-size:11px; margin:5px 0; display:none; border:1px solid #ff3d00; padding:5px; border-radius:5px; background:rgba(0,0,0,0.05); font-weight:bold; text-align:center;">
                ‚ö†Ô∏è –î–ï–ú–û –†–ï–ñ–ò–ú (Android/Web)<br>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!
            </div>

            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ò–Ω—Ñ–ª—è—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω–∞</p>
            <div class="slider-container" id="offline-slider-box">
                <div class="slider-fill" id="offline-slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="offline-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div style="flex:1">
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px">
                        <span style="font-size:12px; color:#666" id="order-dest">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                        <span id="order-offer" style="font-weight:bold; color:var(--accent-green); font-size:15px">-- PLN</span>
                    </div>
                    <div style="display:flex; justify-content:flex-end; align-items:center">
                        <span id="delivery-timer" class="delivery-timer"></span>
                    </div>
                    <div class="accept-timer-bg" id="accept-timer"><div class="accept-timer-fill" id="accept-timer-fill"></div></div>
                </div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--brand-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--brand-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--brand-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–ü–æ–∏—Å–∫...</span>
            </div>

            <div class="slider-container" id="online-slider-box">
                <div class="slider-fill" id="online-slider-fill"></div>
                <div class="slider-text" id="online-slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="online-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó (PEDAL)</button>
                <button class="bribe-btn" id="bribe-btn" onclick="giveBribe()">–î–ê–¢–¨ –í–ó–Ø–¢–ö–£ (-20)</button>
            </div>
            <div id="garnishment-info" style="font-size:11px; color:var(--accent-red); text-align:center; display:none">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", 
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Connected");
        } catch(e) { console.error("Firebase Error:", e); }

        const SAVE_KEY = 'WARSZAWA_FOREVER';
        const TAXI_UNLOCK_REQ = 50;
        const WARSAW_CENTER = [52.2297, 21.0122]; // Center Coord
        
        let gameConfig = {
            basePickupPay: 4.0, perKmPay: 1.5, payVariance: 2.0, 
            inflationRate: 0.1, trafficChance: 0.1, trafficDuration: 5000,
            energyDrain: 0.15, waterDrain: 0.10, moodDrain: 0.05, 
            deliveryTime: 60, coolingRate: 0.5, 
            tipChance: 0.5, tipBonusChance: 0.3, tipMinTemp: 60, tipMinMood: 80,
            itemPrices: {}
        };

        const ITEMS_DB = {
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle', desc: '–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ–π (+100%)' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open', desc: '–ó–∞–ø–ª–∞—Ç–∫–∞ –¥—ã—Ä (+100%)' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen', desc: '–û–ø–ª–∞—Ç–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (+100%)' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt', desc: '–•–∏–º—á–∏—Å—Ç–∫–∞ (+100%)' },
            
            // TAXI SPECIFIC ITEMS
            car_main: { name: '–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å', type: 'repair', baseCost: 100, icon: 'fa-wrench', desc: '–†–µ–º–æ–Ω—Ç –ø–æ–¥–≤–µ—Å–∫–∏ –∏ –¢–û (+100%)' },
            car_interior: { name: '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞', type: 'repair', baseCost: 40, icon: 'fa-sparkles', desc: '–ß–∏—Å—Ç–æ—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (+100%)' },
            car_tires: { name: '–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂', type: 'repair', baseCost: 80, icon: 'fa-circle-notch', desc: '–°–º–µ–Ω–∞ —Ä–µ–∑–∏–Ω—ã (+100%)' },
            
            water: { name: '–í–æ–¥–∞ (0.5–ª)', type: 'buy', cost: 2.0, icon: 'fa-bottle-water', effect: { water: 35, energy: 5 }, desc: '–°–ø–∞—Å–∞–µ—Ç –æ—Ç –∂–∞–∂–¥—ã.', target: 'water' },
            bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.5, icon: 'fa-cookie-bite', effect: { energy: 20, mood: 15 }, desc: '–ë–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏.', target: 'energy' },
            energy_drink: { name: 'Red Bull', type: 'buy', cost: 7.0, icon: 'fa-bolt', effect: { energy: 50, mood: 5, water: -5 }, desc: '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –≠–ù–ï–†–ì–ò–ò, –Ω–æ –Ω–µ –≤–æ–¥—ã!', target: 'energy', special: 'no_drain' },
            coffee: { name: '–õ–∞—Ç—Ç–µ', type: 'buy', cost: 9.0, icon: 'fa-mug-hot', effect: { mood: 30, energy: 10 }, desc: '–î–ª—è –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!', target: 'mood' },
            chocolate: { name: '–®–æ–∫–æ–ª–∞–¥–∫–∞', type: 'buy', cost: 6.5, icon: 'fa-gift', effect: { mood: 20 }, desc: '–°—ä–µ—à—å –Ω–∞ –∑–∞–∫–∞–∑–µ - –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–æ–±—Ä–µ–µ—Ç!', target: 'mood', special: 'gift' },

            // FUEL (For taxi mode)
            gas: { name: '–ë–µ–Ω–∑–∏–Ω (10–ª)', type: 'buy', cost: 12.0, icon: 'fa-gas-pump', effect: { energy: 80 }, desc: '–ó–∞–ø—Ä–∞–≤–∫–∞ –∞–≤—Ç–æ.', target: 'energy' }
        };

        // DEFAULT STATE
        const DEFAULT_STATE = {
            name: null, 
            balance: 0, debt: 0, debtTimer: 0, debtOverdue: false,
            loanStreak: 0, 
            isOnline: false, isSearching: false, scheduledOffline: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 },
            needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 },
            history: [],
            energyBoostActive: false,
            isAuth: false,
            career: { totalOrders: 0 },
            taxi: { unlocked: false, active: false, vehicle: null, licenses: { driver: false, insurance: false, taxi: false } }
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE)); 
        state.id = 'u_' + Math.random().toString(36).substr(2, 9);

        // MAP VISUALS GLOBALS
        let map;
        let mapVisuals = { courierMarker: null, destMarker: null, routeLine: null, startCoords: null, endCoords: null };

        const restaurants = [
            { name: "McDonald's", icon: "üçî" }, { name: "KFC", icon: "üçó" },
            { name: "Pasibus", icon: "üçî" }, { name: "Kebab King", icon: "üåØ" },
            { name: "Sushi Master", icon: "üç£" }, { name: "Pizza Hut", icon: "üçï" }
        ];

        const taxiDestinations = [
            { name: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–æ–ø–µ–Ω", icon: "‚úàÔ∏è" }, { name: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –í–æ–∫–∑–∞–ª", icon: "üöÜ" },
            { name: "–ë–∏–∑–Ω–µ—Å –¶–µ–Ω—Ç—Ä", icon: "üè¢" }, { name: "–°—Ç–∞—Ä—ã–π –ì–æ—Ä–æ–¥", icon: "üèõ" },
            { name: "–ö–ª—É–± 'Level 27'", icon: "üç∏" }, { name: "–¢–¶ Zlote Tarasy", icon: "üõç" }
        ];
        
        const clientNames = ["–ê–Ω–Ω–∞", "–ü–µ—Ç—Ä", "–ö–∞—Å—è", "–ú–∏—Ö–∞–ª", "–û–ª—å–≥–∞", "–¢–æ–º–∞—à", "–Æ–ª–∏—è", "–Ø–∫—É–±"];
        const clientGreetings = ["–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Å–ø–µ—à—É –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç!", "–ü—Ä–∏–≤–µ—Ç! –ù–∞ –≤–æ–∫–∑–∞–ª, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.", "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–æ–∂–Ω–æ –ø–æ–±—ã—Å—Ç—Ä–µ–µ?", "–≠–π, —à–µ—Ñ! –í —Ü–µ–Ω—Ç—Ä, –ø–ª–∞—á—É —â–µ–¥—Ä–æ!","–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –Ω–∞ —Ä–∞–±–æ—Ç—É –æ–ø–∞–∑–¥—ã–≤–∞—é."];

        let currentOrder = null;
        let acceptTimeout = null;
        let orderInterval = null;
        let lastSync = 0;
        let penaltyInterval = null;

        function init() {
            // MAP INIT
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            
            // FIX: Force Map Resize (fixes black screen)
            setTimeout(() => { map.invalidateSize(); }, 500);

            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            loadGame();

            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                state.id = tg.initDataUnsafe.user.id.toString();
                state.name = tg.initDataUnsafe.user.first_name;
                if(tg.initDataUnsafe.user.username) state.name += ` (@${tg.initDataUnsafe.user.username})`;
                state.isAuth = true; 
                saveGame();
                setTimeout(() => {
                    const authBtn = document.getElementById('auth-menu-item');
                    if(authBtn) authBtn.style.display = 'none';
                    document.getElementById('demo-mode-alert').style.display = 'none';
                }, 500);
                listenToCloud(); syncToCloud(true);
            } else {
                if (!state.name) state.name = "Guest Courier";
                if (!state.isAuth) {
                     document.getElementById('demo-mode-alert').style.display = 'block';
                     document.getElementById('auth-menu-item').style.display = 'flex';
                } else {
                     document.getElementById('demo-mode-alert').style.display = 'none';
                }
            }
            
            document.getElementById('player-id-display').textContent = `ID: ${state.id}`;
            document.getElementById('player-name-display').textContent = state.name;
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            initSliders();
            
            setInterval(checkDebt, 1000); 
            setInterval(checkSystemPenalties, 60000);
            if(state.isAuth || true) { listenToCloud(); syncToCloud(true); }

            updateMenuState(); updateAuthUI(); updateUI(); updateVisualStats();
        }

        // MAP LOGIC (EMBEDDED)
        function getRandomPoint() {
            const lat = WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.06;
            const lng = WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.10;
            return [lat, lng];
        }

        function drawRoute() {
            if (!map || !currentOrder) return;
            if (!mapVisuals.startCoords) {
                mapVisuals.startCoords = getRandomPoint();
                mapVisuals.endCoords = getRandomPoint();
            }
            const start = mapVisuals.startCoords;
            const end = mapVisuals.endCoords;
            clearMapVisuals();

            mapVisuals.routeLine = L.polyline([start, end], { color: '#009de0', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
            
            const destIcon = L.divIcon({ html: '<i class="fa-solid fa-house-user" style="color:#ff3d00; font-size:24px; text-shadow: 2px 2px 2px rgba(0,0,0,0.5);"></i>', className: 'custom-div-icon', iconSize: [24, 24], iconAnchor: [12, 12] });
            mapVisuals.destMarker = L.marker(end, {icon: destIcon}).addTo(map);

            const courierIconHtml = state.taxi.active 
                ? '<i class="fa-solid fa-taxi" style="color:#ffcc00; font-size:20px; border:2px solid black; background:black; border-radius:50%; padding:5px;"></i>'
                : '<i class="fa-solid fa-bicycle" style="color:white; font-size:20px; border:2px solid #009de0; background:#009de0; border-radius:50%; padding:5px;"></i>';
            const courierIcon = L.divIcon({ html: courierIconHtml, className: 'custom-div-icon', iconSize: [30, 30], iconAnchor: [15, 15] });
            mapVisuals.courierMarker = L.marker(start, {icon: courierIcon, zIndexOffset: 1000}).addTo(map);

            map.fitBounds([start, end], {padding: [50, 50]});
        }

        function updateCourierPosition(progress) {
            if (!mapVisuals.courierMarker || !mapVisuals.startCoords) return;
            const pct = progress / 100;
            const start = mapVisuals.startCoords;
            const end = mapVisuals.endCoords;
            const currentLat = start[0] + (end[0] - start[0]) * pct;
            const currentLng = start[1] + (end[1] - start[1]) * pct;
            mapVisuals.courierMarker.setLatLng([currentLat, currentLng]);
        }

        function clearMapVisuals() {
            if (mapVisuals.routeLine) map.removeLayer(mapVisuals.routeLine);
            if (mapVisuals.destMarker) map.removeLayer(mapVisuals.destMarker);
            if (mapVisuals.courierMarker) map.removeLayer(mapVisuals.courierMarker);
            mapVisuals.routeLine = null; mapVisuals.destMarker = null; mapVisuals.courierMarker = null;
        }

        function checkSystemPenalties() {
            let penalize = false;
            ['energy', 'water', 'mood'].forEach(k => { if(state.needs[k] < 0) penalize = true; });
            ['bike', 'bag', 'phone', 'gear'].forEach(k => { if(state.items[k] < 0) penalize = true; });

            if(penalize) {
                state.balance -= 1.0;
                showToast('‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï! –®—Ç—Ä–∞—Ñ -1.00 PLN', 'warn');
                saveGame(); updateUI();
            }
        }

        // AUTH & SYSTEM
        function openAuthModal() { toggleMenu(); document.getElementById('auth-modal').style.display = 'flex'; }
        function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }
        
        function performRegister() {
            const login = document.getElementById('auth-login').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(login.length < 3 || pass.length < 3) { showToast('–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞', 'warn'); return; }
            db.ref('users_lookup/' + login).once('value', snap => {
                if(snap.exists()) { showToast('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç!', 'warn'); } else {
                    const userData = { pass: pass, playerId: state.id, login: login };
                    db.ref('users_lookup/' + login).set(userData).then(() => {
                          state.name = login; state.isAuth = true; saveGame(); syncToCloud(true); updateUI(); updateAuthUI(); 
                          closeAuthModal(); showToast('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                          document.getElementById('player-name-display').textContent = state.name;
                          document.getElementById('demo-mode-alert').style.display = 'none';
                    });
                }
            });
        }

        function performLogin() {
            const login = document.getElementById('auth-login').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            db.ref('users_lookup/' + login).once('value', snap => {
                if(!snap.exists()) { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warn'); return; }
                const data = snap.val();
                if(data.pass !== pass) { showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'warn'); return; }
                const targetId = data.playerId;
                showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...', 'success');
                db.ref('players/' + targetId).once('value', playerSnap => {
                    let playerData = playerSnap.val();
                    if (!playerData) { playerData = JSON.parse(JSON.stringify(DEFAULT_STATE)); playerData.name = login; }
                    state = { ...DEFAULT_STATE, ...playerData };
                    state.id = targetId; state.isAuth = true;
                    if(!state.items) state.items = { bike: 100, bag: 100, phone: 100, gear: 100 };
                    if(!state.needs) state.needs = { energy: 100, water: 100, mood: 100 };
                    if(!state.taxi) state.taxi = { unlocked: false, active: false, vehicle: null, licenses: { driver: false, insurance: false, taxi: false } };
                    if(!state.inventory) state.inventory = { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 };
                    saveGame(); updateUI(); updateMenuState(); updateAuthUI();
                    document.getElementById('player-id-display').textContent = `ID: ${state.id}`;
                    document.getElementById('player-name-display').textContent = state.name;
                    document.getElementById('demo-mode-alert').style.display = 'none';
                    listenToCloud(); closeAuthModal(); showToast(`–ü—Ä–∏–≤–µ—Ç, ${state.name}!`, 'success');
                });
            });
        }

        function performLogout() {
            if(confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ, –Ω–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω.")) {
                localStorage.removeItem(SAVE_KEY); location.reload();
            }
        }

        function updateAuthUI() {
            const btn = document.getElementById('auth-menu-item'); if(!btn) return;
            const tg = window.Telegram.WebApp;
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) { btn.style.display = 'none'; return; }
            btn.style.display = 'flex';
            if (state.isAuth) { btn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> üö™ –í—ã—Ö–æ–¥'; btn.style.color = 'var(--accent-red)'; btn.onclick = performLogout; } 
            else { btn.innerHTML = '<i class="fa-solid fa-key"></i> üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'; btn.style.color = 'var(--accent-green)'; btn.onclick = openAuthModal; }
        }

        function sendLog(msg, type='INFO') {
            if(!db) return;
            const logEntry = { timestamp: firebase.database.ServerValue.TIMESTAMP, playerId: state.id, playerName: state.name || 'Anon', message: msg, type: type };
            db.ref('logs').push(logEntry);
        }

        function syncToCloud(force = false) {
            if (!db) return;
            const now = Date.now();
            if (force || now - lastSync > 3000) {
                db.ref('players/' + state.id).update({
                    name: state.name, balance: state.balance, isOnline: state.isOnline, lastSeen: now,
                    stats: state.needs, inventory: state.inventory, debt: state.debt, items: state.items,
                    career: state.career, taxi: state.taxi, isAuth: state.isAuth || false
                });
                lastSync = now;
            }
        }

        function listenToCloud() {
            if (!db) return;
            db.ref('config').on('value', (snap) => {
                const val = snap.val();
                if (val) { gameConfig = { ...gameConfig, ...val }; if (val.itemPrices) { for(let k in val.itemPrices) { if(ITEMS_DB[k]) ITEMS_DB[k].cost = val.itemPrices[k]; } } }
            });
            db.ref('players/' + state.id).off(); 
            db.ref('players/' + state.id).on('value', (snap) => {
                const data = snap.val(); if (!data) return;
                if (data.isBanned) { document.body.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;background:black;color:#ff3d00;font-size:20px;font-weight:bold;flex-direction:column;text-align:center;padding:20px"><i class="fa-solid fa-ban" style="font-size:60px;margin-bottom:20px"></i><div>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</div></div>`; return; }
                if (data.balance !== undefined && Math.abs(data.balance - state.balance) > 0.1) { state.balance = data.balance; updateUI(); }
            });
            db.ref('players/' + state.id + '/adminInbox').off();
            db.ref('players/' + state.id + '/adminInbox').on('child_added', (snap) => { const cmd = snap.val(); handleAdminCommand(cmd); snap.ref.remove(); });
        }

        function handleAdminCommand(cmd) {
            if (cmd.type === 'SET_VAR') {
                const path = cmd.path.split('.'); let target = state;
                for (let i = 0; i < path.length - 1; i++) { if (target[path[i]] === undefined) target[path[i]] = {}; target = target[path[i]]; }
                target[path[path.length - 1]] = cmd.value;
            }
            if (cmd.type === 'FULL_RESET') { localStorage.removeItem(SAVE_KEY); location.reload(); }
            saveGame(); updateUI();
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) {
                    state = { ...DEFAULT_STATE, ...JSON.parse(saved) };
                    if (!state.id) state.id = 'u_' + Math.random().toString(36).substr(2, 9);
                    if(!state.taxi) state.taxi = DEFAULT_STATE.taxi;
                    if(!state.career) state.career = DEFAULT_STATE.career;
                }
                state.scheduledOffline = false;
            } catch(e) { localStorage.removeItem(SAVE_KEY); state = JSON.parse(JSON.stringify(DEFAULT_STATE)); state.id = 'u_' + Math.random().toString(36).substr(2, 9); }
        }

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); syncToCloud(); }

        function checkDebt() {
            if (state.debt > 0 && !state.debtOverdue) {
                if (Date.now() > state.debtTimer) {
                    state.debtOverdue = true; showToast('–°–†–û–ö –ö–†–ï–î–ò–¢–ê –ò–°–¢–ï–ö! –®–¢–†–ê–§ ' + (getGarnishmentRate()*100).toFixed(0) + '%', 'warn'); updateUI();
                    if(document.getElementById('full-modal').classList.contains('open') && document.getElementById('modal-title').textContent.includes('–ë–∞–Ω–∫')) renderBank(document.getElementById('modal-body'));
                } else { if(document.getElementById('full-modal').classList.contains('open') && document.getElementById('modal-title').textContent.includes('–ë–∞–Ω–∫')) { updateBankTimer(); } }
            }
        }

        function getGarnishmentRate() { let s = state.loanStreak || 0; if (s === 0) return 0.10; if (s === 1) return 0.20; if (s === 2) return 0.30; return 0.50; }

        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            ['bike','bag','phone','gear'].forEach(k => updateBar(`bar-${k}`, state.items[k]));
            ['energy','water','mood'].forEach(k => updateBar(`bar-${k}`, state.needs[k]));
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv;
            document.getElementById('bag-count').style.display = totalInv ? 'flex' : 'none';
            const warn = document.getElementById('debt-warning');
            const garnInfo = document.getElementById('garnishment-info');
            
            if (state.debtOverdue && state.debt > 0) { 
                warn.style.display = 'inline'; garnInfo.style.display = 'block';
                garnInfo.textContent = '‚ö†Ô∏è –ü–†–û–°–†–û–ß–ö–ê! –£–¥–µ—Ä–∂–∏–≤–∞–µ–º ' + (getGarnishmentRate()*100).toFixed(0) + '% —Å –∑–∞–∫–∞–∑–∞';
            } else { warn.style.display = 'none'; garnInfo.style.display = 'none'; }

            const isTaxi = state.taxi.active;
            const sliders = document.querySelectorAll('.slider-container');
            const pedal = document.getElementById('pedal-btn');
            
            sliders.forEach(s => { if(isTaxi) s.classList.add('taxi-mode'); else s.classList.remove('taxi-mode'); });

            const vehLabel = document.getElementById('label-vehicle');
            const vehIcon = document.getElementById('icon-vehicle');
            const bagLabel = document.getElementById('label-bag');
            const bagIcon = document.getElementById('icon-bag');
            const gearLabel = document.getElementById('label-gear');
            const gearIcon = document.getElementById('icon-gear');
            const energyLabel = document.getElementById('label-energy');
            const energyIcon = document.getElementById('icon-energy');
            const energyBar = document.getElementById('bar-energy');
            const trackIcon = document.getElementById('track-icon');

            if(isTaxi) {
                vehLabel.textContent = "–ê–í–¢–û"; vehIcon.className = "fa-solid fa-car equip-icon";
                bagLabel.textContent = "–°–ê–õ–û–ù"; bagIcon.className = "fa-solid fa-sparkles equip-icon";
                gearLabel.textContent = "–®–ò–ù–´"; gearIcon.className = "fa-solid fa-circle-notch equip-icon";
                energyLabel.textContent = "–ë–ï–ù–ó–ò–ù"; energyIcon.className = "fa-solid fa-gas-pump equip-icon";
                energyIcon.style.color = "orange"; energyBar.style.backgroundColor = "orange";
                trackIcon.innerHTML = '<i class="fa-solid fa-taxi"></i>';
                document.getElementById('city-label').innerHTML = '–í–∞—Ä—à–∞–≤–∞ <span style="font-size:10px; color:#fbc02d; border:1px solid #fbc02d; padding:0 3px; border-radius:3px">TAXI</span>';
                if(!currentOrder) pedal.textContent = "–ü–û–ò–°–ö –ö–õ–ò–ï–ù–¢–ê...";
                pedal.classList.add('taxi-pedal');
            } else {
                vehLabel.textContent = "–í–ï–õ"; vehIcon.className = "fa-solid fa-bicycle equip-icon";
                bagLabel.textContent = "–°–£–ú–ö–ê"; bagIcon.className = "fa-solid fa-box-open equip-icon";
                gearLabel.textContent = "–û–î–ï–ñ–î–ê"; gearIcon.className = "fa-solid fa-shirt equip-icon";
                energyLabel.textContent = "–°–ò–õ–´"; energyIcon.className = "fa-solid fa-bolt equip-icon";
                energyIcon.style.color = "yellow"; energyBar.style.backgroundColor = "yellow";
                trackIcon.innerHTML = '<i class="fa-solid fa-bicycle"></i>';
                document.getElementById('city-label').textContent = '–í–∞—Ä—à–∞–≤–∞';
                if(!currentOrder) pedal.textContent = "–ñ–ú–ò –ì–ê–ó (PEDAL)";
                pedal.classList.remove('taxi-pedal');
            }

            const btn = document.getElementById('taxi-toggle-btn');
            if(isTaxi) { btn.classList.add('active'); btn.innerHTML = '<i class="fa-solid fa-briefcase"></i> <span>–í–ï–†–ù–£–¢–¨–°–Ø –ö –ö–£–†–¨–ï–†–°–¢–í–£</span>'; } 
            else { btn.classList.remove('active'); btn.innerHTML = '<i class="fa-solid fa-taxi"></i> <span>–í–ö–õ–Æ–ß–ò–¢–¨ TAXI</span>'; }
            
            updateVisualStats();
        }

        function updateBar(id, val) { 
            let pct = val < 0 ? 0 : (val > 100 ? 100 : val); document.getElementById(id).style.width = pct + '%'; 
        }

        // VISUAL UPDATE (Patch 55 Integrated)
        function updateVisualStats() {
            if(typeof state === 'undefined' || !state.items) return;
            const stats = { 'bike':state.items.bike, 'bag':state.items.bag, 'phone':state.items.phone, 'gear':state.items.gear, 'energy':state.needs.energy, 'water':state.needs.water, 'mood':state.needs.mood };
            for (let [key, val] of Object.entries(stats)) {
                const el = document.getElementById(`stat-${key}`);
                if(el) {
                    const clean = Math.floor(val);
                    el.textContent = clean + '%';
                    el.style.color = (clean < 0) ? '#ff3d00' : '#fff';
                }
            }
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast'); t.innerHTML = msg;
            t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : (type==='success' ? 'toast-success' : ''));
            setTimeout(() => t.className = 'game-toast', 3000);
        }

        function startOrderLoop() {
            if (orderInterval) clearInterval(orderInterval);
            orderInterval = setInterval(() => {
                if (!currentOrder || !currentOrder.accepted) return;
                currentOrder.timeLeft--;
                document.getElementById('delivery-timer').textContent = `‚è± ${currentOrder.timeLeft}—Å`;
                if (currentOrder.timeLeft <= 0) { failOrder("time"); return; }
                
                if(!state.taxi.active) {
                    let baseCooling = gameConfig.coolingRate || 0.5; let decay = baseCooling * (1 + ((100 - state.items.bag) / 100)); currentOrder.foodTemp -= decay;
                } else {
                    let interior = state.items.bag; let decay = 0.2 + ((100 - interior) / 500); currentOrder.foodTemp -= decay; 
                }
                
                if (currentOrder.foodTemp < 50 && !currentOrder.tempWarned) { showToast('‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç!', 'warn'); currentOrder.tempWarned = true; }
                let label = state.taxi.active ? '–ö–æ–º—Ñ–æ—Ä—Ç' : '–ï–¥–∞';
                document.getElementById('temp-val').textContent = `${label}: ` + Math.floor(currentOrder.foodTemp) + '%';
                if (currentOrder.foodTemp <= 0) { failOrder("cold"); return; }
            }, 1000);
        }

        function stopOrderLoop() { if (orderInterval) clearInterval(orderInterval); orderInterval = null; document.getElementById('delivery-timer').textContent = ''; }

        function failOrder(reason) {
            stopOrderLoop();
            let msg = reason === "time" ? "‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!" : "üò§ –ö–ª–∏–µ–Ω—Ç —É—à–µ–ª!";
            showToast(`${msg} –®—Ç—Ä–∞—Ñ -5.00 PLN`, 'warn');
            state.balance -= 5.00; currentOrder = null; saveGame(); updateUI(); 
            // Map Cleanup
            clearMapVisuals();
            if(map) map.flyTo(WARSAW_CENTER, 13);
            startSearching();
        }

        function pedal() {
            if (!currentOrder) return;
            if (!currentOrder.accepted) { acceptOrder(); return; }
            
            let fatigue = Math.max(0.3, state.needs.energy / 100);
            
            if(state.taxi.active) {
                 if(state.needs.energy <= -20) { showToast('‚õΩ –ë–ï–ù–ó–ò–ù –ö–û–ù–ß–ò–õ–°–Ø!', 'warn'); openQuickInv(true); return; }
                 state.needs.energy -= 0.5; state.needs.mood -= 0.02; state.items.bike -= 0.2; state.items.gear -= 0.1; currentOrder.progress += 4; 
            } else {
                if (state.needs.energy <= -50 || state.needs.water <= -50) { showToast('–¢–´ –ü–†–ò –°–ú–ï–†–¢–ò! –û–¢–ö–†–û–ô –†–Æ–ö–ó–ê–ö!', 'warn'); openQuickInv(true); return; }
                if (!state.energyBoostActive) { state.needs.energy -= gameConfig.energyDrain; }
                state.needs.water -= gameConfig.waterDrain; state.needs.mood -= gameConfig.moodDrain;
                state.items.bike -= 0.1; state.items.phone -= 0.05;
                currentOrder.progress += (5 * fatigue);
            }

            updateTrack(currentOrder.progress);
            
            // UPDATE MAP MOVEMENT
            if(mapVisuals.courierMarker) updateCourierPosition(currentOrder.progress);

            if (Math.random() < gameConfig.trafficChance && currentOrder.stage === 2) triggerRandomEvent();
            if (currentOrder.progress >= 100) nextStage();
            saveGame(); updateUI();
        }

        function giveBribe() {
            if(state.balance < 20) { showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ –≤–∑—è—Ç–∫—É (20 PLN)', 'warn'); return; }
            state.balance -= 20;
            const btn = document.getElementById('pedal-btn');
            const bribeBtn = document.getElementById('bribe-btn');
            btn.disabled = false; btn.classList.remove('blocked');
            btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
            bribeBtn.style.display = 'none';
            showToast('üëÆ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ (-20 PLN)', 'success');
            saveGame(); updateUI();
        }

        function triggerRandomEvent() {
            const btn = document.getElementById('pedal-btn'); const bribeBtn = document.getElementById('bribe-btn');
            const events = [{ text: "üöß –ü–†–û–ë–ö–ê!", time: gameConfig.trafficDuration }, { text: "üëÆ –ü–û–õ–ò–¶–ò–Ø", time: 7000 }, { text: "üöï –û–ë–™–ï–ó–î", time: 4000 }];
            const ev = events[Math.floor(Math.random()*events.length)];
            btn.disabled = true; btn.classList.add('blocked'); btn.textContent = ev.text; 
            bribeBtn.style.display = 'block';
            showToast('–ó–∞–¥–µ—Ä–∂–∫–∞! –ñ–¥–∏ –∏–ª–∏ –ø–ª–∞—Ç–∏!', 'warn');
            setTimeout(() => { 
                if (currentOrder && btn.disabled) { 
                    btn.disabled = false; btn.classList.remove('blocked'); 
                    btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)'; 
                    bribeBtn.style.display = 'none';
                } 
            }, ev.time);
        }

        function acceptOrder() {
            currentOrder.accepted = true; clearTimeout(acceptTimeout);
            document.getElementById('accept-timer').style.display = 'none';
            document.getElementById('pedal-btn').textContent = state.taxi.active ? '–ü–û–î–ê–ß–ê –ú–ê–®–ò–ù–´...' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
            document.getElementById('order-offer').style.display = 'none'; 
            startOrderLoop(); 
        }

        function missOrder() {
            state.isSearching = true; currentOrder = null; state.balance -= 1.0;
            showToast('–ó–∞–∫–∞–∑ —É–ø—É—â–µ–Ω! –®—Ç—Ä–∞—Ñ -1.0 PLN', 'warn'); saveGame(); updateUI(); 
            clearMapVisuals();
            startSearching();
        }

        function nextStage() {
            currentOrder.stage++; currentOrder.progress = 0; updateTrack(0);
            if (currentOrder.stage === 1) { 
                const btn = document.getElementById('pedal-btn'); btn.disabled = true; 
                if(state.taxi.active) {
                    btn.textContent = '–ö–õ–ò–ï–ù–¢ –°–ê–î–ò–¢–°–Ø...'; document.getElementById('status-label').textContent = '–ü–æ—Å–∞–¥–∫–∞...';
                    const name = currentOrder.clientName; const msg = currentOrder.clientMsg; showToast(`üí¨ ${name}: "${msg}"`, 'info');
                } else {
                    btn.textContent = '–ñ–î–ï–ú –ó–ê–ö–ê–ó...'; document.getElementById('status-label').textContent = '–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç...';
                }
                setTimeout(() => {
                    btn.disabled = false; btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
                    document.getElementById('status-label').textContent = '–í –ø—É—Ç–∏';
                    currentOrder.stage = 2;
                }, 2000);
            } else if (currentOrder.stage === 3) { completeOrder(); }
        }

        function completeOrder() {
            stopOrderLoop();
            let pay = currentOrder.offerPrice; 
            const totalRepairs = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflationMult = 1 + (totalRepairs * gameConfig.inflationRate);

            let tip = 0;
            let minTemp = gameConfig.tipMinTemp || 60; let minMood = gameConfig.tipMinMood || 80; let chance = gameConfig.tipChance || 0.5;
            if(currentOrder.bonusHappy) { chance = 1.0; minMood = -100; showToast('üç´ –®–æ–∫–æ–ª–∞–¥–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞!', 'success'); }
            let tipMult = state.taxi.active ? 2.5 : 1.0;

            if (currentOrder.foodTemp > minTemp) { if (Math.random() <= chance) tip += ((2 + Math.random() * 3) * inflationMult) * tipMult; }
            if (state.needs.mood > minMood && currentOrder.foodTemp > 40) { if (Math.random() <= 0.3) tip += (3 * inflationMult) * tipMult; }
            let totalEarn = pay + tip;

            if (tip > 0) { let msg = (state.needs.mood > 80 && currentOrder.foodTemp > 70) ? `üî• –°—É–ø–µ—Ä! +${tip.toFixed(2)} —á–∞–µ–≤—ã—Ö!` : `üëç –î–æ–≤–æ–ª–µ–Ω! +${tip.toFixed(2)} —á–∞–µ–≤—ã—Ö`; showToast(msg, 'success'); } 
            else if (currentOrder.foodTemp < 50) { showToast('–ö–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ–≤–æ–ª–µ–Ω... –ë–µ–∑ —á–∞–µ–≤—ã—Ö.', 'warn'); }

            if(!state.taxi.active) { state.items.bag -= 1.5; state.items.gear -= 0.8; } else { state.items.bike -= 1.0; state.items.bag -= 2.0; }
            
            if (state.debtOverdue && state.debt > 0) {
                const rate = getGarnishmentRate(); let penalty = totalEarn * rate; 
                if (penalty > state.debt) penalty = state.debt;
                state.debt -= penalty; totalEarn -= penalty; 
                showToast(`–î–æ–ª–≥ (-${(rate*100).toFixed(0)}%): -${penalty.toFixed(2)} PLN`, 'warn');
            }
            
            state.balance += totalEarn; state.career.totalOrders++;
            updateMenuState(); 
            state.history.push({ rest: currentOrder.rest.name, pay: pay, tip: tip, total: pay + tip });
            sendLog(`–ó–∞–≤–µ—Ä—à–∏–ª –∑–∞–∫–∞–∑: +${(pay+tip).toFixed(2)} PLN`, 'ORDER');
            setTimeout(() => { showToast(`+${(pay+tip).toFixed(2)} PLN`, 'success'); }, 500);

            // MAP CLEANUP
            clearMapVisuals();
            if(map) map.flyTo(WARSAW_CENTER, 13);

            if (state.scheduledOffline) { goOffline(); } else { startSearching(); }
            saveGame(); syncToCloud(true); updateUI();
        }

        function startSearching() {
            if (state.scheduledOffline) { goOffline(); return; }
            if (!state.isOnline) return;

            stopOrderLoop(); state.isSearching = true;
            document.getElementById('active-order-view').style.display = 'flex';
            document.getElementById('rest-name').textContent = '–ü–æ–∏—Å–∫...';
            document.getElementById('rest-icon').textContent = 'üîç';
            document.getElementById('status-label').textContent = '–ò—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞...';
            document.getElementById('order-dest').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            document.getElementById('order-offer').textContent = '-- PLN'; 
            document.getElementById('accept-timer').style.display = 'none';
            document.getElementById('delivery-timer').textContent = '';
            document.getElementById('bribe-btn').style.display = 'none';
            resetSlider('online');
            const box = document.getElementById('online-slider-box');
            const txt = document.getElementById('online-slider-text');
            box.classList.remove('scheduled'); txt.textContent = "–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê";
            document.getElementById('pedal-btn').disabled = true;
            document.getElementById('pedal-btn').textContent = '–ü–û–ò–°–ö...';
            updateTrack(0);
            
            // Fix Map Size
            if(map) map.invalidateSize();

            setTimeout(() => { 
                if (state.isOnline && state.isSearching && !state.scheduledOffline) createOrder(); 
            }, 2000);
            syncToCloud(); 
        }

        function createOrder() {
            if (!state.isOnline) return;
            state.isSearching = false;
            
            let r; if(state.taxi.active) { r = taxiDestinations[Math.floor(Math.random() * taxiDestinations.length)]; } else { r = restaurants[Math.floor(Math.random() * restaurants.length)]; }
            const dist = (0.8 + Math.random() * 5.7).toFixed(1);
            const totalRepairs = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflationMult = 1 + (totalRepairs * gameConfig.inflationRate);
            let rawPay = (gameConfig.basePickupPay || 4.0) + (dist * (gameConfig.perKmPay || 1.5));
            let finalOffer = rawPay * inflationMult;
            if(state.taxi.active) { finalOffer = finalOffer * 4.0; }
            finalOffer += (Math.random() * gameConfig.payVariance) - (gameConfig.payVariance / 2);
            if(finalOffer < 2) finalOffer = 2; 

            let time = gameConfig.deliveryTime || 60;
            currentOrder = { rest: r, progress: 0, stage: 0, foodTemp: 100, accepted: false, timeLeft: time, tempWarned: false, distance: dist, offerPrice: finalOffer, clientName: clientNames[Math.floor(Math.random() * clientNames.length)], clientMsg: clientGreetings[Math.floor(Math.random() * clientGreetings.length)], bonusHappy: false };

            document.getElementById('rest-name').textContent = state.taxi.active ? `–ó–∞–∫–∞–∑: ${r.name}` : `–ï–¥–µ–º –≤ ${r.name}`;
            document.getElementById('rest-icon').textContent = r.icon;
            document.getElementById('status-label').textContent = 'üî• –ü–†–ò–ú–ò –í–´–ó–û–í! üî•';
            document.getElementById('order-dest').textContent = state.taxi.active ? `–ü–æ–µ–∑–¥–∫–∞: ${dist} km` : `–ó–∞–±—Ä–∞—Ç—å: ${dist} km`;
            const offerEl = document.getElementById('order-offer');
            offerEl.style.display = 'block';
            offerEl.textContent = `üí∞ ${finalOffer.toFixed(2)} PLN`;

            document.getElementById('pedal-btn').textContent = state.taxi.active ? '–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í' : '–ü–†–ò–ù–Ø–¢–¨ –ó–ê–ö–ê–ó';
            document.getElementById('pedal-btn').disabled = false;
            const bar = document.getElementById('accept-timer');
            const fill = document.getElementById('accept-timer-fill');
            bar.style.display = 'block';
            fill.classList.remove('animate-timer');
            void fill.offsetWidth; fill.classList.add('animate-timer');
            acceptTimeout = setTimeout(missOrder, 15000); 
            resetSlider('online');
            const box = document.getElementById('online-slider-box');
            const txt = document.getElementById('online-slider-text');
            box.classList.add('scheduled'); txt.textContent = "–ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–¢–¨ –û–§–õ–ê–ô–ù";

            // RESET GPS
            mapVisuals.startCoords = null; mapVisuals.endCoords = null;
            setTimeout(drawRoute, 500);
        }

        function goOffline() {
            state.isOnline = false; state.isSearching = false; state.scheduledOffline = false;
            stopOrderLoop(); if (acceptTimeout) clearTimeout(acceptTimeout);
            document.getElementById('active-order-view').style.display = 'none';
            document.getElementById('offline-view').style.display = 'block';
            resetSlider('offline'); saveGame(); syncToCloud();
            sendLog('–£—à–µ–ª —Å –ª–∏–Ω–∏–∏ (–û—Ñ–ª–∞–π–Ω)', 'STATUS');
        }

        function initSliders() {
            setupSlider('offline', () => { 
                state.isOnline = true; 
                document.getElementById('offline-view').style.display = 'none'; 
                startSearching(); 
                sendLog(`–í—ã—à–µ–ª –Ω–∞ –ª–∏–Ω–∏—é (${state.taxi.active?'TAXI':'BIKE'})`, 'STATUS');
            });
            setupSlider('online', () => {
                if (state.isSearching) { goOffline(); }
                else {
                    state.scheduledOffline = true;
                    saveGame(); 
                    const box = document.getElementById('online-slider-box');
                    const txt = document.getElementById('online-slider-text');
                    box.classList.add('scheduled'); txt.textContent = "–û–§–õ–ê–ô–ù –ü–û–°–õ–ï –ó–ê–ö–ê–ó–ê";
                    resetSlider('online');
                }
            });
        }

        function setupSlider(prefix, callback) {
            const knob = document.getElementById(`${prefix}-slider-knob`);
            const box = document.getElementById(`${prefix}-slider-box`);
            const fill = document.getElementById(`${prefix}-slider-fill`);
            let isDragging = false, startX = 0;
            knob.addEventListener('mousedown', start); knob.addEventListener('touchstart', start);
            function start(e) { isDragging = true; startX = (e.type === 'mousedown') ? e.clientX : e.touches[0].clientX; document.addEventListener('mousemove', move); document.addEventListener('touchmove', move); document.addEventListener('mouseup', end); document.addEventListener('touchend', end); }
            function move(e) { if (!isDragging) return; const clientX = (e.type === 'mousemove') ? e.clientX : e.touches[0].clientX; let x = clientX - startX; let max = box.offsetWidth - knob.offsetWidth - 8; x = Math.max(0, Math.min(x, max)); knob.style.transform = `translateX(${x}px)`; fill.style.width = `${(x / max) * 100}%`; if (x >= max * 0.95) { isDragging = false; end(); callback(); } }
            function end() { isDragging = false; document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); knob.style.transform = 'translateX(0)'; fill.style.width = '0%'; }
        }

        function resetSlider(prefix) { document.getElementById(`${prefix}-slider-knob`).style.transform = 'translateX(0)'; document.getElementById(`${prefix}-slider-fill`).style.width = '0%'; }

        function toggleQuickInv() { const menu = document.getElementById('quick-inv'); menu.style.display === 'flex' ? menu.style.display = 'none' : openQuickInv(); }
        function openQuickInv(forced = false) {
            const menu = document.getElementById('quick-inv'); menu.innerHTML = '';
            let owned = [];
            for (let [k, c] of Object.entries(state.inventory)) { 
                if (c > 0) { const itemData = ITEMS_DB[k]; if(state.taxi.active) { owned.push({ k, c, data: itemData }); } else { if(k !== 'gas') owned.push({ k, c, data: itemData }); } } 
            }
            if (owned.length === 0) { menu.innerHTML = `<div style="padding:5px; color:#fff; text-align:center; font-size:12px">–ü—É—Å—Ç–æ!</div><div class="inv-item link-btn" onclick="openModal('shop')">–í –ú–ê–ì–ê–ó–ò–ù</div>`; }
            else { owned.forEach(item => { const div = document.createElement('div'); div.className = 'inv-item'; div.innerHTML = `<span><i class="fa-solid ${item.data.icon}"></i> ${item.data.name}</span><span class="inv-count">x${item.c}</span>`; div.onclick = () => useItem(item.k); menu.appendChild(div); }); }
            menu.style.display = 'flex'; menu.classList.add('open');
        }

        function useItem(key) {
            const item = ITEMS_DB[key]; if(state.inventory[key] <= 0) return;
            state.inventory[key]--;
            if (item.special === 'gift') {
                if (currentOrder && !currentOrder.bonusHappy) { currentOrder.bonusHappy = true; showToast('–®–æ–∫–æ–ª–∞–¥–∫–∞ –≤—Ä—É—á–µ–Ω–∞! –ö–ª–∏–µ–Ω—Ç —Å—á–∞—Å—Ç–ª–∏–≤!', 'success'); } 
                else if (!currentOrder) { state.needs.mood += item.effect.mood; showToast('–°—ä–µ–ª —à–æ–∫–æ–ª–∞–¥–∫—É —Å–∞–º. –í–∫—É—Å–Ω–æ!', 'success'); } 
                else { showToast('–ö–ª–∏–µ–Ω—Ç —É–∂–µ –¥–æ–≤–æ–ª–µ–Ω!', 'warn'); state.inventory[key]++; return; }
            } else { if (item.effect.energy) state.needs.energy += item.effect.energy; if (item.effect.water) state.needs.water += item.effect.water; if (item.effect.mood) state.needs.mood += item.effect.mood; }
            if (item.special === 'no_drain') { state.energyBoostActive = true; showToast('üöÄ –≠–ù–ï–†–ì–ï–¢–ò–ö: –£—Å—Ç–∞–ª–æ—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success'); setTimeout(() => { state.energyBoostActive = false; showToast('–î–µ–π—Å—Ç–≤–∏–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å', 'info'); }, 30000); }
            ['energy','water','mood'].forEach(k => { if(state.needs[k]>100) state.needs[k]=100; });
            toggleQuickInv(); saveGame(); updateUI();
        }

        function toggleMenu() { updateMenuState(); document.getElementById('side-menu-overlay').classList.toggle('open'); document.getElementById('side-menu').classList.toggle('open'); }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }
        function openModal(type) {
            toggleMenu(); const m = document.getElementById('full-modal'); const b = document.getElementById('modal-body'); m.classList.add('open');
            if (type === 'shop') { document.getElementById('modal-title').textContent = '–ú–∞–≥–∞–∑–∏–Ω'; renderShop(b); }
            else if (type === 'bank') { document.getElementById('modal-title').textContent = '–ë–∞–Ω–∫ (–ö—Ä–µ–¥–∏—Ç)'; renderBank(b); }
            else if (type === 'deflation') { document.getElementById('modal-title').textContent = '–ë–æ—Ä—å–±–∞ —Å –∏–Ω—Ñ–ª—è—Ü–∏–µ–π'; renderDeflation(b); }
            else if (type === 'taxi-shop') { document.getElementById('modal-title').textContent = '–ê–≤—Ç–æ—Å–∞–ª–æ–Ω'; renderTaxiShop(b); }
            else if (type === 'taxi-licenses') { document.getElementById('modal-title').textContent = '–õ–∏—Ü–µ–Ω–∑–∏–∏ –∏ –î–æ–∫—É–º–µ–Ω—Ç—ã'; renderTaxiLicenses(b); }
            else { document.getElementById('modal-title').textContent = '–ò—Å—Ç–æ—Ä–∏—è'; renderHistory(b); }
        }

        function updateMenuState() {
            const total = state.career.totalOrders;
            document.getElementById('career-count').textContent = total;
            const isUnlocked = state.taxi.unlocked || total >= TAXI_UNLOCK_REQ;
            const btns = document.querySelectorAll('.taxi-item');
            const msg = document.getElementById('taxi-lock-msg');
            const toggleBtn = document.getElementById('taxi-toggle-btn');
            
            if (isUnlocked) {
                btns.forEach(b => { b.classList.remove('locked'); b.onclick = null; if(b.id === 'taxi-showroom-btn') b.onclick = () => openModal('taxi-shop'); if(b.id === 'taxi-licenses-btn') b.onclick = () => openModal('taxi-licenses'); });
                msg.style.display = 'none';
                const hasCar = state.taxi.vehicle !== null; const hasLic = state.taxi.licenses.driver && state.taxi.licenses.insurance && state.taxi.licenses.taxi;
                if(hasCar && hasLic) { toggleBtn.style.display = 'flex'; } else { toggleBtn.style.display = 'none'; }
            } else {
                btns.forEach(b => { b.classList.add('locked'); b.onclick = showLockedMsg; });
                msg.style.display = 'block'; toggleBtn.style.display = 'none';
            }
        }

        function showLockedMsg() { showToast(`–ù—É–∂–Ω–æ ${TAXI_UNLOCK_REQ} –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤!`, 'warn'); }

        function toggleTaxiMode() {
            if (!state.taxi.vehicle || !state.taxi.licenses.driver || !state.taxi.licenses.insurance) { showToast('–ö—É–ø–∏—Ç–µ –º–∞—à–∏–Ω—É –∏ –ª–∏—Ü–µ–Ω–∑–∏–∏!', 'warn'); return; }
            if(state.isOnline) { showToast('–°–Ω–∞—á–∞–ª–∞ —É–π–¥–∏ –≤ –æ—Ñ–ª–∞–π–Ω!', 'warn'); return; }
            state.taxi.active = !state.taxi.active; saveGame(); updateUI(); updateMenuState();
            let msg = state.taxi.active ? 'üöï –†–ï–ñ–ò–ú –¢–ê–ö–°–ò –í–ö–õ–Æ–ß–ï–ù' : 'üö≤ –†–ï–ñ–ò–ú –ö–£–†–¨–ï–†–ê –í–ö–õ–Æ–ß–ï–ù'; showToast(msg, 'success');
        }

        // TAXI RENDER LOGIC
        function renderTaxiShop(c) {
            c.innerHTML = '';
            // License
            const hasLicense = state.taxi.licenses.taxi;
            const licenseDiv = document.createElement('div');
            licenseDiv.style.cssText = "padding:10px; background:#fff; border-radius:8px; margin-bottom:15px; border:1px solid #ddd; text-align:center";
            if(hasLicense) { licenseDiv.innerHTML = `<div style="color:#00c853; font-weight:bold">‚úÖ –õ–ò–¶–ï–ù–ó–ò–Ø –ö–£–ü–õ–ï–ù–ê</div><div style="font-size:10px; color:#666">–î–æ—Å—Ç—É–ø –∫ —Ä–∞–±–æ—Ç–µ –æ—Ç–∫—Ä—ã—Ç</div>`; } 
            else { const price = 5000; const canBuy = state.balance >= price; licenseDiv.innerHTML = `<div style="font-weight:bold; margin-bottom:5px">üöï –õ–∏—Ü–µ–Ω–∑–∏—è –¢–∞–∫—Å–∏—Å—Ç–∞</div><div style="font-size:11px; color:#666; margin-bottom:10px">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–≤–æ–∑–∫—É –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.</div><button onclick="window.buyLicense('taxi',${price})" style="width:100%; padding:10px; background:${canBuy?'#ff9800':'#ccc'}; color:white; border:none; border-radius:6px; font-weight:bold; cursor:${canBuy?'pointer':'not-allowed'}">–ö–£–ü–ò–¢–¨ (${price}‚ÇΩ)</button>`; }
            c.appendChild(licenseDiv);

            // Craft
            const div = document.createElement('div');
            div.style.cssText = "padding:12px; background:rgba(0,0,0,0.05); border-radius:8px; border:1px solid #d500f9; text-align:center";
            const hasParts = (state.inventory['part_chip']>0 && state.inventory['part_engine']>0 && state.inventory['part_alloy']>0);
            const hasCar = (state.taxi.vehicle === 'cyber_taxi');
            const CYBER_CAR = { id: 'cyber_taxi', name: 'Cyber Taxi 2077' };
            window.craftCyber = function() {
                if(state.inventory['part_chip'] > 0 && state.inventory['part_engine'] > 0 && state.inventory['part_alloy'] > 0) {
                    state.inventory['part_chip']--; state.inventory['part_engine']--; state.inventory['part_alloy']--;
                    state.taxi.vehicle = CYBER_CAR.id; saveGame(); syncToCloud(true); showToast('ü§ñ –ú–ê–®–ò–ù–ê –°–û–ë–†–ê–ù–ê!', 'success'); renderTaxiShop(c); updateMenuState();
                } else { showToast('‚ùå –ù–∞–π–¥–∏ –¥–µ—Ç–∞–ª–∏ –≤ –∑–∞–∫–∞–∑–∞—Ö!', 'error'); }
            };

            div.innerHTML = `<div style="color:#d500f9; font-weight:bold; font-size:14px; margin-bottom:5px">üîß –ü–†–û–ï–ö–¢ CYBER-X</div><div style="font-size:10px; color:#666; margin-bottom:10px; font-style:italic">–í –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–µ –Ω–µ—Ç –º–∞—à–∏–Ω –≤ –Ω–∞–ª–∏—á–∏–∏.<br><span style="color:#000; font-weight:bold">–°–æ–±–µ—Ä–∏ —Å–≤–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏–∑ –¥–µ—Ç–∞–ª–µ–π,<br>–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –¥–æ—Å—Ç–∞–≤–∫–∞—Ö.</span></div><div style="font-size:11px; margin-bottom:12px; display:flex; gap:8px; justify-content:center; background:#fff; padding:5px; border-radius:4px"><span style="color:${state.inventory['part_chip']>0?'#00c853':'#f44336'}">üîã –ß–∏–ø: ${state.inventory['part_chip']||0}/1</span><span style="color:${state.inventory['part_engine']>0?'#00c853':'#f44336'}">‚öôÔ∏è –î–≤–∏–≥: ${state.inventory['part_engine']||0}/1</span><span style="color:${state.inventory['part_alloy']>0?'#00c853':'#f44336'}">üî© –°–ø–ª–∞–≤: ${state.inventory['part_alloy']||0}/1</span></div>${hasCar ? '<div style="background:#00c853; color:white; padding:8px; border-radius:4px; font-weight:bold">‚úÖ –ú–ê–®–ò–ù–ê –í –ì–ê–†–ê–ñ–ï</div>' : `<button onclick="window.craftCyber()" style="width:100%; padding:10px; background:${hasParts?'#d500f9':'#424242'}; color:white; border:none; border-radius:6px; font-weight:bold; cursor:${hasParts?'pointer':'not-allowed'}">${hasParts ? '–°–û–ë–†–ê–¢–¨ –ú–ê–®–ò–ù–£' : 'üîí –ù–£–ñ–ù–´ –î–ï–¢–ê–õ–ò'}</button>`}`;
            c.appendChild(div);
        }

        window.buyLicense = function(id, price) {
            if (state.balance >= price) { state.balance -= price; state.taxi.licenses[id] = true; showToast('üìÑ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω!', 'success'); sendLog(`–ö—É–ø–∏–ª –ª–∏—Ü–µ–Ω–∑–∏—é: ${id}`, 'BUY'); saveGame(); syncToCloud(true); updateUI(); renderTaxiLicenses(document.getElementById('modal-body')); updateMenuState(); } 
            else { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'warn'); }
        }

        function renderTaxiLicenses(c) {
            const l = state.taxi.licenses;
            const licenses = [ { id: 'driver', name: '–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ (B)', price: 2500 }, { id: 'insurance', name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ OC/AC', price: 1200 }, { id: 'taxi', name: '–õ–∏—Ü–µ–Ω–∑–∏—è –¢–∞–∫—Å–∏', price: 5000 } ];
            let html = '';
            licenses.forEach(lic => {
                const hasIt = l[lic.id]; const btnClass = hasIt ? 'shop-btn bought' : 'shop-btn buy'; const btnText = hasIt ? '–ï–°–¢–¨' : `${lic.price.toLocaleString()} PLN`; const action = hasIt ? '' : `onclick="window.buyLicense('${lic.id}', ${lic.price})"`;
                html += `<div class="shop-card"><div><div style="font-weight:bold">${lic.name}</div></div><button class="${btnClass}" ${action} ${hasIt ? 'disabled' : ''}>${btnText}</button></div>`;
            });
            c.innerHTML = html;
        }

        function renderShop(c) {
            let html = ''; const levelSum = Object.values(state.repairs).reduce((a,b)=>a+b,0); const inflation = 1 + (levelSum * gameConfig.inflationRate); 
            html += '<div class="shop-section"><h3>üéí –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</h3>';
            ['chocolate', 'gas', 'water', 'bar', 'energy_drink', 'coffee'].forEach(k => {
                if(state.taxi.active) { if(k !== 'gas' && k !== 'coffee' && k !== 'water' && k !== 'bar' && k !== 'energy_drink' && k !== 'chocolate') return; } else { if(k === 'gas') return; }
                const i = ITEMS_DB[k]; const price = i.cost * inflation; const owned = state.inventory[k] || 0;
                html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} <span style="font-size:11px; color:#009de0; font-weight:normal">(–í –Ω–∞–ª–∏—á–∏–∏: ${owned})</span></div><div class="shop-desc">${i.desc}</div></div><button class="shop-btn buy" onclick="buyItem('${k}', ${price}, this)">${price.toFixed(1)}</button></div>`;
            });
            html += '</div><div class="shop-section"><h3>üõ† –°–µ—Ä–≤–∏—Å (–†–µ–º–æ–Ω—Ç)</h3>';
            
            if(state.taxi.active) {
                const carItems = [ { key: 'bike', db: ITEMS_DB.car_main }, { key: 'bag', db: ITEMS_DB.car_interior }, { key: 'gear', db: ITEMS_DB.car_tires } ];
                carItems.forEach(obj => {
                    const i = obj.db; const base = i.baseCost + ((state.repairs[obj.key]||0)*2.0); const price = base * inflation; const currentHealth = Math.floor(state.items[obj.key]);
                    const btnText = `–†–µ–º–æ–Ω—Ç (+100%) -${price.toFixed(1)}`;
                    html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} (Lvl ${state.repairs[obj.key]||0})</div><div class="shop-desc" style="color:${currentHealth<0?'red':'black'}">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentHealth}%</div></div><button class="shop-btn" onclick="buyRepair('${obj.key}', ${price}, this)">${btnText}</button></div>`;
                });
            } else {
                ['bike', 'bag', 'phone', 'gear'].forEach(k => {
                    const i = ITEMS_DB[k]; const base = i.baseCost + ((state.repairs[k]||0)*0.5); const price = base * inflation; const currentHealth = Math.floor(state.items[k]);
                    const btnText = `–†–µ–º–æ–Ω—Ç (+100%) -${price.toFixed(1)}`;
                    html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} (Lvl ${state.repairs[k]||0})</div><div class="shop-desc" style="color:${currentHealth<0?'red':'black'}">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentHealth}%</div></div><button class="shop-btn" onclick="buyRepair('${k}', ${price}, this)">${btnText}</button></div>`;
                });
            }
            html += '</div>'; c.innerHTML = html;
        }

        function renderDeflation(c) {
            const levelSum = Object.values(state.repairs).reduce((a,b)=>a+b,0); const inflation = 1 + (levelSum * gameConfig.inflationRate);
            const cost1 = 2700 * inflation; const cost2 = 5000 * inflation;
            c.innerHTML = `<div style="text-align:center; padding:20px 0;"><i class="fa-solid fa-scale-unbalanced-flip" style="font-size:40px; color:#90a4ae"></i><h2>–ò–Ω—Ñ–ª—è—Ü–∏—è: ${((inflation-1)*100).toFixed(0)}%</h2><p style="color:#666; font-size:14px">–°–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ñ–ª—è—Ü–∏–∏ —É–º–µ–Ω—å—à–∞–µ—Ç —Ü–µ–Ω—ã –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö, –Ω–æ —Å—Ç–æ–∏—Ç –±–æ–ª—å—à–∏—Ö –¥–µ–Ω–µ–≥.</p></div><div class="shop-card"><div><div style="font-weight:bold">–û—Ç–∫–∞—Ç (-1 —É—Ä–æ–≤–µ–Ω—å)</div><div class="shop-desc">–°–Ω–∏–∂–∞–µ—Ç —Ü–µ–Ω—ã –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥</div></div><button class="shop-btn govt-btn" onclick="buyDeflation(1, ${cost1})">-${cost1.toFixed(0)}</button></div><div class="shop-card"><div><div style="font-weight:bold">–°–∏–ª—å–Ω—ã–π –æ—Ç–∫–∞—Ç (-2 —É—Ä.)</div><div class="shop-desc">–°–µ—Ä—å–µ–∑–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω</div></div><button class="shop-btn govt-btn" onclick="buyDeflation(2, ${cost2})">-${cost2.toFixed(0)}</button></div>`;
        }

        function buyItem(k, cost, btn) {
            if(state.balance >= cost) { 
                state.balance-=cost; state.inventory[k]=(state.inventory[k]||0)+1; 
                const originalText = btn.textContent; btn.textContent = '–ö–£–ü–õ–ï–ù–û!'; btn.className = 'shop-btn bought'; 
                sendLog(`–ö—É–ø–∏–ª: ${ITEMS_DB[k].name} –∑–∞ ${cost.toFixed(2)}`, 'BUY');
                setTimeout(() => { btn.textContent = originalText; btn.className = 'shop-btn buy'; renderShop(document.getElementById('modal-body')); }, 600); 
                saveGame(); syncToCloud(true); updateUI(); 
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn');
        }

        function buyRepair(k, cost, btn) {
            if(state.balance >= cost) { 
                state.balance-=cost; state.items[k] += 100; if(state.items[k] > 100) state.items[k] = 100; state.repairs[k]=(state.repairs[k]||0)+1; 
                btn.textContent = '–ì–û–¢–û–í–û!'; btn.className = 'shop-btn bought'; 
                let itemName = ITEMS_DB[k] ? ITEMS_DB[k].name : 'Repair';
                if(state.taxi.active) { if(k==='bike') itemName = ITEMS_DB.car_main.name; if(k==='bag') itemName = ITEMS_DB.car_interior.name; if(k==='gear') itemName = ITEMS_DB.car_tires.name; }
                sendLog(`–ü–æ—á–∏–Ω–∏–ª: ${itemName}`, 'REPAIR');
                setTimeout(() => { renderShop(document.getElementById('modal-body')); }, 600); saveGame(); syncToCloud(true); updateUI(); 
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn');
        }

        function buyDeflation(levels, cost) {
            if (state.balance < cost) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'warn'); return; }
            let reduced = 0;
            for (let i = 0; i < levels; i++) { const key = Object.keys(state.repairs).find(k => state.repairs[k] > 0); if (key) { state.repairs[key]--; reduced++; } }
            if (reduced > 0) { state.balance -= cost; showToast(`–ò–Ω—Ñ–ª—è—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ ${reduced} —É—Ä.!`, 'success'); saveGame(); syncToCloud(true); updateUI(); renderDeflation(document.getElementById('modal-body')); } else { showToast('–ò–Ω—Ñ–ª—è—Ü–∏—è —É–∂–µ –Ω–∞ –º–∏–Ω–∏–º—É–º–µ!', 'warn'); }
        }

        function renderBank(c) {
            let timeLeftStr = "00:00";
            if(state.debt > 0 && !state.debtOverdue) {
                let diff = Math.max(0, state.debtTimer - Date.now()); let m = Math.floor(diff / 60000); let s = Math.floor((diff % 60000) / 1000); timeLeftStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
            if(document.getElementById('bank-ui-root')) { updateBankTimer(); return; }

            let interestRate = 0; let streak = state.loanStreak || 0;
            if (streak === 0) interestRate = 0; else if (streak === 1) interestRate = 10; else if (streak === 2) interestRate = 20; else interestRate = 50;  
            const limit = 1000 + (state.career.totalOrders * 50);

            const hasFood = (state.inventory.bar > 0 || state.inventory.water > 0 || state.inventory.energy_drink > 0);
            const isCrisis = state.balance < 5 && !hasFood;
            let sosHtml = '';
            if (isCrisis) { sosHtml = `<div style="margin-bottom:15px; padding:10px; background:#37474f; border:1px border:#cfd8dc; border-radius:10px; text-align:center"><div style="color:#ff9100; font-weight:bold; font-size:12px; margin-bottom:5px">üÜò –ü–ê–ö–ï–¢ –í–´–ñ–ò–í–ê–ù–ò–Ø</div><div style="font-size:11px; color:#b0bec5">–í–æ–¥–∞ + –°–Ω–∏–∫–µ—Ä—Å. –¶–µ–Ω–∞ x2 –≤ –¥–æ–ª–≥.</div><button class="bank-btn" style="background:#ff3d00; color:white; margin-top:5px; padding:8px" onclick="takeSOS()">–í–ó–Ø–¢–¨ (–î–û–õ–ì x2)</button></div>`; }
            const garnishmentPercent = (getGarnishmentRate() * 100).toFixed(0);

            c.innerHTML = `<div id="bank-ui-root"><div class="debt-alert-box" id="bank-alert" style="display:${state.debtOverdue?'block':'none'}">‚ö†Ô∏è <strong>–ü–†–û–°–†–û–ß–ï–ù–û!</strong><br>–£–¥–µ—Ä–∂–∏–≤–∞–µ–º ${garnishmentPercent}% —Å –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞.</div><div style="text-align:center; margin-bottom:20px"><div style="font-size:14px; color:#666">–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥</div><div style="font-size:32px; font-weight:800; color:${state.debt>0?'var(--accent-red)':'#333'}" id="bank-debt-display">${state.debt.toFixed(2)} PLN</div><div style="font-size:12px; color:${state.debtOverdue?'red':'#00c853'}; font-weight:bold; margin-top:5px" id="bank-timer-display">${state.debt > 0 ? (state.debtOverdue ? '–í–ó–´–°–ö–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û' : '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ' + timeLeftStr) : '–ù–µ—Ç –¥–æ–ª–≥–æ–≤'}</div></div><div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:12px">–í–∞—à –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç: <span style="color:white; font-weight:bold">${limit.toLocaleString()} PLN</span></div>${sosHtml}<div style="background:#f5f5f5; padding:10px; border-radius:10px; margin-bottom:10px"><div style="font-size:11px; color:#666; margin-bottom:5px">–£–°–õ–û–í–ò–Ø –ö–†–ï–î–ò–¢–ê:</div><div style="display:flex; justify-content:space-between; font-size:13px"><span>–ü–æ–ø—ã—Ç–∫–∞ ‚Ññ${streak + 1}</span><span style="font-weight:bold; color:${interestRate>0?'var(--accent-red)':'var(--accent-green)'}">–ö–æ–º–∏—Å—Å–∏—è: +${interestRate}%</span></div></div><input type="number" id="loan-amount" class="bank-input" placeholder="–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞..."><div class="bank-actions"><button class="bank-btn btn-loan" onclick="takeLoan()">–í–ó–Ø–¢–¨</button>${state.debt > 0 ? '<button class="bank-btn btn-repay" onclick="repayLoan()">–í–ï–†–ù–£–¢–¨</button>' : ''}</div></div>`;
        }

        function updateBankTimer() {
            const timerDisplay = document.getElementById('bank-timer-display'); const debtDisplay = document.getElementById('bank-debt-display');
            let timeStr = "00:00";
            if(state.debt > 0 && !state.debtOverdue) { let diff = Math.max(0, state.debtTimer - Date.now()); let m = Math.floor(diff / 60000); let s = Math.floor((diff % 60000) / 1000); timeStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
            if(timerDisplay) { if(state.debt > 0) { timerDisplay.textContent = state.debtOverdue ? '–í–ó–´–°–ö–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û' : '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ' + timeStr; timerDisplay.style.color = state.debtOverdue ? 'red' : '#00c853'; document.getElementById('bank-alert').style.display = state.debtOverdue ? 'block' : 'none'; } else { timerDisplay.textContent = '–ù–µ—Ç –¥–æ–ª–≥–æ–≤'; document.getElementById('bank-alert').style.display = 'none'; } }
            if(debtDisplay) debtDisplay.textContent = state.debt.toFixed(2) + ' PLN';
        }

        function takeSOS() {
            const costWater = (ITEMS_DB.water.cost || 2.0); const costBar = (ITEMS_DB.bar.cost || 4.5); const totalVal = costWater + costBar; const debtIncrease = totalVal * 2;
            state.inventory.water = (state.inventory.water || 0) + 1; state.inventory.bar = (state.inventory.bar || 0) + 1;
            state.debt += debtIncrease;
            if (state.debtTimer === 0 || state.debt <= debtIncrease) { state.debtTimer = Date.now() + (5 * 60 * 1000); state.debtOverdue = false; }
            showToast(`üÜò SOS –ø–æ–ª—É—á–µ–Ω! –î–æ–ª–≥ +${debtIncrease.toFixed(2)} PLN`, 'warn'); sendLog(`–í–∑—è–ª SOS –ø–∞–∫–µ—Ç. –î–æ–ª–≥ +${debtIncrease}`, 'LOAN');
            document.getElementById('modal-body').innerHTML = ''; renderBank(document.getElementById('modal-body')); saveGame(); syncToCloud(true); updateUI();
        }

        function takeLoan() {
            const input = document.getElementById('loan-amount'); const amt = parseFloat(input.value); if (!amt || amt <= 0) return;
            const limit = 1000 + (state.career.totalOrders * 50);
            if (state.debt > 0.1) { showToast('‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–¥–∏—Ç!', 'warn'); return; }
            if (amt > limit) { showToast(`‚õî –õ–∏–º–∏—Ç –¥–æ–≤–µ—Ä–∏—è: ${limit} PLN. –†–∞–±–æ—Ç–∞–π—Ç–µ –±–æ–ª—å—à–µ!`, 'warn'); return; }
            let streak = state.loanStreak || 0; let interest = 0;
            if (streak === 0) interest = 0; else if (streak === 1) interest = 0.10; else if (streak === 2) interest = 0.20; else interest = 0.50;                 
            const debtIncrease = amt * (1 + interest);
            state.balance += amt; state.debt += debtIncrease; state.loanStreak = streak + 1;
            if (state.debt <= debtIncrease) { state.debtTimer = Date.now() + (5 * 60 * 1000); state.debtOverdue = false; }
            let msg = interest === 0 ? `–í–∑—è—Ç –∫—Ä–µ–¥–∏—Ç: ${amt} PLN (0%)` : `–í–∑—è—Ç–æ: ${amt}. –î–æ–ª–≥: +${debtIncrease.toFixed(2)} (+${interest*100}%)`;
            showToast(msg, interest > 0 ? 'warn' : 'success'); input.value = ''; 
            sendLog(`–í–∑—è–ª –∫—Ä–µ–¥–∏—Ç: ${amt} (Streak: ${state.loanStreak})`, 'LOAN');
            document.getElementById('modal-body').innerHTML = ''; renderBank(document.getElementById('modal-body')); saveGame(); syncToCloud(true); updateUI();
        }

        function repayLoan() {
            const input = document.getElementById('loan-amount'); let amt = parseFloat(input.value); if (!amt || amt <= 0) return;
            if (amt > state.balance) amt = state.balance; if (amt > state.debt) amt = state.debt;
            state.balance -= amt; state.debt -= amt; 
            if (state.debt <= 0.01) { state.debt = 0; state.debtOverdue = false; state.debtTimer = 0; state.loanStreak = 0; showToast(`–î–æ–ª–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω! –ü—Ä–æ—Ü–µ–Ω—Ç —Å–±—Ä–æ—à–µ–Ω.`, 'success'); } 
            else { showToast(`–ü–æ–≥–∞—à–µ–Ω–æ: ${amt} PLN. –û—Å—Ç–∞—Ç–æ–∫: ${state.debt.toFixed(2)}`, 'success'); }
            input.value = ''; sendLog(`–í–µ—Ä–Ω—É–ª –¥–æ–ª–≥: ${amt} PLN`, 'LOAN');
            document.getElementById('modal-body').innerHTML = ''; renderBank(document.getElementById('modal-body')); saveGame(); syncToCloud(true); updateUI();
        }

        function renderHistory(c) { 
            c.innerHTML = state.history.slice().reverse().map(h => {
                let amount = 0; let tipStr = ""; if (h.total) { amount = h.total; if (h.tip > 0) { tipStr = `<span style="color:#00e676; font-size:10px; margin-left:5px">(+${h.tip.toFixed(2)} napiwek)</span>`; } } else { amount = parseFloat(h.earn); }
                return `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center"><div><b>${h.rest}</b>${tipStr}</div><span style="font-weight:bold">+${amount.toFixed(2)}</span></div>`;
            }).join(''); 
        }

        function updateTrack(p) { document.getElementById('track-fill').style.width=p+'%'; document.getElementById('track-icon').style.left=p+'%'; }
        
        function resetGame(penalty = 0) {
            let msg = '–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?'; if (penalty > 0) msg += ` –° –≤–∞—Å –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ ${penalty} PLN –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã.`;
            if(confirm(msg)) {
                localStorage.removeItem(SAVE_KEY);
                const newState = {
                    id: state.id, name: null, balance: 0, debt: (7000 + penalty), debtTimer: Date.now(), debtOverdue: true, loanStreak: 0, 
                    isOnline: false, isSearching: false, scheduledOffline: false,
                    items: { bike: 100, bag: 100, phone: 100, gear: 100 }, needs: { energy: 100, water: 100, mood: 100 },
                    inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 },
                    repairs: { bike: 0, bag: 0, phone: 0, gear: 0 }, history: []
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(newState)); location.reload();
            }
        }

    init();
  </script>
<script src="patches/design_update.js"></script>

</body> </html>


  
<script>
(function() {
    console.log(">>> PATCH V47: FINAL FIX (BUTTON + PAYMENTS)");

    // 1. –¢–í–û–ò –°–°–´–õ–ö–ò (–£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–´)
    const INVOICE_LINKS = {
        'tier1': 'https://t.me/$p_u59Iwq6VOyBQAA7UM9ZdWS6KQ',
        'tier2': 'https://t.me/$qF0lgowq6VOzBQAABRdV00am4SY',
        'tier3': 'https://t.me/$mv2d14wq6VO0BQAAC1T_sfj72Pk',
        'money_s': 'https://t.me/$HpNBJ4wq6VO1BQAAOJbFl1Ro518',
        'money_m': 'https://t.me/$4In-aIwq6VO2BQAAIVs94A4a82w',
        'money_l': 'https://t.me/$4YB9VYwq6VO3BQAAMJk1Dd_yzBk',
    };

    // 2. –ù–ê–°–¢–†–û–ô–ö–ò
    const USE_REAL_PAYMENTS = true;
    
    // –ö–û–ù–§–ò–ì –¢–û–í–ê–†–û–í
    window.PREMIUM_CFG = {
        tier1: { id: 'tier1', name: '‚òï –ü–µ—Ä–µ—Ä—ã–≤', time: 5,  limit: 20, cost: 10 },
        tier2: { id: 'tier2', name: 'üöÄ –°–º–µ–Ω–∞',   time: 10, limit: 45, cost: 25 },
        tier3: { id: 'tier3', name: 'üëë –≠–ª–∏—Ç–∞',   time: 25, limit: 100, cost: 50 } 
    };
    window.CASH_PACKS = [
        { id: 'money_s', cost: 10, val: 500,   name: 'üÜò –ó–∞–Ω–∞—á–∫–∞' },
        { id: 'money_m', cost: 25, val: 2500,  name: 'üíº –ó–∞—Ä–ø–ª–∞—Ç–∞' },
        { id: 'money_l', cost: 75, val: 15000, name: 'üíé –ò–Ω–≤–µ—Å—Ç–æ—Ä' }
    ];

    // 3. –§–£–ù–ö–¶–ò–Ø –û–ü–õ–ê–¢–´
    window.processPayment = function(itemId, cost, onSuccess) {
        const tg = window.Telegram.WebApp;
        if (USE_REAL_PAYMENTS) {
            const url = INVOICE_LINKS[itemId];
            if (!url) { alert(`–û–®–ò–ë–ö–ê: –ù–µ—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è ${itemId}`); return; }
            tg.openInvoice(url, (status) => {
                if (status === 'paid') onSuccess();
                else if (status === 'failed') tg.showAlert('–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞');
            });
        } else {
            // –¢–µ—Å—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            if(confirm(`TEST PAY ${cost}?`)) onSuccess();
        }
    };

    // 4. –ü–û–ö–£–ü–ö–ê –ü–†–ï–ú–ò–£–ú–ê
    window.buyPrem = function(id, cost, time, limit) {
        window.processPayment(id, cost, () => {
            const now = Date.now();
            if(!state.premium) state.premium = {};
            state.premium.active = true; 
            state.premium.endTime = now + (time * 60 * 1000);
            state.premium.itemLimit = limit; 
            state.premium.itemsTaken = 0;
            
            // –õ–µ—á–∏–º –∏ —á–∏–Ω–∏–º –≤—Å—ë
            state.needs = { energy: 100, water: 100, mood: 100 };
            if(state.items) { state.items.bike=100; state.items.bag=100; state.items.phone=100; state.items.gear=100; }
            state.debtOverdue = false; 

            saveGame(); 
            if(window.updateUI) window.updateUI();
            document.getElementById('premium-modal').remove();
            
            const tg = window.Telegram.WebApp;
            if(tg.showAlert) tg.showAlert('üëë GOD MODE: –í–ö–õ–Æ–ß–ï–ù!');
            else alert('GOD MODE ON');
            
            window.startPremiumLoop();
        });
    };

    // 5. –ü–û–ö–£–ü–ö–ê –î–ï–ù–ï–ì
    window.buyMoney = function(id, val, cost) {
        window.processPayment(id, cost, () => {
            state.balance += val; 
            saveGame(); 
            if(window.updateUI) window.updateUI();
            document.getElementById('premium-modal').remove();
            
            const tg = window.Telegram.WebApp;
            if(tg.showAlert) tg.showAlert(`üí∏ –ó–∞—á–∏—Å–ª–µ–Ω–æ: +${val} PLN`);
            else alert(`+${val} PLN`);
        });
    };

    // 6. –û–¢–ö–†–´–¢–ò–ï –û–ö–ù–ê
    window.openPremiumModal = function() {
        const old = document.getElementById('premium-modal'); if(old) old.remove();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ)
        const menu = document.getElementById('side-menu'); if(menu) menu.classList.remove('open');
        const overlay = document.getElementById('side-menu-overlay'); if(overlay) overlay.classList.remove('open');

        const modal = document.createElement('div');
        modal.id = 'premium-modal';
        modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10001; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px);";
        modal.onclick = (ev) => { if(ev.target === modal) modal.remove(); };

        let html = `
            <div style="background:#1a1a1a; width:90%; max-width:350px; border-radius:16px; border:1px solid #FFD700; overflow:hidden; box-shadow:0 0 20px rgba(255, 215, 0, 0.2);">
                <div style="background:linear-gradient(45deg, #FFD700, #FFA500); padding:15px; display:flex; justify-content:space-between; align-items:center; color:black;">
                    <h2 style="margin:0; font-size:18px; font-weight:900">PREMIUM ‚≠ê</h2>
                    <div onclick="document.getElementById('premium-modal').remove()" style="font-weight:bold; font-size:20px; cursor:pointer;">‚úï</div>
                </div>
                <div style="padding:15px; max-height:70vh; overflow-y:auto;">
                    <div style="font-size:11px; color:#888; text-align:center; margin-bottom:15px;">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars</div>`;

        // –ö–Ω–æ–ø–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
        Object.values(window.PREMIUM_CFG).forEach(t => {
            html += `
                <div style="background:#222; border:1px solid #333; border-radius:10px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="color:#FFD700; font-weight:bold; font-size:15px;">${t.name}</div><div style="font-size:11px; color:#aaa;">‚è± ${t.time} –º–∏–Ω | üéí ${t.limit} —à—Ç.</div></div>
                    <button onclick="window.buyPrem('${t.id}', ${t.cost}, ${t.time}, ${t.limit})" style="background:#0088cc; color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold; font-size:14px;">${t.cost} ‚≠ê</button>
                </div>`;
        });
        
        // –ö–Ω–æ–ø–∫–∏ –¥–µ–Ω–µ–≥
        html += `<div style="border-top:1px solid #333; margin:15px 0 15px 0;"></div><div style="font-size:12px; font-weight:bold; color:#00e676; margin-bottom:10px;">üí∏ –ü–û–ü–û–õ–ù–ï–ù–ò–ï</div>`;
        window.CASH_PACKS.forEach(c => {
            html += `<div style="background:#222; border:1px solid #333; border-radius:10px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><div style="color:#00e676; font-weight:bold;">+${c.val} PLN</div><button onclick="window.buyMoney('${c.id}', ${c.val}, ${c.cost})" style="background:#0088cc; color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold;">${c.cost} ‚≠ê</button></div>`;
        });

        html += `</div></div>`; 
        modal.innerHTML = html; 
        document.body.appendChild(modal);
    };

    // 7. –ò–ù–î–ò–ö–ê–¢–û–† –ü–†–ï–ú–ò–£–ú–ê
    window.startPremiumLoop = function() {
        let el = document.getElementById('prem-indicator');
        if(!el) { 
            el = document.createElement('div'); 
            el.id = 'prem-indicator'; 
            el.style.cssText = "position:absolute; top:130px; left:50%; transform:translateX(-50%); background:gold; color:black; padding:5px 15px; border-radius:20px; font-weight:bold; z-index:900; border:2px solid white; display:none; pointer-events:none; font-size:12px; box-shadow: 0 0 15px gold;"; 
            document.body.appendChild(el); 
        }
        function loop() {
            if(state.premium && state.premium.active) {
                const now = Date.now();
                if(now < state.premium.endTime) {
                    const left = Math.ceil((state.premium.endTime - now)/1000); 
                    const m = Math.floor(left/60); 
                    const s = left%60;
                    el.style.display = 'block'; 
                    el.innerHTML = `üëë VIP ${m}:${s.toString().padStart(2,'0')}`;
                    
                    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
                    state.needs = {energy:100, water:100, mood:100};
                    if(state.items) {state.items.bike=100; state.items.bag=100;}
                    
                    requestAnimationFrame(loop);
                } else {
                    state.premium.active = false; 
                    el.style.display = 'none'; 
                    saveGame(); window.updateUI();
                }
            } else { el.style.display = 'none'; }
        }
        loop();
    };

    // 8. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –í–°–¢–ê–í–ö–ê –ö–ù–û–ü–ö–ò (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï)
    const btnCheckInterval = setInterval(() => {
        const menu = document.getElementById('side-menu');
        if (!menu) return; // –ï—Å–ª–∏ –º–µ–Ω—é –µ—â–µ –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª–æ—Å—å, –∂–¥–µ–º

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∞
        if (document.getElementById('prem-menu-btn')) return;

        console.log("Adding Premium Button...");
        
        const btn = document.createElement('div'); 
        btn.id = 'prem-menu-btn'; 
        btn.className = 'menu-item';
        // –ñ–µ–ª—Ç—ã–π —Å—Ç–∏–ª—å
        btn.style.cssText = `background: linear-gradient(45deg, #FFD700, #FFA500) !important; color: black !important; font-weight: 900 !important; border: 1px solid #B8860B; text-align: center; padding: 15px; margin: 10px 0; cursor: pointer; display:block; animation: pulseGold 3s infinite;`;
        
        btn.innerHTML = `<i class="fa-solid fa-gem"></i> PREMIUM / –î–û–ù–ê–¢`;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞
        btn.onclick = function(e) { 
            e.preventDefault(); 
            e.stopPropagation();
            window.openPremiumModal(); 
        };
        btn.ontouchstart = function(e) {
            e.preventDefault(); 
            e.stopPropagation();
            window.openPremiumModal();
        };

        // –í–°–¢–ê–í–õ–Ø–ï–ú –°–†–ê–ó–£ –ü–û–°–õ–ï ID –ò–ì–†–û–ö–ê (–í–í–ï–†–• –ú–ï–ù–Æ)
        const idDisplay = document.getElementById('player-id-display');
        if (idDisplay && idDisplay.parentNode === menu) {
            menu.insertBefore(btn, idDisplay.nextSibling);
        } else {
            // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ –º–µ–Ω—é
            menu.prepend(btn);
        }

        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        if(state.premium && state.premium.active) window.startPremiumLoop();

    }, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

    // –°—Ç–∏–ª—å –∞–Ω–∏–º–∞—Ü–∏–∏
    const s = document.createElement('style');
    s.innerHTML = `@keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 10px 5px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }`;
    document.head.appendChild(s);

})();
</script>



<script>
(function() {
    console.log(">>> Patch v48: Wheel Loaded (No Brand)");

    // 1. –ù–ê–°–¢–†–û–ô–ö–ò
    const WHEEL_COOLDOWN = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
    
    const PRIZES = [
        { id: 1, text: "50 PLN",   color: "#ffffff", val: 50,  type: 'money' },
        { id: 2, text: "–≠–ù–ï–†–ì–ï–¢–ò–ö", color: "#00ccff", val: 1,   type: 'item', item: 'energy_drink' },
        { id: 3, text: "250 PLN",  color: "#00e676", val: 250, type: 'money' },
        { id: 4, text: "–†–ï–ú–û–ù–¢",   color: "#ff9100", val: 0,   type: 'repair' },
        { id: 5, text: "100 PLN",  color: "#ffffff", val: 100, type: 'money' },
        { id: 6, text: "–î–ñ–ï–ö–ü–û–¢",  color: "#d500f9", val: 1000, type: 'money' }, 
        { id: 7, text: "–°–ù–ò–ö–ï–†–°",  color: "#ffcc00", val: 1,   type: 'item', item: 'bar' },
        { id: 8, text: "–ü–£–°–¢–û",    color: "#444444", val: 0,   type: 'none' } 
    ];

    // 2. –û–¢–ö–†–´–¢–ò–ï –û–ö–ù–ê
    window.openWheel = function() {
        const menu = document.getElementById('side-menu'); if(menu) menu.classList.remove('open');
        const overlay = document.getElementById('side-menu-overlay'); if(overlay) overlay.classList.remove('open');
        const old = document.getElementById('wheel-modal'); if(old) old.remove();

        const now = Date.now();
        const lastSpin = state.lastSpin || 0;
        const diff = now - lastSpin;
        const canSpin = diff > WHEEL_COOLDOWN;
        
        let timerText = "";
        if(!canSpin) {
            const left = WHEEL_COOLDOWN - diff;
            const h = Math.floor(left/(1000*60*60));
            const m = Math.floor((left % (1000*60*60))/(1000*60));
            timerText = `–ñ–¥–∏: ${h}—á ${m}–º–∏–Ω`;
        } else {
            timerText = "–ö–†–£–¢–ò –ë–ï–°–ü–õ–ê–¢–ù–û!";
        }

        const modal = document.createElement('div');
        modal.id = 'wheel-modal';
        modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:11000; display:flex; flex-direction:column; justify-content:center; align-items:center; backdrop-filter:blur(5px);";
        
        let html = `
            <div style="color:white; font-size:24px; font-weight:900; margin-bottom:20px; text-shadow:0 0 10px #d500f9;">üé° –ö–û–õ–ï–°–û –£–î–ê–ß–ò</div>
            
            <div style="position:relative; width:300px; height:300px; margin-bottom:30px;">
                <div style="position:absolute; top:-15px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:15px solid transparent; border-right:15px solid transparent; border-top:30px solid red; z-index:5;"></div>
                
                <div id="the-wheel" style="width:100%; height:100%; border-radius:50%; border:5px solid white; box-shadow:0 0 20px rgba(255,255,255,0.2); transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); background: conic-gradient(
                    #333 0% 12.5%, #444 12.5% 25%, #333 25% 37.5%, #444 37.5% 50%, 
                    #333 50% 62.5%, #444 62.5% 75%, #333 75% 87.5%, #444 87.5% 100%
                ); position:relative; overflow:hidden;">
                    ${PRIZES.map((p, i) => {
                        const rotation = i * 45 + 22.5;
                        return `<div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) rotate(${rotation}deg) translateY(-110px); color:${p.color}; font-weight:bold; font-size:12px; text-shadow:1px 1px 0 #000;">${p.text}</div>`;
                    }).join('')}
                </div>
                
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50px; height:50px; background:white; border-radius:50%; z-index:4; box-shadow:0 0 10px black; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-gift" style="font-size:24px; color:#d500f9"></i>
                </div>
            </div>

            <button id="spin-btn" onclick="doSpin()" style="background:${canSpin?'#00e676':'#555'}; color:white; padding:15px 40px; border-radius:30px; border:none; font-size:18px; font-weight:bold; box-shadow:0 5px 0 ${canSpin?'#00a653':'#333'}; cursor:${canSpin?'pointer':'default'}; transition:all 0.1s;" ${!canSpin ? 'disabled' : ''}>
                ${timerText}
            </button>
            
            <div onclick="document.getElementById('wheel-modal').remove()" style="margin-top:20px; color:#aaa; text-decoration:underline; cursor:pointer;">–ó–∞–∫—Ä—ã—Ç—å</div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
    };

    // 3. –í–†–ê–©–ï–ù–ò–ï
    window.doSpin = function() {
        const btn = document.getElementById('spin-btn');
        const wheel = document.getElementById('the-wheel');
        if(btn.disabled) return;

        btn.disabled = true;
        btn.textContent = "–ö–†–£–¢–ò–ú...";

        const sectorIndex = Math.floor(Math.random() * 8); 
        const prize = PRIZES[sectorIndex];
        
        const baseRot = 360 * 5; 
        const sectorAngle = 45;
        const targetAngle = baseRot + (360 - (sectorIndex * sectorAngle)) - (sectorAngle / 2);

        wheel.style.transform = `rotate(${targetAngle}deg)`;

        if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
             window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
        }

        setTimeout(() => {
            let msg = "";
            if(prize.type === 'money') {
                state.balance += prize.val;
                msg = `üí∞ –¢—ã –≤—ã–∏–≥—Ä–∞–ª ${prize.val} PLN!`;
            } else if(prize.type === 'item') {
                state.inventory[prize.item] = (state.inventory[prize.item] || 0) + 1;
                msg = `üéí –ü–æ–ª—É—á–µ–Ω–æ: ${prize.text}!`;
            } else if(prize.type === 'repair') {
                if(state.items) { state.items.bike=100; state.items.bag=100; state.items.phone=100; state.items.gear=100; }
                msg = `üõ† –ü–æ–ª–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è!`;
            } else {
                msg = `üò¢ –ü—É—Å—Ç–æ! –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≤—Ç—Ä–∞.`;
            }

            state.lastSpin = Date.now();
            if(window.saveGame) window.saveGame();
            if(window.updateUI) window.updateUI();

            alert(msg);
            document.getElementById('wheel-modal').remove();

        }, 4100);
    };

    // 4. –ö–ù–û–ü–ö–ê –í –ú–ï–ù–Æ
    setInterval(() => {
        const menu = document.getElementById('side-menu');
        if (menu && !document.getElementById('wheel-menu-btn')) {
            const btn = document.createElement('div'); 
            btn.id = 'wheel-menu-btn'; 
            btn.className = 'menu-item';
            
            btn.style.cssText = `color: #d500f9 !important; font-weight: bold; cursor: pointer; display:flex; align-items:center; gap:15px;`;
            btn.innerHTML = `<i class="fa-solid fa-dharmachakra" style="color:#d500f9"></i> üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã`;
            btn.onclick = window.openWheel;

            const premBtn = document.getElementById('prem-menu-btn');
            if (premBtn) {
                menu.insertBefore(btn, premBtn.nextSibling);
            } else {
                const idDisplay = document.getElementById('player-id-display');
                if(idDisplay) menu.insertBefore(btn, idDisplay.nextSibling);
            }
        }
    }, 1500);

})();
</script>




<script>
(function() {
    console.log(">>> Patch v49: Radio Loaded (Lower pos)");

    // 1. –°–ü–ò–°–û–ö –°–¢–ê–ù–¶–ò–ô
    const STATIONS = [
        { name: "üöó Nightride FM", url: "https://stream.nightride.fm/nightride.m4a", style: "color:cyan; text-shadow:0 0 5px cyan" },
        { name: "üéπ Lofi HipHop",  url: "https://play.streamafrica.net/lofi", style: "color:#ff9100; text-shadow:0 0 5px #ff9100" },
        { name: "üáµüá± RMF MAXX",    url: "https://rs6-krk2.rmfstream.pl/RMFMAXX48", style: "color:#ffff00; text-shadow:0 0 5px red" }
    ];

    let currentStationIdx = 0;
    let isPlaying = false;
    let audioObj = new Audio();
    audioObj.crossOrigin = "anonymous"; 

    // 2. –°–û–ó–î–ê–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
    function createRadioUI() {
        const old = document.getElementById('warsaw-fm-widget');
        if(old) old.remove();

        const widget = document.createElement('div');
        widget.id = 'warsaw-fm-widget';
        // –ò–ó–ú–ï–ù–ï–ù–û: top: 140px (–±—ã–ª–æ 70px)
        widget.style.cssText = `
            position: absolute; 
            top: 140px; 
            right: 15px; 
            width: 45px; 
            height: 45px; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid #555;
            border-radius: 50%;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 999; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            overflow: hidden;
        `;

        widget.innerHTML = `<i class="fa-solid fa-music" style="color:white; font-size:20px;"></i>`;
        
        const player = document.createElement('div');
        player.id = 'warsaw-fm-player';
        // –ò–ó–ú–ï–ù–ï–ù–û: top: 140px (—á—Ç–æ–±—ã –º–µ–Ω—é –æ—Ç–∫—Ä—ã–≤–∞–ª–æ—Å—å —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π)
        player.style.cssText = `
            position: absolute;
            top: 140px;
            right: 70px;
            width: 200px;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #00ccff;
            border-radius: 15px;
            padding: 10px;
            z-index: 999;
            display: none; 
            flex-direction: column;
            gap: 5px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.2);
        `;

        player.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="font-size:10px; color:#888; letter-spacing:1px; font-weight:bold">WARSAW FM üìª</span>
                <i class="fa-solid fa-xmark" id="fm-close" style="color:white; cursor:pointer;"></i>
            </div>
            
            <div id="fm-visualizer" style="display:flex; gap:2px; height:15px; align-items:flex-end; justify-content:center; margin-bottom:5px; opacity:0.3">
                <div class="bar" style="width:3px; height:20%; background:#00ccff"></div>
                <div class="bar" style="width:3px; height:50%; background:#00ccff"></div>
                <div class="bar" style="width:3px; height:80%; background:#00ccff"></div>
                <div class="bar" style="width:3px; height:40%; background:#00ccff"></div>
                <div class="bar" style="width:3px; height:60%; background:#00ccff"></div>
            </div>

            <div id="fm-station-name" style="font-size:14px; font-weight:bold; text-align:center; margin-bottom:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${STATIONS[0].name}
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="fm-prev" style="background:none; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-backward-step"></i></button>
                <button id="fm-play" style="width:40px; height:40px; border-radius:50%; background:#00ccff; border:none; color:black; font-size:16px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-play"></i></button>
                <button id="fm-next" style="background:none; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-forward-step"></i></button>
            </div>
            
            <div style="margin-top:8px; display:flex; align-items:center; gap:5px;">
                <i class="fa-solid fa-volume-low" style="color:#666; font-size:10px;"></i>
                <input type="range" id="fm-volume" min="0" max="1" step="0.1" value="0.5" style="width:100%; height:2px; accent-color:#00ccff;">
            </div>
        `;

        document.body.appendChild(widget);
        document.body.appendChild(player);

        // –õ–û–ì–ò–ö–ê
        widget.onclick = function() { player.style.display = 'flex'; widget.style.display = 'none'; };
        document.getElementById('fm-close').onclick = function() { player.style.display = 'none'; widget.style.display = 'flex'; };

        const playBtn = document.getElementById('fm-play');
        const stationLabel = document.getElementById('fm-station-name');
        const viz = document.getElementById('fm-visualizer');

        function togglePlay() {
            if(isPlaying) {
                audioObj.pause();
                isPlaying = false;
                playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
                viz.style.opacity = '0.3';
                stopVizAnim();
                widget.style.animation = 'none';
                widget.style.borderColor = '#555';
            } else {
                if(!audioObj.src) audioObj.src = STATIONS[currentStationIdx].url;
                audioObj.play().then(() => {
                    isPlaying = true;
                    playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    viz.style.opacity = '1';
                    startVizAnim();
                    widget.style.animation = 'pulseRadio 1.5s infinite';
                    widget.style.borderColor = '#00ccff';
                    updateStyle();
                }).catch(e => { alert("–û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å—Ç–∞–Ω—Ü–∏—é."); });
            }
        }
        playBtn.onclick = togglePlay;
        document.getElementById('fm-next').onclick = () => changeStation(1);
        document.getElementById('fm-prev').onclick = () => changeStation(-1);

        function changeStation(dir) {
            currentStationIdx += dir;
            if(currentStationIdx >= STATIONS.length) currentStationIdx = 0;
            if(currentStationIdx < 0) currentStationIdx = STATIONS.length - 1;
            const s = STATIONS[currentStationIdx];
            stationLabel.textContent = s.name;
            updateStyle();
            audioObj.src = s.url;
            if(isPlaying) audioObj.play();
        }

        function updateStyle() {
            const s = STATIONS[currentStationIdx];
            stationLabel.style.cssText = s.style + "; font-size:14px; font-weight:bold; text-align:center; margin-bottom:10px;";
        }
        document.getElementById('fm-volume').oninput = function(e) { audioObj.volume = e.target.value; };

        let vizInterval;
        function startVizAnim() {
            const bars = document.querySelectorAll('#fm-visualizer .bar');
            vizInterval = setInterval(() => { bars.forEach(b => { b.style.height = Math.floor(Math.random() * 80 + 20) + '%'; }); }, 100);
        }
        function stopVizAnim() { clearInterval(vizInterval); document.querySelectorAll('#fm-visualizer .bar').forEach(b => b.style.height = '20%'); }
    }

    const style = document.createElement('style');
    style.innerHTML = `@keyframes pulseRadio { 0% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 204, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0); } }`;
    document.head.appendChild(style);

    createRadioUI();
})();
</script>






<script>
(function() {
    console.log(">>> Patch v62: Loot System Loaded");

    // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–í–ï–ù–¢–ê–†–Ø (–ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
    if(!state.inventory) state.inventory = {};
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ NaN
    ['part_alloy', 'part_chip', 'part_engine'].forEach(k => {
        if(!state.inventory[k]) state.inventory[k] = 0;
    });

    // 2. –ù–ê–°–¢–†–û–ô–ö–ò –®–ê–ù–°–û–í (0.01 = 1%)
    // –¢–´ –ü–†–û–°–ò–õ –°–õ–û–ñ–ù–û -> –í–û–¢ –≠–¢–û –°–õ–û–ñ–ù–û
    const DROP_RATES = {
        'part_alloy':  { chance: 0.040, name: 'üî© –¢–∏—Ç–∞–Ω–æ–≤—ã–π –°–ø–ª–∞–≤', color: '#a0a0a0' }, // 4%
        'part_chip':   { chance: 0.015, name: 'üíæ –ù–µ–π—Ä–æ—á–∏–ø AI',     color: '#00ccff' }, // 1.5%
        'part_engine': { chance: 0.002, name: '‚ò¢Ô∏è –Ø–¥—Ä–æ –î–≤–∏–≥–∞—Ç–µ–ª—è',  color: '#ff3d00' }  // 0.2% (–°–£–ü–ï–† –†–ï–î–ö–û–°–¢–¨)
    };

    // 3. –°–õ–ï–ñ–ö–ê –ó–ê –ó–ê–ö–ê–ó–ê–ú–ò
    let lastOrderCount = -1;

    // –ó–∞–ø—É—Å–∫–∞–µ–º "–°–º–æ—Ç—Ä—è—â–µ–≥–æ"
    setInterval(() => {
        // –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if(!state || !state.career) return;

        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
        if (lastOrderCount === -1) {
            lastOrderCount = state.career.totalOrders;
            return;
        }

        // –ï–°–õ–ò –ö–û–õ–ò–ß–ï–°–¢–í–û –ó–ê–ö–ê–ó–û–í –ò–ó–ú–ï–ù–ò–õ–û–°–¨ (–ó–ù–ê–ß–ò–¢, –¢–´ –°–î–ê–õ –ó–ê–ö–ê–ó)
        if (state.career.totalOrders > lastOrderCount) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            lastOrderCount = state.career.totalOrders;
            
            // –ö–ò–î–ê–ï–ú –ö–£–ë–ò–ö–ò!
            rollForLoot();
        }
    }, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

    // 4. –ì–ï–ù–ï–†–ê–¢–û–† –õ–£–¢–ê
    function rollForLoot() {
        const roll = Math.random(); // –ß–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0
        console.log("Rolling for loot... Result:", roll.toFixed(4));

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å —Å–∞–º–æ–π —Ä–µ–¥–∫–æ–π –¥–µ—Ç–∞–ª–∏ –∫ —á–∞—Å—Ç–æ–π
        
        // 1. –î–≤–∏–≥–∞—Ç–µ–ª—å (0.0 - 0.002)
        if (roll < DROP_RATES['part_engine'].chance) {
            giveItem('part_engine');
            return;
        }
        
        // 2. –ß–∏–ø (—Å–¥–≤–∏–≥–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω)
        // –ß—Ç–æ–±—ã —à–∞–Ω—Å—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–ª–∏—Å—å, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Ä–æ–≥
        const chipThreshold = DROP_RATES['part_engine'].chance + DROP_RATES['part_chip'].chance;
        if (roll < chipThreshold) {
            giveItem('part_chip');
            return;
        }

        // 3. –°–ø–ª–∞–≤
        const alloyThreshold = chipThreshold + DROP_RATES['part_alloy'].chance;
        if (roll < alloyThreshold) {
            giveItem('part_alloy');
            return;
        }
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ - —Ç–∏—à–∏–Ω–∞. –≠—Ç–æ —Ö–∞—Ä–¥–∫–æ—Ä.
    }

    // 5. –í–´–î–ê–ß–ê –ò –ê–ù–ò–ú–ê–¶–ò–Ø
    function giveItem(itemId) {
        const item = DROP_RATES[itemId];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        state.inventory[itemId] = (state.inventory[itemId] || 0) + 1;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
        if(window.saveGame) window.saveGame();
        if(window.updateUI) window.updateUI();

        // –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–†–ê–°–ò–í–û–ï –û–ö–ù–û
        showLootModal(item);
    }

    function showLootModal(item) {
        // –ó–≤—É–∫ —É—Å–ø–µ—Ö–∞ (–≤–∏–±—Ä–∞—Ü–∏—è)
        if(window.Telegram?.WebApp?.HapticFeedback) {
             window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); animation: fadeIn 0.3s ease;
        `;

        modal.innerHTML = `
            <div style="font-size:80px; animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);">üéÅ</div>
            <div style="color:white; font-size:24px; font-weight:bold; margin-top:20px; text-transform:uppercase; letter-spacing:2px;">–†–µ–¥–∫–∞—è –Ω–∞—Ö–æ–¥–∫–∞!</div>
            <div style="color:${item.color}; font-size:28px; font-weight:900; margin-top:10px; text-shadow: 0 0 20px ${item.color}; text-align:center; padding:0 20px;">
                ${item.name}
            </div>
            <div style="color:#aaa; font-size:14px; margin-top:30px;">–ù–∞–π–¥–µ–Ω–æ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ</div>
            
            <button id="loot-ok-btn" style="margin-top:40px; padding:15px 50px; background:${item.color}; color:black; border:none; border-radius:30px; font-weight:bold; font-size:18px; cursor:pointer; box-shadow: 0 0 20px ${item.color};">–ó–ê–ë–†–ê–¢–¨</button>
        `;

        document.body.appendChild(modal);

        document.getElementById('loot-ok-btn').onclick = function() {
            modal.remove();
        };
    }

    // CSS –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ª—É—Ç–∞
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 
            0% { transform: scale(0); } 
            50% { transform: scale(1.2); } 
            100% { transform: scale(1); } 
        }
    `;
    document.head.appendChild(style);

})();
</script>

