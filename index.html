<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim: Real GPS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --brand-blue: #0088cc; 
            --taxi-yellow: #ffcc00;
            --taxi-black: #222;
            --accent-green: #00e676;
            --accent-red: #ff3d00;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); overflow: hidden; user-select: none; }
        
        #map { height: 100%; width: 100%; z-index: 1; background: #222; }

        /* UI Overlay */
        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; border: none; }
        .balance-display { background: rgba(0, 0, 0, 0.8); padding: 8px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        .balance-label { font-size: 10px; color: #a0a0a0; text-transform: uppercase; }
        .debt-warning { color: var(--accent-red); font-size: 10px; font-weight: bold; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); position: relative; }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; display: block; margin-top: 5px; }
        .tiny-stat { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 900; color: #fff; text-shadow: 0 0 3px #000; z-index: 50; pointer-events: none; }

        .game-toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(0, 0, 0, 0.9); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; z-index: 1001; opacity: 0; transition: all 0.3s; pointer-events: none; display: flex; align-items: center; gap: 8px; white-space: nowrap; border: 1px solid #333; }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-warn { border-color: #ff9100; color: #ff9100; }
        .toast-success { border-color: var(--accent-green); color: var(--accent-green); }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); color: #333; }
        
        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-top: 10px; transition: background 0.3s; }
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; text-transform: uppercase; font-size: 14px; }
        .slider-knob { position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px; background: var(--brand-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: grab; z-index: 2; transition: transform 0.1s; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 136, 204, 0.2); z-index: 0; }
        .slider-container.taxi-mode { background: #fff9c4; border: 1px solid #fbc02d; }
        .slider-container.taxi-mode .slider-knob { background: var(--taxi-yellow); color: black; }
        .slider-container.taxi-mode .slider-fill { background: rgba(255, 204, 0, 0.3); }
        
        .controls-row { display: flex; gap: 10px; margin-top: 15px; }
        .pedal-btn { flex: 1; background: var(--brand-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 0 #006699; transition: all 0.1s; }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; }
        .pedal-btn.blocked { background: #ff9100; box-shadow: 0 4px 0 #e65100; cursor: not-allowed; }
        .pedal-btn.taxi-pedal { background: var(--taxi-black); color: var(--taxi-yellow); box-shadow: 0 4px 0 #444; }
        .bribe-btn { display:none; flex: 1; background: #222; color: #ff3d00; border: 1px solid #ff3d00; padding: 18px; border-radius: 16px; font-size: 14px; font-weight: 800; text-transform: uppercase; cursor: pointer; animation: pulse 1s infinite; }

        .bag-btn { width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; position: relative; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .quick-inv { position: absolute; bottom: 90px; left: 20px; width: 220px; background: #252525; color: white; padding: 10px; border-radius: 16px; z-index: 1005; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); border: 1px solid #444; }
        .quick-inv.open { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: background 0.2s; }
        @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Menus */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; max-width: 320px; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; align-items: center; }
        .menu-item.locked { opacity: 0.5; cursor: not-allowed; }
        
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        .shop-card { background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .shop-btn { padding: 8px 14px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; border: 1px solid var(--brand-blue); color: var(--brand-blue); background: white; min-width: 80px; }
        .shop-btn.buy { background: var(--brand-blue); color: white; }
        .shop-btn.bought { background: var(--accent-green); border-color: var(--accent-green); color: white; }

        /* Auth */
        .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; border: 1px solid #333; }
        .auth-input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-login { background: var(--brand-blue); color: white; }
        
        /* Map Event Icons */
        .map-event-icon { font-size: 24px; animation: bounce 1s infinite; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å <span id="debt-warning" class="debt-warning">(–î–û–õ–ì!)</span></div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon" id="icon-vehicle"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div><span class="equip-label" id="label-vehicle">–í–ï–õ</span><div class="tiny-stat" id="stat-bike"></div></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon" id="icon-bag"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label" id="label-bag">–°–£–ú–ö–ê</span><div class="tiny-stat" id="stat-bag"></div></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span><div class="tiny-stat" id="stat-phone"></div></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon" id="icon-gear"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label" id="label-gear">–û–î–ï–ñ–î–ê</span><div class="tiny-stat" id="stat-gear"></div></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" id="icon-energy" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label" id="label-energy">–°–ò–õ–´</span><div class="tiny-stat" id="stat-energy"></div></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span><div class="tiny-stat" id="stat-water"></div></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span><div class="tiny-stat" id="stat-mood"></div></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-box">
            <div style="text-align:right; margin-bottom:10px;"><i class="fa-solid fa-xmark" onclick="closeAuthModal()" style="color:#888; font-size:20px; cursor:pointer"></i></div>
            <div style="text-align:center;color:white;margin-bottom:20px">üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            <input type="text" id="auth-login" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn btn-login" onclick="performLogin()">–í–æ–π—Ç–∏</button>
            <button class="auth-btn" style="border:1px solid var(--accent-green);color:var(--accent-green);background:transparent" onclick="performRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 5px">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="player-name-display" style="font-size:18px; color:var(--brand-blue); font-weight:bold; margin-bottom:5px"></div>
            <div id="player-id-display" style="font-size:10px; color:#666; display:block; margin-bottom:20px">Loading ID...</div>
            
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store" style="color:var(--brand-blue)"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns" style="color:var(--accent-green)"></i> –ë–∞–Ω–∫ / –ö—Ä–µ–¥–∏—Ç</div>
            <div class="menu-item" onclick="openModal('deflation')"><i class="fa-solid fa-scale-unbalanced-flip" style="color:#90a4ae"></i> –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ / –ò–Ω—Ñ–ª—è—Ü–∏—è</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            
            <div style="height:1px; background:#333; margin:15px 0"></div>
            <div style="font-size:12px; color:var(--taxi-yellow); font-weight:bold; margin-bottom:5px">üöñ –¢–∞–∫—Å–∏ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
            <div class="menu-item taxi-item locked" id="taxi-showroom-btn" onclick="openModal('taxi-shop')"><i class="fa-solid fa-car" style="color:var(--taxi-yellow)"></i> –ê–≤—Ç–æ—Å–∞–ª–æ–Ω</div>
            <div class="menu-item taxi-item locked" id="taxi-licenses-btn" onclick="openModal('taxi-licenses')"><i class="fa-solid fa-id-card" style="color:#aaa"></i> –õ–∏—Ü–µ–Ω–∑–∏–∏</div>
            
            <button id="taxi-toggle-btn" style="background:#333; color:#777; width:100%; padding:15px; border-radius:10px; border:2px solid #444; font-weight:bold; margin-top:10px; cursor:pointer; display:none" onclick="toggleTaxiMode()">
                <i class="fa-solid fa-taxi"></i> <span>–í–ö–õ–Æ–ß–ò–¢–¨ TAXI</span>
            </button>

            <div style="margin-top:auto">
                <div class="menu-item" id="auth-menu-item" onclick="openAuthModal()" style="display:none; color:var(--accent-green)">
                    <i class="fa-solid fa-key"></i> üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </div>
                <div class="menu-item" onclick="resetGame()" style="color:var(--accent-red)"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
            </div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0" id="city-label">–í–∞—Ä—à–∞–≤–∞</h3>
            <div id="demo-mode-alert" style="color:#ff3d00; font-size:11px; margin:5px 0; display:none; border:1px solid #ff3d00; padding:5px; border-radius:5px; background:rgba(0,0,0,0.05); font-weight:bold; text-align:center;">
                ‚ö†Ô∏è –î–ï–ú–û –†–ï–ñ–ò–ú (Android/Web)<br>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!
            </div>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ò–Ω—Ñ–ª—è—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω–∞</p>
            <div class="slider-container" id="offline-slider-box">
                <div class="slider-fill" id="offline-slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="offline-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div style="flex:1">
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px">
                        <span style="font-size:12px; color:#666" id="order-dest">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                        <span id="order-offer" style="font-weight:bold; color:var(--accent-green); font-size:15px">-- PLN</span>
                    </div>
                    <div style="display:flex; justify-content:flex-end; align-items:center">
                        <span id="delivery-timer" style="font-size:11px;color:#666;font-weight:bold"></span>
                    </div>
                </div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--brand-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--brand-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--brand-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–ü–æ–∏—Å–∫...</span>
            </div>

            <div class="slider-container" id="online-slider-box">
                <div class="slider-fill" id="online-slider-fill"></div>
                <div class="slider-text" id="online-slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="online-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó</button>
                <button class="bribe-btn" id="bribe-btn" onclick="giveBribe()">–î–ê–¢–¨ –í–ó–Ø–¢–ö–£ (-20)</button>
            </div>
            <div id="garnishment-info" style="font-size:11px; color:var(--accent-red); text-align:center; display:none"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", 
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) { console.error("Firebase Error:", e); }

        const SAVE_KEY = 'WARSZAWA_FOREVER';
        const TAXI_UNLOCK_REQ = 50;
        const WARSAW_CENTER = [52.2297, 21.0122]; 
        
        let gameConfig = {
            basePickupPay: 4.0, perKmPay: 1.5, payVariance: 2.0, 
            inflationRate: 0.1, trafficChance: 0.1, trafficDuration: 5000,
            energyDrain: 0.15, waterDrain: 0.10, moodDrain: 0.05, 
            deliveryTime: 60, coolingRate: 0.5, 
            tipChance: 0.5, tipBonusChance: 0.3, tipMinTemp: 60, tipMinMood: 80,
            itemPrices: {}
        };

        const ITEMS_DB = {
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle', desc: '–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ–π (+100%)' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open', desc: '–ó–∞–ø–ª–∞—Ç–∫–∞ –¥—ã—Ä (+100%)' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen', desc: '–û–ø–ª–∞—Ç–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (+100%)' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt', desc: '–•–∏–º—á–∏—Å—Ç–∫–∞ (+100%)' },
            car_main: { name: '–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å', type: 'repair', baseCost: 100, icon: 'fa-wrench', desc: '–†–µ–º–æ–Ω—Ç –ø–æ–¥–≤–µ—Å–∫–∏ –∏ –¢–û (+100%)' },
            car_interior: { name: '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞', type: 'repair', baseCost: 40, icon: 'fa-sparkles', desc: '–ß–∏—Å—Ç–æ—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (+100%)' },
            car_tires: { name: '–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂', type: 'repair', baseCost: 80, icon: 'fa-circle-notch', desc: '–°–º–µ–Ω–∞ —Ä–µ–∑–∏–Ω—ã (+100%)' },
            water: { name: '–í–æ–¥–∞ (0.5–ª)', type: 'buy', cost: 2.0, icon: 'fa-bottle-water', effect: { water: 35, energy: 5 }, desc: '–°–ø–∞—Å–∞–µ—Ç –æ—Ç –∂–∞–∂–¥—ã.', target: 'water' },
            bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.5, icon: 'fa-cookie-bite', effect: { energy: 20, mood: 15 }, desc: '–ë–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏.', target: 'energy' },
            energy_drink: { name: 'Red Bull', type: 'buy', cost: 7.0, icon: 'fa-bolt', effect: { energy: 50, mood: 5, water: -5 }, desc: '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –≠–ù–ï–†–ì–ò–ò, –Ω–æ –Ω–µ –≤–æ–¥—ã!', target: 'energy', special: 'no_drain' },
            coffee: { name: '–õ–∞—Ç—Ç–µ', type: 'buy', cost: 9.0, icon: 'fa-mug-hot', effect: { mood: 30, energy: 10 }, desc: '–î–ª—è –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!', target: 'mood' },
            chocolate: { name: '–®–æ–∫–æ–ª–∞–¥–∫–∞', type: 'buy', cost: 6.5, icon: 'fa-gift', effect: { mood: 20 }, desc: '–°—ä–µ—à—å –Ω–∞ –∑–∞–∫–∞–∑–µ - –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–æ–±—Ä–µ–µ—Ç!', target: 'mood', special: 'gift' },
            gas: { name: '–ë–µ–Ω–∑–∏–Ω (10–ª)', type: 'buy', cost: 12.0, icon: 'fa-gas-pump', effect: { energy: 80 }, desc: '–ó–∞–ø—Ä–∞–≤–∫–∞ –∞–≤—Ç–æ.', target: 'energy' }
        };

        const DEFAULT_STATE = {
            name: null, balance: 0, debt: 0, debtTimer: 0, debtOverdue: false, loanStreak: 0, 
            isOnline: false, isSearching: false, scheduledOffline: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 }, needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 }, history: [], energyBoostActive: false, isAuth: false,
            career: { totalOrders: 0 }, taxi: { unlocked: false, active: false, vehicle: null, licenses: { driver: false, insurance: false, taxi: false } }
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE)); 
        state.id = 'u_' + Math.random().toString(36).substr(2, 9);

        // MAP VARIABLES
        let map;
        let mapVisuals = { courierMarker: null, destMarker: null, routeLine: null, eventMarker: null };
        let mapPoints = { courier: null, restaurant: null, client: null };

        const restaurants = [{ name: "McDonald's", icon: "üçî" }, { name: "KFC", icon: "üçó" }, { name: "Pasibus", icon: "üçî" }, { name: "Kebab King", icon: "üåØ" }, { name: "Sushi Master", icon: "üç£" }, { name: "Pizza Hut", icon: "üçï" }];
        const taxiDestinations = [{ name: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–æ–ø–µ–Ω", icon: "‚úàÔ∏è" }, { name: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –í–æ–∫–∑–∞–ª", icon: "üöÜ" }, { name: "–ë–∏–∑–Ω–µ—Å –¶–µ–Ω—Ç—Ä", icon: "üè¢" }, { name: "–°—Ç–∞—Ä—ã–π –ì–æ—Ä–æ–¥", icon: "üèõ" }, { name: "–ö–ª—É–± 'Level 27'", icon: "üç∏" }, { name: "–¢–¶ Zlote Tarasy", icon: "üõç" }];
        const clientNames = ["–ê–Ω–Ω–∞", "–ü–µ—Ç—Ä", "–ö–∞—Å—è", "–ú–∏—Ö–∞–ª", "–û–ª—å–≥–∞", "–¢–æ–º–∞—à", "–Æ–ª–∏—è", "–Ø–∫—É–±"];
        
        let currentOrder = null;
        let acceptTimeout = null;
        let orderInterval = null;
        let lastSync = 0;

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 500);

            const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
            loadGame();

            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                state.id = tg.initDataUnsafe.user.id.toString();
                state.name = tg.initDataUnsafe.user.first_name;
                state.isAuth = true; 
                saveGame();
                setTimeout(() => { document.getElementById('auth-menu-item').style.display = 'none'; document.getElementById('demo-mode-alert').style.display = 'none'; }, 500);
                listenToCloud(); syncToCloud(true);
            } else {
                if (!state.name) state.name = "Guest Courier";
                if (!state.isAuth) { document.getElementById('demo-mode-alert').style.display = 'block'; document.getElementById('auth-menu-item').style.display = 'flex'; }
            }
            
            document.getElementById('player-id-display').textContent = `ID: ${state.id}`;
            document.getElementById('player-name-display').textContent = state.name;
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            initSliders();
            setInterval(checkDebt, 1000); 
            setInterval(checkSystemPenalties, 60000);
            if(state.isAuth || true) { listenToCloud(); syncToCloud(true); }
            updateMenuState(); updateAuthUI(); updateUI(); updateVisualStats();
        }

        // --- NEW MAP LOGIC ---
        function getRandomPoint() {
            const lat = WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.08;
            const lng = WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.12;
            return [lat, lng];
        }

        function drawPath(start, end) {
            if (!map) return;
            if (mapVisuals.routeLine) map.removeLayer(mapVisuals.routeLine);
            mapVisuals.routeLine = L.polyline([start, end], { color: '#009de0', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
            map.fitBounds([start, end], {padding: [50, 50]});
        }

        function updateCourierPos(start, end, progress) {
            if (!mapVisuals.courierMarker) {
                const iconHtml = state.taxi.active 
                    ? '<i class="fa-solid fa-taxi" style="color:#ffcc00; font-size:20px; border:2px solid black; background:black; border-radius:50%; padding:5px;"></i>'
                    : '<i class="fa-solid fa-bicycle" style="color:white; font-size:20px; border:2px solid #009de0; background:#009de0; border-radius:50%; padding:5px;"></i>';
                const icon = L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [30, 30], iconAnchor: [15, 15] });
                mapVisuals.courierMarker = L.marker(start, {icon: icon, zIndexOffset: 1000}).addTo(map);
            }
            const pct = progress / 100;
            const lat = start[0] + (end[0] - start[0]) * pct;
            const lng = start[1] + (end[1] - start[1]) * pct;
            const newPos = [lat, lng];
            mapVisuals.courierMarker.setLatLng(newPos);
            mapPoints.courier = newPos; // Update current pos
            
            // Move event marker if exists
            if(mapVisuals.eventMarker) mapVisuals.eventMarker.setLatLng(newPos);
        }

        function showMapEvent(type) {
            if (!mapPoints.courier) return;
            let html = '';
            if(type === 'police') html = '<div class="map-event-icon">üöì</div>';
            if(type === 'traffic') html = '<div class="map-event-icon">üöß</div>';
            
            const icon = L.divIcon({ html: html, className: 'custom-event-icon', iconSize: [30,30], iconAnchor:[15,15] });
            mapVisuals.eventMarker = L.marker(mapPoints.courier, {icon: icon, zIndexOffset: 2000}).addTo(map);
        }

        function clearMap() {
            if(mapVisuals.routeLine) map.removeLayer(mapVisuals.routeLine);
            if(mapVisuals.destMarker) map.removeLayer(mapVisuals.destMarker);
            if(mapVisuals.eventMarker) map.removeLayer(mapVisuals.eventMarker);
            // Don't remove courierMarker, just update it
            mapVisuals.routeLine = null; mapVisuals.destMarker = null; mapVisuals.eventMarker = null;
        }

        // --- GAME LOGIC ---

        function createOrder() {
            if (!state.isOnline) return;
            state.isSearching = false;

            // Generate Points
            mapPoints.courier = mapPoints.courier || WARSAW_CENTER; // Start from last pos or center
            mapPoints.restaurant = getRandomPoint();
            mapPoints.client = getRandomPoint();

            // Calculate REAL distances (Leaflet returns meters)
            const distToRest = map.distance(mapPoints.courier, mapPoints.restaurant);
            const distToClient = map.distance(mapPoints.restaurant, mapPoints.client);
            const totalDistKm = (distToClient / 1000).toFixed(1);

            let r; if(state.taxi.active) { r = taxiDestinations[Math.floor(Math.random() * taxiDestinations.length)]; } else { r = restaurants[Math.floor(Math.random() * restaurants.length)]; }
            
            // Calculate Pay based on REAL distance
            const totalRepairs = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflationMult = 1 + (totalRepairs * gameConfig.inflationRate);
            let rawPay = (gameConfig.basePickupPay || 4.0) + (parseFloat(totalDistKm) * (gameConfig.perKmPay || 1.5));
            let finalOffer = rawPay * inflationMult;
            if(state.taxi.active) { finalOffer = finalOffer * 4.0; }
            finalOffer += (Math.random() * 2) - 1;
            if(finalOffer < 3) finalOffer = 3; 

            currentOrder = { rest: r, progress: 0, stage: 0, foodTemp: 100, accepted: false, timeLeft: 90, tempWarned: false, distance: totalDistKm, offerPrice: finalOffer, clientName: clientNames[Math.floor(Math.random() * clientNames.length)], bonusHappy: false };

            document.getElementById('rest-name').textContent = state.taxi.active ? `–ó–∞–∫–∞–∑: ${r.name}` : `–ï–¥–µ–º –≤ ${r.name}`;
            document.getElementById('rest-icon').textContent = r.icon;
            document.getElementById('status-label').textContent = 'üî• –ù–û–í–´–ô –ó–ê–ö–ê–ó üî•';
            document.getElementById('order-dest').textContent = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${totalDistKm} –∫–º`;
            document.getElementById('order-offer').style.display = 'block';
            document.getElementById('order-offer').textContent = `üí∞ ${finalOffer.toFixed(2)} PLN`;

            document.getElementById('pedal-btn').textContent = '–ü–†–ò–ù–Ø–¢–¨';
            document.getElementById('pedal-btn').disabled = false;
            
            acceptTimeout = setTimeout(missOrder, 15000); 
            resetSlider('online'); document.getElementById('online-slider-text').textContent = "–ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–¢–¨ –û–§–õ–ê–ô–ù";
            
            // Map Visualization Phase 1: Show path to Restaurant
            drawPath(mapPoints.courier, mapPoints.restaurant);
            // Place icon for Restaurant
            const destIcon = L.divIcon({ html: `<div style="font-size:24px">${r.icon}</div>`, className: 'custom-div-icon', iconSize: [24, 24], iconAnchor: [12, 12] });
            mapVisuals.destMarker = L.marker(mapPoints.restaurant, {icon: destIcon}).addTo(map);
            updateCourierPos(mapPoints.courier, mapPoints.restaurant, 0);
        }

        function acceptOrder() {
            currentOrder.accepted = true; clearTimeout(acceptTimeout);
            document.getElementById('pedal-btn').textContent = state.taxi.active ? '–ï–•–ê–¢–¨ –ö –ü–ê–°–°–ê–ñ–ò–†–£' : '–ï–•–ê–¢–¨ –í –†–ï–°–¢–û–†–ê–ù';
            document.getElementById('order-offer').style.display = 'none'; 
            startOrderLoop(); 
        }

        function nextStage() {
            currentOrder.stage++; currentOrder.progress = 0; document.getElementById('track-fill').style.width='0%';
            
            if (currentOrder.stage === 1) { 
                // ARRIVED AT RESTAURANT
                const btn = document.getElementById('pedal-btn'); btn.disabled = true; 
                btn.textContent = state.taxi.active ? '–ü–û–°–ê–î–ö–ê...' : '–ó–ê–ë–ò–†–ê–ï–ú –ó–ê–ö–ê–ó...'; 
                document.getElementById('status-label').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                
                setTimeout(() => {
                    btn.disabled = false; btn.textContent = state.taxi.active ? '–í–ï–ó–ï–ú –ö–õ–ò–ï–ù–¢–ê' : '–í–ï–ó–ï–ú –ó–ê–ö–ê–ó';
                    document.getElementById('status-label').textContent = '–í –ø—É—Ç–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É';
                    currentOrder.stage = 2;
                    
                    // MAP PHASE 2: Path to Client
                    clearMap(); // Remove restaurant path
                    drawPath(mapPoints.restaurant, mapPoints.client); // Draw to client
                    const clientIcon = L.divIcon({ html: '<i class="fa-solid fa-house-user" style="color:#ff3d00; font-size:24px;"></i>', className: 'custom-div-icon', iconSize: [24, 24], iconAnchor: [12, 12] });
                    mapVisuals.destMarker = L.marker(mapPoints.client, {icon: clientIcon}).addTo(map);
                    
                    // Teleport courier logic visually starts from restaurant now
                    mapPoints.courier = mapPoints.restaurant; 
                    updateCourierPos(mapPoints.restaurant, mapPoints.client, 0);

                }, 2000);
            } else if (currentOrder.stage === 3) { completeOrder(); }
        }

        function pedal() {
            if (!currentOrder) return;
            if (!currentOrder.accepted) { acceptOrder(); return; }
            
            // Logic depending on stage
            let startP, endP;
            if (currentOrder.stage === 0) { startP = mapPoints.courier; endP = mapPoints.restaurant; } // To Rest
            if (currentOrder.stage === 2) { startP = mapPoints.restaurant; endP = mapPoints.client; } // To Client
            
            let fatigue = Math.max(0.3, state.needs.energy / 100);
            
            // Resource Drain
            if(state.taxi.active) {
                 if(state.needs.energy <= -20) { showToast('‚õΩ –ë–ï–ù–ó–ò–ù –ö–û–ù–ß–ò–õ–°–Ø!', 'warn'); openQuickInv(true); return; }
                 state.needs.energy -= 0.5; state.needs.mood -= 0.02; state.items.bike -= 0.2; currentOrder.progress += 4; 
            } else {
                if (state.needs.energy <= -50) { showToast('–°–ò–õ–´ –ù–ê –ò–°–•–û–î–ï!', 'warn'); openQuickInv(true); return; }
                if (!state.energyBoostActive) state.needs.energy -= gameConfig.energyDrain;
                state.needs.water -= gameConfig.waterDrain; state.needs.mood -= gameConfig.moodDrain;
                state.items.bike -= 0.1; currentOrder.progress += (5 * fatigue);
            }

            document.getElementById('track-fill').style.width=currentOrder.progress+'%'; document.getElementById('track-icon').style.left=currentOrder.progress+'%';
            
            // Update Map
            if(startP && endP) updateCourierPos(startP, endP, currentOrder.progress);

            if (Math.random() < gameConfig.trafficChance && currentOrder.stage === 2) triggerRandomEvent();
            if (currentOrder.progress >= 100) nextStage();
            saveGame(); updateUI();
        }

        function triggerRandomEvent() {
            const btn = document.getElementById('pedal-btn'); const bribeBtn = document.getElementById('bribe-btn');
            const events = [{ type:'traffic', text: "üöß –ü–†–û–ë–ö–ê!", time: 4000 }, { type:'police', text: "üëÆ –ü–û–õ–ò–¶–ò–Ø", time: 6000 }];
            const ev = events[Math.floor(Math.random()*events.length)];
            
            btn.disabled = true; btn.classList.add('blocked'); btn.textContent = ev.text; 
            if(ev.type === 'police') bribeBtn.style.display = 'block';
            
            showMapEvent(ev.type); // SHOW ICON ON MAP
            showToast('–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ –ø—É—Ç–∏!', 'warn');

            setTimeout(() => { 
                if (currentOrder && btn.disabled) { 
                    btn.disabled = false; btn.classList.remove('blocked'); 
                    btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó'; 
                    bribeBtn.style.display = 'none';
                    if(mapVisuals.eventMarker) map.removeLayer(mapVisuals.eventMarker); // Remove icon
                } 
            }, ev.time);
        }

        function giveBribe() {
            if(state.balance < 20) { showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥ (20 PLN)', 'warn'); return; }
            state.balance -= 20;
            const btn = document.getElementById('pedal-btn');
            btn.disabled = false; btn.classList.remove('blocked');
            btn.textContent = '–ï–•–ê–¢–¨ –î–ê–õ–¨–®–ï';
            document.getElementById('bribe-btn').style.display = 'none';
            if(mapVisuals.eventMarker) map.removeLayer(mapVisuals.eventMarker);
            showToast('üëÆ –í–æ–ø—Ä–æ—Å —Ä–µ—à–µ–Ω', 'success');
            saveGame(); updateUI();
        }

        // --- STANDARD FUNCTIONS (Simplified for brevity) ---
        function checkSystemPenalties() {
            let penalize = false;
            ['energy', 'water', 'mood'].forEach(k => { if(state.needs[k] < 0) penalize = true; });
            if(penalize) { state.balance -= 1.0; showToast('–®—Ç—Ä–∞—Ñ –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -1.00 PLN', 'warn'); saveGame(); updateUI(); }
        }
        function performRegister() {
            const login = document.getElementById('auth-login').value.trim(); const pass = document.getElementById('auth-pass').value.trim();
            if(login.length < 3) return;
            db.ref('users_lookup/' + login).once('value', snap => {
                if(snap.exists()) { showToast('–ó–∞–Ω—è—Ç–æ!', 'warn'); } else {
                    db.ref('users_lookup/' + login).set({ pass: pass, playerId: state.id, login: login }).then(() => {
                          state.name = login; state.isAuth = true; saveGame(); syncToCloud(true); updateUI(); updateAuthUI(); closeAuthModal();
                    });
                }
            });
        }
        function performLogin() {
            const login = document.getElementById('auth-login').value.trim(); const pass = document.getElementById('auth-pass').value.trim();
            db.ref('users_lookup/' + login).once('value', snap => {
                if(!snap.exists() || snap.val().pass !== pass) { showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'warn'); return; }
                const targetId = snap.val().playerId;
                db.ref('players/' + targetId).once('value', playerSnap => {
                    state = { ...DEFAULT_STATE, ...playerSnap.val() }; state.id = targetId; state.isAuth = true;
                    saveGame(); updateUI(); updateMenuState(); updateAuthUI(); listenToCloud(); closeAuthModal();
                });
            });
        }
        function syncToCloud(force) { if (!db) return; const now = Date.now(); if (force || now - lastSync > 3000) { db.ref('players/' + state.id).update({ name: state.name, balance: state.balance, stats: state.needs, inventory: state.inventory, items: state.items, career: state.career, taxi: state.taxi }); lastSync = now; } }
        function listenToCloud() { if (!db) return; db.ref('players/' + state.id).on('value', snap => { const d = snap.val(); if(d && Math.abs(d.balance - state.balance) > 0.1) { state.balance = d.balance; updateUI(); } }); }
        function loadGame() { try { const s = localStorage.getItem(SAVE_KEY); if (s) state = { ...DEFAULT_STATE, ...JSON.parse(s) }; } catch(e) {} }
        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); syncToCloud(); }
        function checkDebt() { if (state.debt > 0 && Date.now() > state.debtTimer && !state.debtOverdue) { state.debtOverdue = true; updateUI(); } }
        function showToast(msg, type='info') { const t = document.getElementById('toast'); t.innerHTML = msg; t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : 'toast-success'); setTimeout(() => t.className = 'game-toast', 3000); }
        
        function startOrderLoop() {
            if (orderInterval) clearInterval(orderInterval);
            orderInterval = setInterval(() => {
                if (!currentOrder || !currentOrder.accepted) return;
                currentOrder.timeLeft--;
                document.getElementById('delivery-timer').textContent = `‚è± ${currentOrder.timeLeft}—Å`;
                if (currentOrder.timeLeft <= 0) { failOrder("time"); return; }
                let decay = state.taxi.active ? 0.3 : 0.5;
                currentOrder.foodTemp -= decay;
                document.getElementById('temp-val').textContent = Math.floor(currentOrder.foodTemp) + '%';
                if (currentOrder.foodTemp <= 0) { failOrder("cold"); return; }
            }, 1000);
        }
        function failOrder(r) { clearInterval(orderInterval); state.balance -= 5.00; currentOrder = null; clearMap(); startSearching(); showToast('–ó–∞–∫–∞–∑ –ø—Ä–æ–≤–∞–ª–µ–Ω', 'warn'); updateUI(); }
        function missOrder() { state.isSearching = true; currentOrder = null; state.balance -= 0.10; clearMap(); startSearching(); }
        function completeOrder() {
            clearInterval(orderInterval);
            let pay = currentOrder.offerPrice; 
            let tip = (currentOrder.foodTemp > 60 && Math.random() > 0.5) ? (Math.random() * 5) : 0;
            state.balance += (pay + tip);
            state.career.totalOrders++;
            state.history.push({ rest: currentOrder.rest.name, total: pay+tip });
            clearMap(); 
            if (state.scheduledOffline) goOffline(); else startSearching();
            showToast(`+${(pay+tip).toFixed(2)} PLN`, 'success'); saveGame(); updateUI();
        }
        function startSearching() {
            if (state.scheduledOffline) { goOffline(); return; }
            state.isSearching = true;
            document.getElementById('active-order-view').style.display = 'flex';
            document.getElementById('rest-name').textContent = '–ü–æ–∏—Å–∫...';
            document.getElementById('status-label').textContent = '–ò—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞...';
            document.getElementById('order-offer').style.display = 'none';
            document.getElementById('pedal-btn').disabled = true; document.getElementById('pedal-btn').textContent = '–ü–û–ò–°–ö...';
            document.getElementById('track-fill').style.width='0%';
            setTimeout(createOrder, 2000);
        }
        function goOffline() { state.isOnline = false; clearInterval(orderInterval); document.getElementById('active-order-view').style.display = 'none'; document.getElementById('offline-view').style.display = 'block'; resetSlider('offline'); saveGame(); }
        
        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            ['bike','bag','phone','gear'].forEach(k => updateBar(`bar-${k}`, state.items[k]));
            ['energy','water','mood'].forEach(k => updateBar(`bar-${k}`, state.needs[k]));
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv; document.getElementById('bag-count').style.display = totalInv ? 'flex' : 'none';
            document.getElementById('debt-warning').style.display = (state.debtOverdue && state.debt > 0) ? 'inline' : 'none';
            updateVisualStats();
        }
        function updateBar(id, val) { let pct = val < 0 ? 0 : (val > 100 ? 100 : val); document.getElementById(id).style.width = pct + '%'; }
        function updateVisualStats() {
            if(typeof state === 'undefined' || !state.items) return;
            const stats = { 'bike':state.items.bike, 'bag':state.items.bag, 'phone':state.items.phone, 'gear':state.items.gear, 'energy':state.needs.energy, 'water':state.needs.water, 'mood':state.needs.mood };
            for (let [key, val] of Object.entries(stats)) {
                const el = document.getElementById(`stat-${key}`);
                if(el) { const clean = Math.floor(val); el.textContent = clean + '%'; el.style.color = (clean < 0) ? '#ff3d00' : '#fff'; }
            }
        }

        // Sliders & Modals
        function initSliders() {
            setupSlider('offline', () => { state.isOnline = true; document.getElementById('offline-view').style.display = 'none'; startSearching(); });
            setupSlider('online', () => { if (state.isSearching) goOffline(); else { state.scheduledOffline = true; saveGame(); resetSlider('online'); } });
        }
        function setupSlider(p, cb) {
            const k = document.getElementById(`${p}-slider-knob`), b = document.getElementById(`${p}-slider-box`), f = document.getElementById(`${p}-slider-fill`);
            let d = false, s = 0;
            k.onmousedown=k.ontouchstart=e=>{d=true;s=(e.type==='mousedown'?e.clientX:e.touches[0].clientX);};
            document.onmousemove=document.ontouchmove=e=>{if(!d)return;let x=(e.type==='mousemove'?e.clientX:e.touches[0].clientX)-s;let max=b.offsetWidth-k.offsetWidth-8;x=Math.max(0,Math.min(x,max));k.style.transform=`translateX(${x}px)`;f.style.width=`${(x/max)*100}%`;if(x>=max*0.95){d=false;end();cb();}};
            document.onmouseup=document.ontouchend=end;
            function end(){d=false;k.style.transform='translateX(0)';f.style.width='0%';}
        }
        function resetSlider(p) { document.getElementById(`${p}-slider-knob`).style.transform = 'translateX(0)'; document.getElementById(`${p}-slider-fill`).style.width = '0%'; }
        
        function toggleQuickInv() { const m = document.getElementById('quick-inv'); m.style.display==='flex'?m.style.display='none':openQuickInv(); }
        function openQuickInv() {
            const m = document.getElementById('quick-inv'); m.innerHTML='';
            for(let [k,c] of Object.entries(state.inventory)) { if(c>0) { const d=document.createElement('div');d.className='inv-item';d.innerHTML=`<span><i class="fa-solid ${ITEMS_DB[k].icon}"></i> ${ITEMS_DB[k].name}</span> x${c}`;d.onclick=()=>useItem(k);m.appendChild(d); } }
            if(m.innerHTML==='') m.innerHTML='<div style="text-align:center;padding:5px;font-size:12px">–ü—É—Å—Ç–æ</div>';
            m.style.display='flex'; m.classList.add('open');
        }
        function useItem(k) { if(state.inventory[k]>0) { state.inventory[k]--; const eff=ITEMS_DB[k].effect; if(eff){if(eff.energy)state.needs.energy+=eff.energy;if(eff.water)state.needs.water+=eff.water;if(eff.mood)state.needs.mood+=eff.mood;} toggleQuickInv(); updateUI(); } }
        
        function toggleMenu() { document.getElementById('side-menu-overlay').classList.toggle('open'); document.getElementById('side-menu').classList.toggle('open'); }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }
        function openModal(t) { toggleMenu(); document.getElementById('full-modal').classList.add('open'); document.getElementById('modal-title').textContent = t==='shop'?'–ú–∞–≥–∞–∑–∏–Ω':(t==='bank'?'–ë–∞–Ω–∫':'–ò—Å—Ç–æ—Ä–∏—è'); if(t==='shop')renderShop(); }
        
        function renderShop() {
            const c = document.getElementById('modal-body'); c.innerHTML='';
            ['water','bar','energy_drink'].forEach(k=>{ const i=ITEMS_DB[k]; c.innerHTML+=`<div class="shop-card"><div><b>${i.name}</b><br><small>${i.desc}</small></div><button class="shop-btn buy" onclick="buyItem('${k}',${i.cost})">${i.cost}</button></div>`; });
            ['bike','bag'].forEach(k=>{ const i=ITEMS_DB[k]; c.innerHTML+=`<div class="shop-card"><div><b>${i.name}</b><br><small>–†–µ–º–æ–Ω—Ç</small></div><button class="shop-btn" onclick="repairItem('${k}',5)">5.00</button></div>`; });
        }
        function buyItem(k,c) { if(state.balance>=c){state.balance-=c;state.inventory[k]=(state.inventory[k]||0)+1;renderShop();updateUI();}else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn'); }
        function repairItem(k,c) { if(state.balance>=c){state.balance-=c;state.items[k]=100;renderShop();updateUI();}else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn'); }
        
        function closeAuthModal() { document.getElementById('auth-modal').style.display='none'; }
        function openAuthModal() { toggleMenu(); document.getElementById('auth-modal').style.display='flex'; }
        function updateAuthUI() { /* simplified */ }
        function updateMenuState() { /* simplified */ }
        function resetGame() { if(confirm('–°–±—Ä–æ—Å?')) { localStorage.removeItem(SAVE_KEY); location.reload(); } }

    init();
    </script>
    <script src="patches/design_update.js"></script>
</body>
</html>

