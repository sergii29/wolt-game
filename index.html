<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #00ccff;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff3d00;
            --accent-purple: #d500f9;
            --wolt-blue: #009de0;
            --modal-bg: #ffffff;
            --modal-text: #000000;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            user-select: none;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            filter: brightness(0.8) contrast(1.2);
        }

        /* --- TOP UI --- */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 1000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }

        .menu-btn, .stats-btn {
            background: white;
            color: black;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            pointer-events: auto;
            cursor: pointer;
            border: none;
        }

        .balance-display {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-amount {
            font-size: 18px;
            font-weight: 800;
            color: white;
        }

        .balance-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* --- BARS --- */
        .equip-bar {
            position: absolute;
            top: 70px;
            left: 15px;
            right: 15px;
            display: flex;
            gap: 6px;
            z-index: 999;
            pointer-events: none;
        }

        .equip-item {
            flex: 1;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            padding: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .equip-icon {
            font-size: 10px;
            margin-bottom: 2px;
            color: #ccc;
        }

        .progress-mini {
            width: 100%;
            height: 3px;
            background: #444;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-mini-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }

        /* --- NOTIFICATIONS --- */
        .game-toast {
            position: absolute;
            top: 140px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            border: 1px solid #333;
        }
        .game-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-warn { border-color: var(--accent-orange); color: var(--accent-orange); }
        .toast-success { border-color: var(--accent-green); color: var(--accent-green); }

        /* --- BOTTOM SHEET --- */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 20px;
            z-index: 1002;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            color: #333;
            transition: transform 0.3s;
        }

        .slider-container {
            position: relative;
            width: 100%;
            height: 60px;
            background: #f0f0f0;
            border-radius: 30px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; }
        .slider-knob {
            position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px;
            background: var(--wolt-blue); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; cursor: grab; z-index: 2;
        }
        .slider-fill {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
            background: rgba(0, 157, 224, 0.2); z-index: 0;
        }

        /* CONTROLS */
        .controls-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .pedal-btn {
            flex: 1;
            background: var(--wolt-blue);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 4px 0 #007bb5;
            transition: all 0.1s;
        }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; }

        .bag-btn {
            width: 60px;
            background: #f8f9fa;
            border: 2px solid #eee;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            position: relative;
        }
        .bag-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--accent-red); color: white;
            font-size: 10px; width: 18px; height: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        /* QUICK INVENTORY POPUP */
        .quick-inv {
            position: absolute;
            bottom: 90px; left: 20px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 12px;
            z-index: 1005;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 200px;
        }
        .quick-inv.open { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .inv-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;
            cursor: pointer;
        }
        .inv-item:active { background: rgba(255,255,255,0.2); }
        .inv-count { background: var(--wolt-blue); padding: 2px 6px; border-radius: 10px; font-size: 11px; }

        @keyframes popUp {
            from { opacity: 0; transform: translateY(10px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- SIDE MENU --- */
        #side-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu {
            position: absolute; top: 0; left: -85%; width: 85%; max-width: 320px; height: 100%;
            background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
        }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; }

        /* --- FULL MODAL --- */
        .full-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f5; color: black; z-index: 3000;
            transform: translateY(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* SHOP STYLES */
        .shop-section { margin-bottom: 20px; }
        .shop-section h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #666; }
        .shop-card {
            background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .shop-btn {
            padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 13px; cursor: pointer;
            border: 1px solid var(--wolt-blue); color: var(--wolt-blue); background: white;
        }
        .shop-btn.buy { background: var(--wolt-blue); color: white; }
        .shop-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å</div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            <div class="menu-item" onclick="resetGame()" style="color:red; margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0">–í–∞—Ä—à–∞–≤–∞</h3>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ x1.2 –∫ –æ–ø–ª–∞—Ç–µ</p>
            <div class="slider-container" id="slider-box">
                <div class="slider-fill" id="slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div><h3 style="margin:0" id="rest-name">Rest</h3><p style="margin:0; font-size:12px; color:#888" id="order-dest">Dest</p></div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--wolt-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--wolt-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--wolt-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–ï–¥–∞: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–°—Ç–∞—Ç—É—Å</span>
            </div>

            <div class="quick-inv" id="quick-inv">
                </div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó (PEDAL)</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA ---
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        
        const ITEMS_DB = {
            // Repairable
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt' },
            // Consumable
            water: { name: '–í–æ–¥–∞ 0.5–ª', type: 'buy', cost: 2.5, effect: { water: 30, energy: 5 }, icon: 'fa-bottle-water' },
            bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.0, effect: { energy: 25, mood: 5 }, icon: 'fa-cookie-bite' },
            energy_drink: { name: 'Red Bull', type: 'buy', cost: 6.5, effect: { energy: 50, mood: 10, water: -5 }, icon: 'fa-bolt' },
            coffee: { name: '–ö–æ—Ñ–µ', type: 'buy', cost: 8.0, effect: { mood: 20, energy: 10 }, icon: 'fa-mug-hot' }
        };

        let state = {
            balance: 0,
            isOnline: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 },
            needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 }, // Repair levels
            history: [],
            totalOrders: 0
        };

        const restaurants = [
            { name: "McDonald's", icon: "üçî", lat: 52.2297, lng: 21.0122 },
            { name: "KFC", icon: "üçó", lat: 52.2350, lng: 21.0050 },
            { name: "Pasibus", icon: "üçî", lat: 52.2310, lng: 21.0180 },
            { name: "Kebab King", icon: "üåØ", lat: 52.2400, lng: 21.0200 }
        ];

        let currentOrder = null;
        let map, courierMarker;

        // --- INIT ---
        function init() {
            // Map
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            courierMarker = L.marker([52.2297, 21.0122]).addTo(map);

            loadGame();
            
            // Listeners
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            setupSlider();
        }

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Migration check
                if (!state.needs.mood) state.needs.mood = 100;
                if (!state.inventory) state.inventory = { water: 0, bar: 0, energy_drink: 0, coffee: 0 };
            }
            updateUI();
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            
            updateBar('bar-bike', state.items.bike);
            updateBar('bar-bag', state.items.bag);
            updateBar('bar-phone', state.items.phone);
            updateBar('bar-gear', state.items.gear);
            updateBar('bar-energy', state.needs.energy);
            document.getElementById('bar-mood').style.width = state.needs.mood + '%';
            
            // Inventory count badge
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv;
            if (totalInv === 0) document.getElementById('bag-count').style.display = 'none';
            else document.getElementById('bag-count').style.display = 'flex';
        }

        function updateBar(id, val) {
            document.getElementById(id).style.width = val + '%';
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : (type==='success' ? 'toast-success' : ''));
            setTimeout(() => t.className = 'game-toast', 3000);
        }

        // --- GAMEPLAY: PEDAL LOGIC ---
        function pedal() {
            if (!currentOrder) return;
            
            // 1. Calculate Fatigue
            // Less energy = Slower speed
            // If Energy 100 -> Factor 1.0. If Energy 10 -> Factor 0.2
            let fatigueFactor = Math.max(0.2, state.needs.energy / 100); 
            
            // 2. Base Cost
            const energyCost = 0.8; 
            const moodCost = 0.1;

            if (state.needs.energy <= 5) {
                showToast('<i class="fa-solid fa-triangle-exclamation"></i> –°–∏–ª –Ω–µ—Ç! –°—ä–µ—à—å —á—Ç–æ-–Ω–∏–±—É–¥—å!', 'warn');
                openQuickInv(); // Auto open hints
                return;
            }

            // 3. Apply Costs
            state.needs.energy -= energyCost;
            state.needs.mood -= moodCost;
            state.items.bike -= 0.1;

            // 4. Progress Math
            // Base speed 4%. Multiplied by fatigue.
            let progressStep = 4 * fatigueFactor; 
            
            currentOrder.progress += progressStep;
            
            // Food temp decay
            currentOrder.foodTemp -= 0.15;

            // 5. Visuals
            updateTrack(currentOrder.progress);
            document.getElementById('temp-val').textContent = Math.floor(currentOrder.foodTemp) + '%';
            
            if (currentOrder.progress >= 100) nextStage();
            
            saveGame();
            updateUI();
        }

        function nextStage() {
            currentOrder.stage++;
            currentOrder.progress = 0;
            updateTrack(0);

            if (currentOrder.stage === 1) {
                // Wait at restaurant
                setBtnState(true, '–ñ–î–ï–ú –ó–ê–ö–ê–ó...');
                document.getElementById('status-label').textContent = '–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç...';
                
                setTimeout(() => {
                    setBtnState(false, '–ñ–ú–ò –ì–ê–ó (PEDAL)');
                    document.getElementById('status-label').textContent = '–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç—É';
                    currentOrder.stage = 2;
                }, 2000);
            } else if (currentOrder.stage === 3) {
                completeOrder();
            }
        }

        function setBtnState(disabled, text) {
            const btn = document.getElementById('pedal-btn');
            btn.disabled = disabled;
            btn.textContent = text;
        }

        function completeOrder() {
            let pay = 12 + (Math.random() * 5);
            // Mood bonus
            if (state.needs.mood > 80 && Math.random() > 0.5) {
                pay += 5;
                showToast('–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω –≤–∞—à–∏–º –ø–æ–∑–∏—Ç–∏–≤–æ–º! +–ß–∞–µ–≤—ã–µ', 'success');
            }
            
            state.balance += pay;
            state.history.push({ rest: currentOrder.rest.name, earn: pay.toFixed(2) });
            
            currentOrder = null;
            setBtnState(true, '–ü–û–ò–°–ö...');
            document.getElementById('active-order-view').style.display = 'none';
            document.getElementById('offline-view').style.display = 'block';
            state.isOnline = false; // Reset for loop
            resetSlider();
            
            showToast(`–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! +${pay.toFixed(2)} PLN`, 'success');
            saveGame();
            updateUI();
        }

        // --- INVENTORY SYSTEM ---
        function toggleQuickInv() {
            const menu = document.getElementById('quick-inv');
            const isOpen = menu.style.display === 'flex';
            
            if (isOpen) {
                menu.style.display = 'none';
            } else {
                openQuickInv();
            }
        }

        function openQuickInv() {
            const menu = document.getElementById('quick-inv');
            menu.innerHTML = '';
            
            let hasItems = false;
            for (let [key, count] of Object.entries(state.inventory)) {
                if (count > 0) {
                    hasItems = true;
                    const itemData = ITEMS_DB[key];
                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.innerHTML = `
                        <span><i class="fa-solid ${itemData.icon}"></i> ${itemData.name}</span>
                        <span class="inv-count">x${count}</span>
                    `;
                    div.onclick = () => useItem(key);
                    menu.appendChild(div);
                }
            }
            
            if (!hasItems) {
                menu.innerHTML = '<div style="padding:5px; color:#888; font-size:12px; text-align:center">–†—é–∫–∑–∞–∫ –ø—É—Å—Ç.<br>–ö—É–ø–∏—Ç–µ –µ–¥—É –≤ –º–∞–≥–∞–∑–∏–Ω–µ.</div>';
            }
            
            menu.style.display = 'flex';
            menu.classList.add('open');
        }

        function useItem(key) {
            if (state.inventory[key] <= 0) return;
            
            const item = ITEMS_DB[key];
            state.inventory[key]--;
            
            // Apply effects
            if (item.effect.energy) state.needs.energy = Math.min(100, state.needs.energy + item.effect.energy);
            if (item.effect.water) state.needs.water = Math.min(100, state.needs.water + item.effect.water);
            if (item.effect.mood) state.needs.mood = Math.min(100, state.needs.mood + item.effect.mood);
            
            showToast(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${item.name}`, 'success');
            toggleQuickInv(); // Close menu
            saveGame();
            updateUI();
        }

        // --- SHOP & MODALS ---
        function toggleMenu() {
            const el = document.getElementById('side-menu-overlay');
            const menu = document.getElementById('side-menu');
            el.classList.toggle('open');
            menu.classList.toggle('open');
        }

        function openModal(type) {
            toggleMenu(); // Close sidebar
            document.getElementById('full-modal').classList.add('open');
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');
            
            if (type === 'shop') {
                title.textContent = '–ú–∞–≥–∞–∑–∏–Ω –∏ –°–µ—Ä–≤–∏—Å';
                renderShop(body);
            } else {
                title.textContent = '–ò—Å—Ç–æ—Ä–∏—è';
                renderHistory(body);
            }
        }

        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }

        function renderShop(container) {
            container.innerHTML = '';
            
            // 1. Repair Section
            let html = '<div class="shop-section"><h3>üõ† –°–µ—Ä–≤–∏—Å (–†–µ–º–æ–Ω—Ç)</h3>';
            ['bike', 'bag', 'phone', 'gear'].forEach(key => {
                const item = ITEMS_DB[key];
                const level = state.repairs[key] || 0;
                const cost = item.baseCost + (level * 0.5);
                const current = Math.floor(state.items[key]);
                
                html += `
                <div class="shop-card">
                    <div>
                        <div style="font-weight:bold"><i class="fa-solid ${item.icon}"></i> ${item.name}</div>
                        <div style="font-size:12px; color:#666">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${current}%</div>
                    </div>
                    <button class="shop-btn" onclick="buyRepair('${key}', ${cost})">–ü–æ—á–∏–Ω–∏—Ç—å ${cost.toFixed(1)}</button>
                </div>`;
            });
            html += '</div>';

            // 2. Market Section
            html += '<div class="shop-section"><h3>üéí –°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç (–ï–¥–∞ —Å —Å–æ–±–æ–π)</h3>';
            ['water', 'bar', 'energy_drink', 'coffee'].forEach(key => {
                const item = ITEMS_DB[key];
                const owned = state.inventory[key] || 0;
                html += `
                <div class="shop-card">
                    <div>
                        <div style="font-weight:bold"><i class="fa-solid ${item.icon}"></i> ${item.name}</div>
                        <div style="font-size:12px; color:#666">–í —Ä—é–∫–∑–∞–∫–µ: ${owned} —à—Ç.</div>
                    </div>
                    <button class="shop-btn buy" onclick="buyItem('${key}')">–ö—É–ø–∏—Ç—å ${item.cost.toFixed(1)}</button>
                </div>`;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function buyRepair(key, cost) {
            if (state.balance >= cost && state.items[key] < 100) {
                state.balance -= cost;
                state.items[key] = 100;
                state.repairs[key] = (state.repairs[key] || 0) + 1;
                showToast('–ü–æ—á–∏–Ω–∏–ª–∏!', 'success');
                saveGame(); updateUI(); renderShop(document.getElementById('modal-body'));
            } else if (state.items[key] >= 100) {
                showToast('–≠—Ç–æ –∏ —Ç–∞–∫ –Ω–æ–≤–æ–µ');
            } else {
                showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn');
            }
        }

        function buyItem(key) {
            const item = ITEMS_DB[key];
            if (state.balance >= item.cost) {
                state.balance -= item.cost;
                state.inventory[key] = (state.inventory[key] || 0) + 1;
                showToast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, 'success');
                saveGame(); updateUI(); renderShop(document.getElementById('modal-body'));
            } else {
                showToast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥', 'warn');
            }
        }

        function renderHistory(container) {
            if (!state.history.length) { container.innerHTML = '–ü—É—Å—Ç–æ'; return; }
            container.innerHTML = state.history.slice().reverse().map(h => 
                `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between">
                    <b>${h.rest}</b> <span style="color:green">+${h.earn} PLN</span>
                </div>`
            ).join('');
        }

        // --- SLIDER UTILS ---
        let isDragging = false, startX;
        const sliderKnob = document.getElementById('slider-knob');
        const sliderBox = document.getElementById('slider-box');

        function setupSlider() {
            sliderKnob.addEventListener('mousedown', startDrag);
            sliderKnob.addEventListener('touchstart', startDrag);
            
            function startDrag(e) {
                isDragging = true;
                startX = (e.type==='mousedown') ? e.clientX : e.touches[0].clientX;
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('touchmove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);
            }
            function onDrag(e) {
                if(!isDragging) return;
                const cx = (e.type==='mousemove') ? e.clientX : e.touches[0].clientX;
                let dx = cx - startX;
                let max = sliderBox.offsetWidth - sliderKnob.offsetWidth - 8;
                dx = Math.max(0, Math.min(dx, max));
                sliderKnob.style.transform = `translateX(${dx}px)`;
                document.getElementById('slider-fill').style.width = `${(dx/max)*100}%`;
                if(dx >= max*0.9) { goOnline(); stopDrag(); }
            }
            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
                if(!state.isOnline) resetSlider();
            }
        }

        function resetSlider() {
            sliderKnob.style.transform = 'translateX(0)';
            document.getElementById('slider-fill').style.width = '0%';
        }

        function goOnline() {
            state.isOnline = true;
            document.getElementById('offline-view').style.display = 'none';
            document.getElementById('active-order-view').style.display = 'flex';
            setTimeout(createOrder, 1000);
        }

        function createOrder() {
            const r = restaurants[Math.floor(Math.random() * restaurants.length)];
            currentOrder = { rest: r, progress: 0, stage: 0, foodTemp: 100, max: 100 };
            document.getElementById('rest-name').textContent = r.name;
            document.getElementById('rest-icon').textContent = r.icon;
            document.getElementById('status-label').textContent = '–ï–¥–µ–º –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω';
            setBtnState(false, '–ñ–ú–ò –ì–ê–ó (PEDAL)');
            updateTrack(0);
        }

        function updateTrack(p) {
            document.getElementById('track-fill').style.width = p + '%';
            document.getElementById('track-icon').style.left = p + '%';
        }

        function resetGame() {
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        // Start
        init();
    </script>
</body>
</html>
