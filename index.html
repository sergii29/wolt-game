<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –°–¢–ò–õ–ò (CSS) –í–ù–£–¢–†–ò */
        :root { --bg-dark: #1a1a1a; --text-primary: #ffffff; --text-secondary: #a0a0a0; --accent-blue: #00ccff; --accent-green: #00e676; --accent-orange: #ff9100; --accent-red: #ff3d00; --wolt-blue: #009de0; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); user-select: none; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; filter: brightness(0.8) contrast(1.2); }
        
        /* UI */
        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; pointer-events: auto; cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .balance-display { background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .debt-warning { color: var(--accent-red); font-size: 10px; font-weight: bold; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* BARS */
        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; color: #888; font-weight: 700; }

        /* INTERFACE */
        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); color: #333; }
        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-top: 10px; }
        .slider-text { color: #999; font-weight: 600; z-index: 1; text-transform: uppercase; font-size: 14px; }
        .slider-knob { position: absolute; left: 4px; width: 52px; height: 52px; background: var(--wolt-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: grab; z-index: 2; transition: transform 0.1s; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 157, 224, 0.2); z-index: 0; }
        .slider-container.scheduled { background: #ffebee; } .slider-container.scheduled .slider-knob { background: var(--accent-red); } .slider-container.scheduled .slider-text { color: var(--accent-red); }

        .controls-row { display: flex; gap: 10px; margin-top: 15px; }
        .pedal-btn { flex: 1; background: var(--wolt-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 0 #007bb5; transition: all 0.1s; }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; cursor: not-allowed; }
        .pedal-btn.blocked { background: var(--accent-orange); box-shadow: 0 4px 0 #e65100; cursor: not-allowed; }
        
        .bag-btn { width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; position: relative; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* MENUS */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; align-items: center; }
        
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* SHOP, BANK, NOTIFICATIONS */
        .shop-card { background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .shop-btn { padding: 8px 14px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; border: 1px solid var(--wolt-blue); color: var(--wolt-blue); background: white; min-width: 80px; transition: 0.2s; }
        .shop-btn.buy { background: var(--wolt-blue); color: white; }
        .shop-btn.bought { background: var(--accent-green); border-color: var(--accent-green); color: white; transform: scale(1.05); }
        .shop-btn:disabled { background: #eee; color: #aaa; border: 1px solid #eee; cursor: not-allowed; }
        .govt-btn { background: #37474f; color: white; border-color: #37474f; }

        .bank-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 24px; font-weight: bold; margin-bottom: 15px; box-sizing: border-box; }
        .bank-actions { display: flex; gap: 10px; }
        .bank-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-loan { background: var(--accent-green); color: #004d40; }
        .btn-repay { background: var(--accent-orange); color: #3e2723; }
        .debt-alert-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ef9a9a; display: none; }

        .quick-inv { position: absolute; bottom: 90px; left: 20px; width: 220px; background: #252525; color: white; padding: 10px; border-radius: 16px; z-index: 1005; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; }
        .inv-count { background: var(--wolt-blue); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        
        .game-toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap; }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-warn { border:1px solid var(--accent-orange); color: var(--accent-orange); }
        .toast-success { border:1px solid var(--accent-green); color: var(--accent-green); }

        .accept-timer-bg { width: 100%; height: 6px; background: #eee; margin-top: 8px; border-radius: 3px; overflow: hidden; display: none; }
        .accept-timer-fill { height: 100%; background: var(--accent-red); width: 100%; }
        @keyframes shrinkTimer { from { width: 100%; } to { width: 0%; } }
        .animate-timer { animation: shrinkTimer 15s linear forwards; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å <span id="debt-warning" class="debt-warning">(–î–û–õ–ì!)</span></div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div><span class="equip-label">–í–ï–õ</span></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label">–°–£–ú–ö–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label">–û–î–ï–ñ–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label">–°–ò–õ–´</span></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px; color:white">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store" style="color:var(--wolt-blue)"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns" style="color:var(--accent-green)"></i> –ë–∞–Ω–∫ / –ö—Ä–µ–¥–∏—Ç</div>
            <div class="menu-item" onclick="openModal('deflation')"><i class="fa-solid fa-scale-unbalanced-flip" style="color:#90a4ae"></i> –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            <div class="menu-item" onclick="resetGame()" style="color:var(--accent-red); margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0">–í–∞—Ä—à–∞–≤–∞</h3>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ò–Ω—Ñ–ª—è—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω–∞</p>
            <div class="slider-container" id="offline-slider-box">
                <div class="slider-fill" id="offline-slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="offline-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div style="flex:1">
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <p style="margin:0; font-size:12px; color:#888" id="order-dest">–û–∂–∏–¥–∞–Ω–∏–µ</p>
                        <span id="delivery-timer" style="font-size:11px; font-weight:bold; color:#666"></span>
                    </div>
                    <div class="accept-timer-bg" id="accept-timer"><div class="accept-timer-fill" id="accept-timer-fill"></div></div>
                </div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--wolt-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--wolt-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--wolt-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–ï–¥–∞: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–ü–æ–∏—Å–∫...</span>
            </div>

            <div class="slider-container" id="online-slider-box">
                <div class="slider-fill" id="online-slider-fill"></div>
                <div class="slider-text" id="online-slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="online-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count" style="display:none">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó (PEDAL)</button>
            </div>
            <div id="garnishment-info" style="font-size:11px; color:var(--accent-red); text-align:center; display:none">–ë—É–¥–µ—Ç —É–¥–µ—Ä–∂–∞–Ω–æ 20% –≤ —Å—á–µ—Ç –¥–æ–ª–≥–∞</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 1. –ö–û–ù–§–ò–ì FIREBASE (–í—à–∏—Ç —Å—é–¥–∞)
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };
        try { firebase.initializeApp(firebaseConfig); window.db = firebase.database(); console.log("DB OK"); } 
        catch(e) { console.log("DB Error", e); }

        // 2. –õ–û–ì–ò–ö–ê
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        let tg = window.Telegram.WebApp;
        tg.expand();
        let userId = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id.toString() : (localStorage.getItem('wolt_user_id') || 'user_' + Math.floor(Math.random()*100000));
        if (!tg.initDataUnsafe.user) localStorage.setItem('wolt_user_id', userId);

        let GLOBAL = { basePay: 12, inflationRate: 0.05, penaltyLate: 5.00, energyCost: 0.15, eventChance: 0.1, priceMult: 1.0 };
        const ITEMS_DB = {
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt' },
            water: { name: '–í–æ–¥–∞ (0.5–ª)', type: 'buy', cost: 2.0, effect: {water:35, energy:5}, icon: 'fa-bottle-water', target:'water' },
            bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.5, effect: {energy:20, mood:15}, icon: 'fa-cookie-bite', target:'energy' },
            energy_drink: { name: 'Red Bull', type: 'buy', cost: 7.0, effect: {energy:50, mood:5, water:-5}, icon: 'fa-bolt', target:'energy' },
            coffee: { name: '–õ–∞—Ç—Ç–µ', type: 'buy', cost: 9.0, effect: {mood:30, energy:10}, icon: 'fa-mug-hot', target:'mood' }
        };

        let state = { name: (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.first_name : "–ì–æ—Å—Ç—å", balance: 0, debt: 0, debtTimer: 0, debtOverdue: false, isBanned: false, isOnline: false, isSearching: false, scheduledOffline: false, items: { bike: 100, bag: 100, phone: 100, gear: 100 }, needs: { energy: 100, water: 100, mood: 100 }, inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0 }, repairs: { bike: 0, bag: 0, phone: 0, gear: 0 }, history: [] };
        let currentOrder = null; let acceptTimeout, orderInterval, map, searchTimeout;

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            L.marker([52.2297, 21.0122]).addTo(map);
            loadGame(); initSliders(); document.getElementById('pedal-btn').addEventListener('click', pedal); setInterval(checkDebt, 1000);
            if (window.db) {
                db.ref('users/' + userId).on('value', snap => {
                    const val = snap.val();
                    if (val) {
                        if (val.isBanned) { localStorage.clear(); location.reload(); }
                        if (val.adminEdit) { 
                            if(val.balance !== undefined) state.balance = val.balance;
                            if(val.inventory) state.inventory = val.inventory;
                            if(val.repairs) state.repairs = val.repairs;
                            if(val.needs) state.needs = val.needs;
                            if(val.debt !== undefined) state.debt = val.debt;
                            showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!', 'success'); db.ref('users/'+userId+'/adminEdit').set(false); updateUI(); 
                        }
                    }
                });
                db.ref('config').on('value', snap => { const c = snap.val(); if(c) GLOBAL = {...GLOBAL, ...c}; });
                syncToCloud(); setInterval(syncToCloud, 5000);
            }
        }

        function loadGame() { const s = localStorage.getItem(SAVE_KEY); if (s) state = { ...state, ...JSON.parse(s) }; state.scheduledOffline = false; state.isSearching = false; updateUI(); }
        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); syncToCloud(); }
        function syncToCloud() { if(window.db) db.ref('users/' + userId).update({ name: state.name, balance: state.balance, debt: state.debt, items: state.items, needs: state.needs, isOnline: state.isOnline, repairs: state.repairs, history: state.history, lastActive: Date.now() }); }

        function checkDebt() {
            if (state.debt > 0 && !state.debtOverdue) {
                if (Date.now() > state.debtTimer) { state.debtOverdue = true; showToast('–°–†–û–ö –í–´–®–ï–õ! –®–¢–†–ê–§ 20%', 'warn'); updateUI(); if(document.getElementById('full-modal').classList.contains('open')) renderBank(document.getElementById('modal-body')); }
                else if(document.getElementById('full-modal').classList.contains('open')) renderBank(document.getElementById('modal-body'));
            }
        }

        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            ['bike','bag','phone','gear'].forEach(k => document.getElementById(`bar-${k}`).style.width = state.items[k] + '%');
            ['energy','water','mood'].forEach(k => document.getElementById(`bar-${k}`).style.width = state.needs[k] + '%');
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv; document.getElementById('bag-count').style.display = totalInv ? 'flex' : 'none';
            const warn = document.getElementById('debt-warning'); const garn = document.getElementById('garnishment-info');
            if (state.debtOverdue && state.debt > 0) { warn.style.display = 'inline'; garn.style.display = 'block'; } else { warn.style.display = 'none'; garn.style.display = 'none'; }
        }

        function showToast(msg, type='info') { const t = document.getElementById('toast'); t.innerHTML = msg; t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : (type==='success' ? 'toast-success' : '')); setTimeout(() => t.className = 'game-toast', 3000); }

        function startSearching() {
            stopOrderLoop(); if(searchTimeout) clearTimeout(searchTimeout); state.isSearching = true;
            document.getElementById('active-order-view').style.display = 'flex';
            document.getElementById('rest-name').textContent = '–ü–æ–∏—Å–∫...'; document.getElementById('rest-icon').textContent = 'üîç';
            document.getElementById('status-label').textContent = '–ò—â–µ–º –∑–∞–∫–∞–∑...'; document.getElementById('order-dest').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            document.getElementById('accept-timer').style.display = 'none'; document.getElementById('delivery-timer').textContent = '';
            const btn = document.getElementById('pedal-btn'); btn.disabled = true; btn.textContent = '–ü–û–ò–°–ö...'; btn.className = 'pedal-btn';
            resetSlider('online'); document.getElementById('online-slider-text').textContent = "–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê"; document.getElementById('online-slider-box').classList.remove('scheduled');
            updateTrack(0);
            searchTimeout = setTimeout(() => { if (state.isOnline && state.isSearching) createOrder(); }, 1500);
        }

        function createOrder() {
            state.isSearching = false; const restaurants = [{name:"McDonald's",icon:"üçî"},{name:"KFC",icon:"üçó"},{name:"Pasibus",icon:"üçî"},{name:"Kebab King",icon:"üåØ"},{name:"Sushi Master",icon:"üç£"},{name:"Pizza Hut",icon:"üçï"}];
            const r = restaurants[Math.floor(Math.random() * restaurants.length)];
            currentOrder = { rest: r, progress: 0, stage: 0, foodTemp: 100, accepted: false, timeLeft: 60, tempWarned: false };
            document.getElementById('rest-name').textContent = `–ï–¥–µ–º –≤ ${r.name}`; document.getElementById('rest-icon').textContent = r.icon;
            document.getElementById('status-label').textContent = 'üî• –ü–†–ò–ú–ò –ó–ê–ö–ê–ó! üî•'; document.getElementById('order-dest').textContent = '–ó–∞–±—Ä–∞—Ç—å: 2.5 km';
            const btn = document.getElementById('pedal-btn'); btn.textContent = '–ü–†–ò–ù–Ø–¢–¨ –ó–ê–ö–ê–ó'; btn.disabled = false;
            const bar = document.getElementById('accept-timer'); const fill = document.getElementById('accept-timer-fill');
            bar.style.display = 'block'; fill.classList.remove('animate-timer'); void fill.offsetWidth; fill.classList.add('animate-timer');
            acceptTimeout = setTimeout(missOrder, 15000); resetSlider('online'); document.getElementById('online-slider-text').textContent = "–ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–¢–¨ –û–§–õ–ê–ô–ù";
        }

        function pedal() {
            if (!currentOrder) return;
            if (!currentOrder.accepted) { acceptOrder(); return; }
            let fatigue = Math.max(0.3, state.needs.energy / 100);
            if (state.needs.energy <= 5 || state.needs.water <= 5) { showToast('–°–∏–ª –Ω–µ—Ç! –û—Ç–∫—Ä–æ–π —Ä—é–∫–∑–∞–∫!', 'warn'); openQuickInv(true); return; }
            state.needs.energy -= GLOBAL.energyCost; state.needs.water -= 0.10; state.needs.mood -= 0.05; state.items.bike -= 0.1; state.items.phone -= 0.05;
            currentOrder.progress += (5 * fatigue); updateTrack(currentOrder.progress);
            if (Math.random() < (GLOBAL.eventChance || 0.1) && currentOrder.stage === 2) triggerRandomEvent();
            if (currentOrder.progress >= 100) nextStage();
            saveGame(); updateUI();
        }

        function acceptOrder() { currentOrder.accepted = true; clearTimeout(acceptTimeout); document.getElementById('accept-timer').style.display = 'none'; document.getElementById('pedal-btn').textContent = '–ñ–ú–ò –ì–ê–ó (PEDAL)'; startOrderLoop(); }
        function missOrder() { state.isSearching = true; currentOrder = null; state.balance -= GLOBAL.penaltyMiss || 0.10; showToast('–ó–∞–∫–∞–∑ —É–ø—É—â–µ–Ω! –®—Ç—Ä–∞—Ñ -0.10 PLN', 'warn'); saveGame(); updateUI(); startSearching(); }
        function nextStage() { currentOrder.stage++; currentOrder.progress = 0; updateTrack(0); if (currentOrder.stage === 1) { const btn = document.getElementById('pedal-btn'); btn.disabled = true; btn.textContent = '–ñ–î–ï–ú –ó–ê–ö–ê–ó...'; document.getElementById('status-label').textContent = '–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç...'; setTimeout(() => { btn.disabled = false; btn.textContent = '–ñ–ú–ò –ì–ê–ó (PEDAL)'; document.getElementById('status-label').textContent = '–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç—É'; currentOrder.stage = 2; }, 2000); } else if (currentOrder.stage === 3) completeOrder(); }
        
        function completeOrder() {
            stopOrderLoop(); const lvl = Object.values(state.repairs).reduce((a,b)=>a+b,0); const inf = 1 + (lvl * GLOBAL.inflationRate);
            let pay = (GLOBAL.basePay + (Math.random() * 6)) * inf; let tip = 0;
            if (currentOrder.foodTemp > 60 && Math.random() > 0.5) tip += (2 + Math.random()*3) * inf;
            if (state.needs.mood > 80 && currentOrder.foodTemp > 40 && Math.random() > 0.3) tip += 3 * inf;
            if (tip > 0) { pay += tip; showToast(`üëç –î–æ—Å—Ç–∞–≤–∫–∞! +${tip.toFixed(2)} —á–∞–π`, 'success'); } else if (currentOrder.foodTemp < 50) showToast('–ï–¥–∞ –æ—Å—Ç—ã–ª–∞... –ë–µ–∑ —á–∞–µ–≤—ã—Ö.', 'warn');
            state.items.bag -= 1.5; state.items.gear -= 0.8;
            if (state.debtOverdue && state.debt > 0) { let p = pay * 0.20; if (p > state.debt) p = state.debt; state.debt -= p; pay -= p; showToast(`–î–æ–ª–≥: -${p.toFixed(2)} PLN`, 'warn'); }
            state.balance += pay; state.history.push({ rest: currentOrder.rest.name, earn: pay.toFixed(2) });
            setTimeout(() => { showToast(`–ó–∞–∫–∞–∑: +${pay.toFixed(2)} PLN`, 'success'); }, 500);
            if (state.scheduledOffline) { goOffline(); } else { startSearching(); } saveGame(); updateUI();
        }

        function startOrderLoop() { if(orderInterval) clearInterval(orderInterval); orderInterval = setInterval(() => { if (!currentOrder || !currentOrder.accepted) return; currentOrder.timeLeft--; document.getElementById('delivery-timer').textContent = `‚è± ${currentOrder.timeLeft}—Å`; if (currentOrder.timeLeft <= 0) { failOrder("time"); return; } let decay = 0.5 * (1 + ((100 - state.items.bag) / 100)); currentOrder.foodTemp -= decay; document.getElementById('temp-val').textContent = Math.floor(currentOrder.foodTemp) + '%'; if (currentOrder.foodTemp <= 0) { failOrder("cold"); return; } }, 1000); }
        function stopOrderLoop() { if (orderInterval) clearInterval(orderInterval); orderInterval = null; document.getElementById('delivery-timer').textContent = ''; }
        function failOrder(reason) { stopOrderLoop(); let msg = reason === "time" ? "‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!" : "‚ùÑÔ∏è –ï–¥–∞ –∏—Å–ø–æ—Ä—á–µ–Ω–∞!"; showToast(`${msg} –®—Ç—Ä–∞—Ñ -${GLOBAL.penaltyLate} PLN`, 'warn'); state.balance -= GLOBAL.penaltyLate; currentOrder = null; saveGame(); updateUI(); startSearching(); }
        function triggerRandomEvent() { const btn = document.getElementById('pedal-btn'); const evs = [{t:"üöß –ü–†–û–ë–ö–ê!",d:3000},{t:"üö¶ –°–í–ï–¢–û–§–û–†",d:2000},{t:"üöï –û–ë–™–ï–ó–î",d:4000}]; const e = evs[Math.floor(Math.random()*evs.length)]; btn.disabled = true; btn.classList.add('blocked'); btn.textContent = e.t; showToast('–ó–∞–¥–µ—Ä–∂–∫–∞! –ï–¥–∞ –æ—Å—Ç—ã–≤–∞–µ—Ç!', 'warn'); setTimeout(() => { if (currentOrder) { btn.disabled = false; btn.classList.remove('blocked'); btn.textContent = '–ñ–ú–ò –ì–ê–ó (PEDAL)'; } }, e.d); }
        function goOffline() { state.isOnline = false; state.isSearching = false; state.scheduledOffline = false; stopOrderLoop(); if (acceptTimeout) clearTimeout(acceptTimeout); document.getElementById('active-order-view').style.display = 'none'; document.getElementById('offline-view').style.display = 'block'; resetSlider('offline'); saveGame(); }

        // SLIDERS
        function initSliders() { setupSlider('offline', () => { state.isOnline = true; document.getElementById('offline-view').style.display = 'none'; startSearching(); }); setupSlider('online', () => { if (state.isSearching) { goOffline(); } else { state.scheduledOffline = true; document.getElementById('online-slider-box').classList.add('scheduled'); document.getElementById('online-slider-text').textContent = "–û–§–õ–ê–ô–ù –ü–û–°–õ–ï –ó–ê–ö–ê–ó–ê"; resetSlider('online'); } }); }
        function setupSlider(prefix, cb) { const k = document.getElementById(`${prefix}-slider-knob`); const b = document.getElementById(`${prefix}-slider-box`); const f = document.getElementById(`${prefix}-slider-fill`); let drag = false, sx = 0; k.addEventListener('touchstart', e => { drag=true; sx=e.touches[0].clientX; }); document.addEventListener('touchmove', e => { if(!drag)return; let x = e.touches[0].clientX-sx; let max = b.offsetWidth-k.offsetWidth-8; x=Math.max(0,Math.min(x,max)); k.style.transform=`translateX(${x}px)`; f.style.width=`${(x/max)*100}%`; if(x>=max*0.95){ drag=false; k.style.transform='translateX(0)'; f.style.width='0%'; cb(); } }); document.addEventListener('touchend', () => { drag=false; k.style.transform='translateX(0)'; f.style.width='0%'; }); /* Mouse support removed for brevity, mobile focused */ }
        function resetSlider(p) { document.getElementById(`${p}-slider-knob`).style.transform='translateX(0)'; document.getElementById(`${p}-slider-fill`).style.width='0%'; }
        function updateTrack(p) { document.getElementById('track-fill').style.width=p+'%'; document.getElementById('track-icon').style.left=p+'%'; }

        // MODALS
        function toggleMenu() { document.getElementById('side-menu-overlay').classList.toggle('open'); document.getElementById('side-menu').classList.toggle('open'); }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }
        function openModal(type) { toggleMenu(); document.getElementById('full-modal').classList.add('open'); const c = document.getElementById('modal-body'); document.getElementById('modal-title').textContent = type.toUpperCase(); if(type==='shop') renderShop(c); else if(type==='bank') renderBank(c); else if(type==='deflation') renderDeflation(c); else renderHistory(c); }
        
        function renderShop(c) {
            let h = ''; const lvl = Object.values(state.repairs).reduce((a,b)=>a+b,0); const inf = (1 + lvl*GLOBAL.inflationRate) * (GLOBAL.priceMult||1);
            h += '<h3>–ï–¥–∞</h3>'; ['water','bar','energy_drink','coffee'].forEach(k => { const p = ITEMS_DB[k].cost*inf; h+=`<div class="shop-card"><div><b>${ITEMS_DB[k].name}</b><br><small>${state.inventory[k]} —à—Ç</small></div><button class="shop-btn buy" onclick="buyItem('${k}',${p},this)">${p.toFixed(1)}</button></div>`; });
            h += '<h3>–†–µ–º–æ–Ω—Ç</h3>'; ['bike','bag','phone','gear'].forEach(k => { const p = (ITEMS_DB[k].baseCost + (state.repairs[k]||0)*0.5)*inf; const broken = state.items[k]<=0; h+=`<div class="shop-card"><div><b>${ITEMS_DB[k].name}</b><br><small>${Math.floor(state.items[k])}%</small></div><button class="shop-btn" ${broken?'':'disabled'} onclick="buyRepair('${k}',${p},this)">${broken?p.toFixed(1):'OK'}</button></div>`; });
            c.innerHTML = h;
        }
        function buyItem(k,p,btn) { if(state.balance>=p){state.balance-=p; state.inventory[k]++; btn.textContent="OK"; setTimeout(()=>renderShop(document.getElementById('modal-body')),500); saveGame(); updateUI();} else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn'); }
        function buyRepair(k,p,btn) { if(state.balance>=p){state.balance-=p; state.items[k]=100; state.repairs[k]++; btn.textContent="OK"; setTimeout(()=>renderShop(document.getElementById('modal-body')),500); saveGame(); updateUI();} else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn'); }
        
        function renderBank(c) {
            let t = "00:00"; if(state.debt>0 && !state.debtOverdue) { let d = state.debtTimer-Date.now(); t = `${Math.floor(d/60000)}:${Math.floor((d%60000)/1000)}`; }
            c.innerHTML = `<div style="text-align:center;padding:20px"><h2>–î–æ–ª–≥: ${state.debt.toFixed(2)}</h2><p style="color:${state.debtOverdue?'red':'green'}">${state.debtOverdue?'–ü–†–û–°–†–û–ß–ï–ù–û!':t}</p><input id="loan-in" type="number" class="bank-input" placeholder="–°—É–º–º–∞"><div class="bank-actions"><button class="bank-btn btn-loan" onclick="takeLoan()">–í–ó–Ø–¢–¨</button>${state.debt>0?'<button class="bank-btn btn-repay" onclick="repayLoan()">–í–ï–†–ù–£–¢–¨</button>':''}</div></div>`;
        }
        function takeLoan(){ const v=parseFloat(document.getElementById('loan-in').value); if(v>0){ state.balance+=v; state.debt+=v; state.debtTimer=Date.now()+300000; state.debtOverdue=false; saveGame(); updateUI(); renderBank(document.getElementById('modal-body')); } }
        function repayLoan(){ const v=parseFloat(document.getElementById('loan-in').value); if(v>0 && state.balance>=v){ let p=Math.min(v,state.debt); state.balance-=p; state.debt-=p; if(state.debt<=0){state.debt=0;state.debtOverdue=false;} saveGame(); updateUI(); renderBank(document.getElementById('modal-body')); } }

        function renderDeflation(c) { const inf = 1 + Object.values(state.repairs).reduce((a,b)=>a+b,0)*GLOBAL.inflationRate; c.innerHTML = `<div style="text-align:center"><h2>–ò–Ω—Ñ–ª—è—Ü–∏—è: ${((inf-1)*100).toFixed(0)}%</h2><button class="shop-btn govt-btn" onclick="deflate(1, ${2700*inf})">üìâ -1 –£—Ä (${(2700*inf).toFixed(0)})</button><br><br><button class="shop-btn govt-btn" onclick="deflate(2, ${5000*inf})">üìâ -2 –£—Ä (${(5000*inf).toFixed(0)})</button></div>`; }
        function deflate(l,p) { if(state.balance>=p){ state.balance-=p; for(let i=0;i<l;i++){ const k=Object.keys(state.repairs).find(x=>state.repairs[x]>0); if(k) state.repairs[k]--; } saveGame(); updateUI(); renderDeflation(document.getElementById('modal-body')); } else showToast('–ú–∞–ª–æ –¥–µ–Ω–µ–≥', 'warn'); }
        function renderHistory(c) { c.innerHTML = state.history.slice().reverse().map(h=>`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between"><b>${h.rest}</b><span>+${h.earn}</span></div>`).join(''); }
        function toggleQuickInv() { const m = document.getElementById('quick-inv'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; if(m.style.display==='flex') openQuickInv(); }
        function openQuickInv() { const m = document.getElementById('quick-inv'); m.innerHTML = ''; let owned = []; for (let [k, c] of Object.entries(state.inventory)) { if (c > 0) owned.push({ k, c, data: ITEMS_DB[k] }); } if (owned.length === 0) m.innerHTML = `<div style="padding:10px;text-align:center;color:#888">–ü—É—Å—Ç–æ.</div>`; else owned.forEach(i => { m.innerHTML += `<div class="inv-item" onclick="useItem('${i.k}')"><span>${i.data.name}</span><span class="inv-count">x${i.c}</span></div>`; }); }
        function resetGame() { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) { localStorage.removeItem(SAVE_KEY); location.reload(); } }

        window.onload = init;
    </script>
</body>
</html>

