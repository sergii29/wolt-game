<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg-dark: #1a1a1a; --text-primary: #ffffff; --brand-blue: #0088cc; --taxi-yellow: #ffcc00; --accent-green: #00e676; --accent-red: #ff3d00; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background-color: var(--bg-dark); color: var(--text-primary); overflow: hidden; user-select: none; }
        #map { height: 100%; width: 100%; z-index: 1; filter: brightness(0.8) contrast(1.2); }
        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; pointer-events: auto; border: none; }
        .balance-display { background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .game-toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 25px; z-index: 1001; opacity: 0; pointer-events: none; transition: 0.3s; border: 1px solid #333; }
        .game-toast.show { opacity: 1; }
        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 20px; z-index: 1002; color: #333; }
        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; display: flex; align-items: center; justify-content: center; margin-top: 10px; }
        .slider-knob { position: absolute; left: 4px; width: 52px; height: 52px; background: var(--brand-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: grab; z-index: 2; }
        .slider-fill { position: absolute; left: 0; height: 100%; background: rgba(0,136,204,0.2); width: 0%; border-radius: 30px; }
        .pedal-btn { width: 100%; background: var(--brand-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 800; margin-top: 15px; font-size: 18px; }
        .pedal-btn:disabled { background: #ccc; }
        /* Auth Modal */
        .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 80%; max-width: 300px; text-align: center; }
        .auth-input { width: 100%; padding: 10px; margin: 5px 0; background: #333; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; }
        .side-menu { position: absolute; top: 0; left: -80%; width: 80%; height: 100%; background: #1e1e1e; transition: 0.3s; padding: 20px; display: flex; flex-direction: column; }
        .side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; color: white; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display"><div id="balance-val" style="font-weight:800; color:white">0.00 PLN</div></div>
        <button class="stats-btn" onclick="saveGame(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!')"><i class="fa-solid fa-save"></i></button>
    </div>
    
    <div id="toast" class="game-toast">Msg</div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-box">
            <h3 style="color:white; margin-top:0">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <p style="color:#aaa; font-size:12px">–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ Android/Web.</p>
            <input id="auth-login" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
            <button onclick="performLogin()" class="pedal-btn" style="padding:10px; margin-top:10px">–í–æ–π—Ç–∏</button>
            <button onclick="performRegister()" class="pedal-btn" style="padding:10px; margin-top:5px; background:transparent; border:1px solid #00e676; color:#00e676">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="document.getElementById('auth-modal').style.display='none'" style="background:none; border:none; color:#666; margin-top:10px">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" class="side-menu" onclick="event.stopPropagation()">
            <h2 id="player-name-display">Guest</h2>
            <div id="player-id-display" style="font-size:10px; color:#666; margin-bottom:20px">ID: ...</div>
            <div class="menu-item" onclick="openAuthModal()" id="auth-btn-menu">üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            <div class="menu-item" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')){localStorage.clear();location.reload()}">üóë –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3>–°—Ç–∞—Ç—É—Å: <span id="status-text" style="color:red">–û–§–õ–ê–ô–ù</span></h3>
            <div id="demo-alert" style="color:orange; font-size:12px; display:none">‚ö†Ô∏è –î–ï–ú–û –†–ï–ñ–ò–ú: –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –±–µ–∑ –≤—Ö–æ–¥–∞!</div>
            <div class="slider-container">
                <div class="slider-fill" id="slider-fill"></div>
                <div class="slider-knob" id="slider-knob" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">GO</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", 
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let state = { id: 'guest_'+Math.random().toString(36).substr(2,5), name: 'Guest', balance: 0, isAuth: false };
        let map = L.map('map', {zoomControl:false}).setView([52.2297, 21.0122], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // --- AUTH LOGIC ---
        function init() {
            const saved = localStorage.getItem('WARSZAWA_FOREVER');
            if(saved) state = JSON.parse(saved);

            const tg = window.Telegram.WebApp;
            tg.ready(); tg.expand();

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                // TELEGRAM: –ê–í–¢–û –í–•–û–î
                state.id = tg.initDataUnsafe.user.id.toString();
                state.name = tg.initDataUnsafe.user.first_name;
                state.isAuth = true;
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞, —Ç–∞–∫ –∫–∞–∫ –¢–ì —É–∂–µ –≤–æ—à–µ–ª
                document.getElementById('auth-btn-menu').style.display = 'none';
                sync();
            } else {
                // ANDROID/WEB: –†–£–ß–ù–û–ô –í–•–û–î
                if(!state.isAuth) {
                    document.getElementById('demo-alert').style.display = 'block';
                    document.getElementById('auth-btn-menu').style.display = 'block';
                } else {
                    document.getElementById('demo-alert').style.display = 'none';
                }
            }
            updateUI();
            
            // –°–ª—É—à–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞
            db.ref('players/' + state.id + '/adminInbox').on('child_added', s => {
                const cmd = s.val();
                if(cmd.type === 'SET_VAR') {
                    if(cmd.path === 'balance') state.balance = cmd.value;
                    saveGame(); updateUI();
                }
                s.ref.remove();
            });
        }

        function openAuthModal() {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function performRegister() {
            const l = document.getElementById('auth-login').value;
            const p = document.getElementById('auth-pass').value;
            if(!l || !p) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
            
            db.ref('users_lookup/' + l).once('value', s => {
                if(s.exists()) return alert('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑–∫—É –õ–æ–≥–∏–Ω -> ID –ò–≥—Ä–æ–∫–∞
                db.ref('users_lookup/' + l).set({ login: l, pass: p, playerId: state.id });
                state.name = l; state.isAuth = true;
                saveGame(); updateUI();
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('demo-alert').style.display = 'none';
                alert('–ì–æ—Ç–æ–≤–æ! –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.');
            });
        }

        function performLogin() {
            const l = document.getElementById('auth-login').value;
            const p = document.getElementById('auth-pass').value;
            db.ref('users_lookup/' + l).once('value', s => {
                if(!s.exists()) return alert('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —é–∑–µ—Ä–∞');
                const d = s.val();
                if(d.pass !== p) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
                db.ref('players/' + d.playerId).once('value', ps => {
                    const data = ps.val();
                    if(data) state = data;
                    state.id = d.playerId;
                    state.isAuth = true;
                    saveGame(); updateUI();
                    document.getElementById('auth-modal').style.display = 'none';
                    document.getElementById('demo-alert').style.display = 'none';
                    alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                });
            });
        }

        function saveGame() {
            localStorage.setItem('WARSZAWA_FOREVER', JSON.stringify(state));
            sync();
        }

        function sync() {
            state.lastSeen = Date.now();
            db.ref('players/' + state.id).update(state);
        }

        function updateUI() {
            document.getElementById('balance-val').innerText = parseFloat(state.balance).toFixed(2) + ' PLN';
            document.getElementById('player-name-display').innerText = state.name;
            document.getElementById('player-id-display').innerText = 'ID: ' + state.id;
        }
        
        function toggleMenu() {
            const el = document.getElementById('menu-overlay');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
            setTimeout(()=> document.getElementById('side-menu').classList.toggle('open'), 10);
        }

        // --- SLIDER LOGIC ---
        let dragging = false;
        function startDrag(e) { dragging = true; }
        document.addEventListener('mousemove', e => { if(dragging) moveSlider(e.clientX); });
        document.addEventListener('touchmove', e => { if(dragging) moveSlider(e.touches[0].clientX); });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        
        function moveSlider(x) {
            const fill = document.getElementById('slider-fill');
            const knob = document.getElementById('slider-knob');
            let width = Math.min(100, Math.max(0, (x / window.innerWidth) * 100)); 
            fill.style.width = width + '%';
            knob.style.left = width + '%';
            if(width > 90) { 
                document.getElementById('status-text').innerText = '–û–ù–õ–ê–ô–ù';
                document.getElementById('status-text').style.color = 'green';
                state.isOnline = true; sync();
            }
        }
        function endDrag() { dragging = false; document.getElementById('slider-fill').style.width='0%'; document.getElementById('slider-knob').style.left='4px'; }

        init();
    </script>
    <script src="patches/design_update.js"></script>
</body>
</html>
