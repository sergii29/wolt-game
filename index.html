<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #00ccff;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff3d00;
            --wolt-blue: #009de0;
            --taxi-yellow: #ffcc00;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 1; filter: brightness(0.8) contrast(1.2); }

        /* TOP BAR */
        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; border: none; }
        .balance-display { background: rgba(0, 0, 0, 0.8); padding: 6px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); pointer-events: auto; }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        .balance-label { font-size: 10px; color: #ccc; margin-top: 2px; }
        .debt-warning { color: var(--accent-red); font-weight: bold; animation: pulse 1s infinite; display: none; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* 7 ICONS BAR */
        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; }

        /* BOTTOM SHEET */
        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); color: #333; }

        /* SIMPLE BUTTONS (No Swipes) */
        .action-btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 800; text-transform: uppercase; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.98); }
        .btn-green { background: var(--wolt-blue); color: white; box-shadow: 0 4px 0 #007bb5; }
        .btn-red { background: #cfd8dc; color: #455a64; box-shadow: 0 4px 0 #b0bec5; margin-top: 10px; }
        .btn-accept { background: var(--accent-green); color: #003300; box-shadow: 0 4px 0 #00b34a; animation: pulseBtn 1s infinite; }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* VISUAL TRACK (–ü–æ–ª–æ—Å–∫–∞ —Å –≤–µ–ª–∏–∫–æ–º/–∞–≤—Ç–æ) */
        .track-container { position: relative; height: 35px; background: #f0f0f0; border-radius: 17px; margin: 15px 0; border: 2px solid #e0e0e0; }
        .track-fill { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(0, 157, 224, 0.2); border-radius: 15px; width: 0%; transition: width 0.3s linear; }
        .track-icon { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: var(--wolt-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; left: 0%; transition: left 0.3s linear; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        
        /* Taxi Styles */
        .taxi-active .track-icon { background: var(--taxi-yellow); color: black; }
        .taxi-active .track-fill { background: rgba(255, 204, 0, 0.3); }
        .taxi-active .btn-green { background: var(--taxi-yellow); color: black; box-shadow: 0 4px 0 #fbc02d; }

        .bag-btn { width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; position: relative; margin-right: 10px; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* MENUS */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; }
        #side-menu-overlay.open { display: block; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; max-width: 300px; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; color: white; align-items: center; }
        .menu-section-title { font-size: 11px; color: var(--taxi-yellow); text-transform: uppercase; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px; margin-top: 15px; }
        .menu-item.locked { opacity: 0.5; cursor: not-allowed; color: #777; }

        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        .shop-card { background: white; padding: 15px; border-radius: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .shop-btn { padding: 8px 12px; border-radius: 8px; font-weight: bold; border: 1px solid #ddd; background: white; color: #333; cursor: pointer; }
        .shop-btn.buy { background: var(--wolt-blue); color: white; border: none; }
        
        .game-toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 5000; }
        .game-toast.show { opacity: 1; }
        
        .quick-inv { position: absolute; bottom: 100px; left: 20px; width: 200px; background: #222; border-radius: 12px; padding: 10px; display: none; color: white; z-index: 3000; }
        .inv-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label" id="player-id-display">ID: ...</div>
            <div class="debt-warning" id="debt-warning">–î–û–õ–ì!</div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon" id="icon-vehicle"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-vehicle" style="width: 100%"></div></div><span class="equip-label" id="lbl-vehicle">–í–ï–õ</span></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label">–°–£–ú–ö–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label">–û–î–ï–ñ–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" id="icon-energy" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label" id="lbl-energy">–°–ò–õ–´</span></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span></div>
    </div>

    <div id="toast" class="game-toast">Notification</div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="color:var(--wolt-blue); margin-bottom: 5px" id="menu-name">Courier</h2>
            <div style="font-size:10px; color:#666; margin-bottom:20px" id="menu-id">ID: ...</div>
            
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store" style="color:var(--wolt-blue)"></i> <span id="menu-shop-text">–ú–∞–≥–∞–∑–∏–Ω</span></div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns" style="color:var(--accent-green)"></i> –ë–∞–Ω–∫</div>
            <div class="menu-item" onclick="openModal('deflation')"><i class="fa-solid fa-scale-unbalanced-flip" style="color:#90a4ae"></i> –ò–Ω—Ñ–ª—è—Ü–∏—è</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            
            <div class="menu-section-title">üöñ –¢–∞–∫—Å–∏ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
            <div id="taxi-switch-container" style="display:none; padding:0 15px; margin-bottom:10px">
                <button class="shop-btn buy" style="width:100%; background:var(--taxi-yellow); color:black" onclick="toggleTaxiMode()"><i class="fa-solid fa-car"></i> <span id="taxi-switch-text">–í–∑—è—Ç—å –ú–∞—à–∏–Ω—É</span></button>
            </div>
            <div class="menu-item taxi-item locked" id="taxi-showroom-btn" onclick="openModal('taxi-shop')"><i class="fa-solid fa-car"></i> –ê–≤—Ç–æ—Å–∞–ª–æ–Ω</div>
            <div class="menu-item taxi-item locked" id="taxi-licenses-btn" onclick="openModal('taxi-licenses')"><i class="fa-solid fa-id-card"></i> –õ–∏—Ü–µ–Ω–∑–∏–∏</div>
            <div id="taxi-lock-msg" style="font-size:10px; color:#666; margin-left:45px">–ù—É–∂–Ω–æ 50 –∑–∞–∫–∞–∑–æ–≤</div>

            <div class="menu-item" onclick="resetGame()" style="color:var(--accent-red); margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; cursor:pointer"></i>
            <span id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0">–í–∞—Ä—à–∞–≤–∞</h3>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ò–Ω—Ñ–ª—è—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω–∞</p>
            <button class="action-btn btn-green" onclick="goOnline()">–í–´–ô–¢–ò –ù–ê –õ–ò–ù–ò–Æ</button>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="font-size:12px; color:#666" id="order-info">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
                </div>
                <div style="font-size:24px" id="rest-icon">üîç</div>
            </div>

            <div class="track-container">
                <div class="track-fill" id="track-fill"></div>
                <div class="track-icon" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div id="btn-area">
                <button class="action-btn" style="background:#eee; color:#666" disabled>–ü–û–ò–°–ö...</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px">
                <div class="bag-btn" onclick="toggleQuickInv()"><i class="fa-solid fa-bag-shopping"></i><div class="bag-badge" id="bag-count">0</div></div>
                <button class="action-btn btn-red" onclick="goOffline()" style="margin-top:0; font-size:12px; padding:10px">–ó–ê–ö–û–ù–ß–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", authDomain: "warszawa-courier.firebaseapp.com", databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app", projectId: "warszawa-courier", storageBucket: "warszawa-courier.firebasestorage.app", messagingSenderId: "295860613508", appId: "1:295860613508:web:86fe8364377d6875612dd1", measurementId: "G-TGSCHBVLX2" };
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        const ITEMS_DB = {
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5 }, bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2 }, phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1 }, gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3 },
            water: { name: '–í–æ–¥–∞', cost: 2.0, effect: {water:35, energy:5}, type: 'buy' }, bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', cost: 4.5, effect: {energy:20, mood:15}, type: 'buy' }, energy_drink: { name: 'Red Bull', cost: 7.0, effect: {energy:50, mood:5}, special:'no_drain', type: 'buy' }, coffee: { name: '–õ–∞—Ç—Ç–µ', cost: 9.0, effect: {mood:30, energy:10}, type: 'buy' },
            fuel: { name: '–ë–µ–Ω–∑–∏–Ω', cost: 5.5, effect: {fuel:20}, type: 'buy' }
        };
        
        let db = null;
        let state = {
            id: 'u_' + Math.random().toString(36).substr(2, 5), name: 'Guest', balance: 0, debt: 0, loanStreak: 0,
            isOnline: false, items: { bike:100, bag:100, phone:100, gear:100 }, needs: { energy:100, water:100, mood:100 },
            inventory: { water:0, bar:0, energy_drink:0, coffee:0 }, repairs: { bike:0, bag:0, phone:0, gear:0 },
            taxi: { unlocked:false, active:false, fuel:100, vehicle:null, licenses:{} }, career: { totalOrders:0 }, history: []
        };
        let gameConfig = { basePickupPay:4.0, perKmPay:1.5, inflationRate:0.1, deliveryTime:60 };
        let currentOrder = null; let orderTimer = null;

        function init() {
            // LOAD SAVE
            const saved = localStorage.getItem(SAVE_KEY);
            if(saved) state = { ...state, ...JSON.parse(saved) };
            
            // TG USER
            const tg = window.Telegram.WebApp; tg.ready();
            if(tg.initDataUnsafe?.user) { state.id = tg.initDataUnsafe.user.id.toString(); state.name = tg.initDataUnsafe.user.first_name; }

            // RENDER ID IMMEDIATELY
            document.getElementById('player-id-display').textContent = "ID: " + state.id;
            document.getElementById('menu-id').textContent = "ID: " + state.id;
            document.getElementById('menu-name').textContent = state.name;

            // FIREBASE
            try { firebase.initializeApp(firebaseConfig); db = firebase.database(); sync(); listen(); } catch(e){ console.error(e); }

            // MAP
            const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            updateUI();
            setInterval(() => { if(state.debt>0) checkDebt(); }, 1000);
        }

        function sync(force) { if(!db) return; db.ref('players/'+state.id).update({ name:state.name, balance:state.balance, taxi:state.taxi, lastSeen: Date.now() }); }
        function listen() { 
            db.ref('config').on('value', s => { if(s.val()) gameConfig = { ...gameConfig, ...s.val() }; });
            db.ref('players/'+state.id+'/adminInbox').on('child_added', s => { 
                const c = s.val(); 
                if(c.type === 'SET_VAR') {
                    let path = c.path.split('.'); let t = state;
                    for(let i=0; i<path.length-1; i++) t = t[path[i]];
                    t[path[path.length-1]] = c.value;
                    showToast('Admin update'); updateUI();
                }
                if(c.type === 'UNLOCK_TAXI') { state.taxi.unlocked = true; updateUI(); showToast('Taxi Unlocked!'); }
                s.ref.remove(); 
            });
        }
        function checkDebt() { /* Simplified debt check */ }
        function save() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); sync(); }

        // --- GAMEPLAY CONTROLS ---
        function goOnline() {
            state.isOnline = true;
            document.getElementById('offline-view').style.display = 'none';
            document.getElementById('active-order-view').style.display = 'flex';
            startSearch();
        }
        function goOffline() {
            state.isOnline = false;
            if(orderTimer) clearInterval(orderTimer);
            document.getElementById('offline-view').style.display = 'block';
            document.getElementById('active-order-view').style.display = 'none';
            save();
        }

        function startSearch() {
            const area = document.getElementById('btn-area');
            area.innerHTML = `<button class="action-btn" style="background:#eee; color:#666" disabled>–ü–û–ò–°–ö –ó–ê–ö–ê–ó–ê...</button>`;
            document.getElementById('rest-name').textContent = "–ü–æ–∏—Å–∫...";
            document.getElementById('track-fill').style.width = '0%';
            
            setTimeout(() => {
                if(!state.isOnline) return;
                createOrder();
            }, 2000);
        }

        function createOrder() {
            const dist = (1 + Math.random()*5).toFixed(1);
            const pay = (gameConfig.basePickupPay + (dist * gameConfig.perKmPay)).toFixed(2);
            
            currentOrder = { pay: parseFloat(pay), progress: 0 };
            
            document.getElementById('rest-name').textContent = "McDonald's";
            document.getElementById('order-info').textContent = `${dist} km ‚Ä¢ ${pay} PLN`;
            
            const area = document.getElementById('btn-area');
            area.innerHTML = `<button class="action-btn btn-accept" onclick="acceptOrder()">–ü–†–ò–ù–Ø–¢–¨ ${pay} PLN</button>`;
        }

        function acceptOrder() {
            const area = document.getElementById('btn-area');
            const isTaxi = state.taxi.active;
            const btnClass = isTaxi ? 'btn-green' : 'btn-green'; // Can customize color
            const btnText = isTaxi ? '–ì–ê–ó –í –ü–û–õ' : '–ö–†–£–¢–ò –ü–ï–î–ê–õ–ò';
            
            area.innerHTML = `<button class="action-btn ${btnClass}" onclick="pedal()">${btnText}</button>`;
        }

        function pedal() {
            if(!currentOrder) return;
            currentOrder.progress += 10;
            updateTrack(currentOrder.progress);
            
            // Resource Drain
            if(state.taxi.active) state.taxi.fuel -= 1;
            else state.needs.energy -= 2;

            if(currentOrder.progress >= 100) {
                state.balance += currentOrder.pay;
                showToast(`+${currentOrder.pay} PLN`, 'success');
                currentOrder = null;
                startSearch();
                save(); updateUI();
            }
            updateUI();
        }

        function updateTrack(p) {
            document.getElementById('track-fill').style.width = p + '%';
            document.getElementById('track-icon').style.left = p + '%';
            
            const icon = state.taxi.active ? 'fa-car' : 'fa-bicycle';
            const color = state.taxi.active ? 'var(--taxi-yellow)' : 'var(--wolt-blue)';
            
            document.getElementById('track-icon').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            document.getElementById('track-icon').style.background = color;
            document.getElementById('track-fill').style.background = color;
        }

        // --- UI ---
        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            
            // Bars
            ['energy','water','mood'].forEach(k => {
                document.getElementById(`bar-${k}`).style.width = state.needs[k] + '%';
            });
            
            // Taxi Logic
            if(state.taxi.active) {
                document.getElementById('icon-vehicle').className = 'fa-solid fa-car equip-icon';
                document.getElementById('lbl-vehicle').textContent = '–ê–í–¢–û';
                document.getElementById('icon-energy').className = 'fa-solid fa-gas-pump equip-icon';
                document.getElementById('lbl-energy').textContent = '–¢–û–ü–õ–ò–í–û';
                document.getElementById('bar-energy').style.background = 'var(--taxi-yellow)';
                document.getElementById('bar-energy').style.width = state.taxi.fuel + '%';
                
                document.getElementById('menu-shop-text').textContent = '–ê–ó–° / –ú–∞–≥–∞–∑–∏–Ω';
                document.getElementById('taxi-switch-text').textContent = '–í–µ—Ä–Ω—É—Ç—å –≤–µ–ª–∏–∫';
            } else {
                document.getElementById('icon-vehicle').className = 'fa-solid fa-bicycle equip-icon';
                document.getElementById('lbl-vehicle').textContent = '–í–ï–õ';
                document.getElementById('icon-energy').className = 'fa-solid fa-bolt equip-icon';
                document.getElementById('lbl-energy').textContent = '–°–ò–õ–´';
                document.getElementById('bar-energy').style.background = 'yellow';
                
                document.getElementById('menu-shop-text').textContent = '–ú–∞–≥–∞–∑–∏–Ω';
                document.getElementById('taxi-switch-text').textContent = '–í–∑—è—Ç—å –ú–∞—à–∏–Ω—É';
            }

            // Menu Locks
            const total = state.career.totalOrders;
            const unlocked = state.taxi.unlocked || total >= 50;
            if(unlocked) {
                document.querySelectorAll('.taxi-item').forEach(el => el.classList.remove('locked'));
                document.getElementById('taxi-lock-msg').style.display = 'none';
                if(state.taxi.vehicle) document.getElementById('taxi-switch-container').style.display = 'block';
            }
        }

        function toggleMenu() {
            const m = document.getElementById('side-menu');
            const o = document.getElementById('side-menu-overlay');
            if(m.classList.contains('open')) { m.classList.remove('open'); o.classList.remove('open'); }
            else { m.classList.add('open'); o.classList.add('open'); }
        }

        function openModal(type) {
            toggleMenu();
            const m = document.getElementById('full-modal'); m.classList.add('open');
            const b = document.getElementById('modal-body');
            
            if(type === 'shop') renderShop(b);
            else if(type === 'bank') renderBank(b);
            else if(type === 'taxi-shop') renderTaxiShop(b);
            else if(type === 'stats') { b.innerHTML = '<h3>–ò—Å—Ç–æ—Ä–∏—è</h3>' + state.history.map(h => `<div>${h.rest}: +${h.pay}</div>`).join(''); }
            else b.innerHTML = 'Coming soon';
        }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }

        // --- SHOP & BANK ---
        function renderShop(c) {
            if(state.taxi.active) {
                c.innerHTML = `<div class="shop-card"><div><b>–ë–µ–Ω–∑–∏–Ω (20–ª)</b></div><button class="shop-btn buy" onclick="buy('fuel', 5.5)">5.50</button></div>`;
                return;
            }
            c.innerHTML = `
                <div class="shop-section"><h3>–ï–¥–∞</h3>
                <div class="shop-card"><div><b>–í–æ–¥–∞</b></div><button class="shop-btn buy" onclick="buy('water', 2)">2.00</button></div>
                <div class="shop-card"><div><b>–°–Ω–∏–∫–µ—Ä—Å</b></div><button class="shop-btn buy" onclick="buy('bar', 4.5)">4.50</button></div>
                </div>
                <div class="shop-section"><h3>–†–µ–º–æ–Ω—Ç</h3>
                <div class="shop-card"><div><b>–í–µ–ª–æ—Å–∏–ø–µ–¥</b></div><button class="shop-btn" onclick="repair('bike', 5)">5.00</button></div>
                </div>
            `;
        }

        function renderTaxiShop(c) {
            c.innerHTML = `
                <div class="shop-card">
                    <div><b>Skoda Fabia</b><br><span style="font-size:10px">–†–∞–±–æ—á–∞—è –ª–æ—à–∞–¥–∫–∞</span></div>
                    <button class="shop-btn buy" onclick="buyCar('Skoda', 15000)">15000</button>
                </div>
            `;
        }

        function renderBank(c) {
            c.innerHTML = `
                <div style="text-align:center; padding:20px">
                    <h2>–î–æ–ª–≥: ${state.debt.toFixed(2)}</h2>
                    <button class="action-btn btn-green" onclick="takeLoan()">–í–ó–Ø–¢–¨ 100</button>
                    <button class="action-btn btn-red" onclick="payLoan()">–í–ï–†–ù–£–¢–¨ 100</button>
                    <br><br>
                    <button class="shop-btn" style="background:#333; color:orange" onclick="takeSOS()">üÜò SOS –ü–ê–ö–ï–¢</button>
                </div>
            `;
        }

        // --- ACTIONS ---
        function buy(k, cost) {
            if(state.balance >= cost) {
                state.balance -= cost;
                if(k==='fuel') state.taxi.fuel += 20;
                else state.inventory[k]++;
                showToast('–ö—É–ø–ª–µ–Ω–æ!', 'success'); updateUI(); save();
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn');
        }
        function repair(k, cost) {
            if(state.balance >= cost) { state.balance -= cost; state.items[k] = 100; showToast('–ü–æ—á–∏–Ω–µ–Ω–æ!', 'success'); updateUI(); save(); }
        }
        function buyCar(name, cost) {
            if(state.balance >= cost) { state.balance -= cost; state.taxi.vehicle = name; state.taxi.unlocked = true; showToast('–ú–∞—à–∏–Ω–∞ –∫—É–ø–ª–µ–Ω–∞!', 'success'); updateUI(); save(); }
        }
        function takeLoan() { state.balance += 100; state.debt += 100; updateUI(); save(); }
        function payLoan() { if(state.balance>=100 && state.debt>=100) { state.balance-=100; state.debt-=100; updateUI(); save(); } }
        function takeSOS() { state.inventory.water++; state.inventory.bar++; state.debt+=15; updateUI(); save(); }
        function toggleTaxiMode() {
            if(!state.taxi.vehicle) return;
            state.taxi.active = !state.taxi.active;
            toggleMenu(); updateUI(); save();
        }
        function toggleQuickInv() { 
            const d = document.getElementById('quick-inv'); 
            if(d.style.display==='block') d.style.display='none'; 
            else { d.style.display='block'; d.innerHTML = '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç (Demo)'; }
        }
        function resetGame() { if(confirm('–°–±—Ä–æ—Å?')) { localStorage.removeItem(SAVE_KEY); location.reload(); } }
        function showToast(m, t) { const el = document.getElementById('toast'); el.textContent = m; el.className = 'game-toast show'; setTimeout(()=>el.className='game-toast', 2000); }

        init();
    </script>
</body>
</html>

