<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-dark: #1a1a1a; --wolt-blue: #009de0; --taxi-yellow: #ffcc00; --accent-green: #00e676; --accent-red: #ff3d00; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: white; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 1; filter: brightness(0.8) contrast(1.2); }

        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; border: none; }
        .balance-display { background: rgba(0, 0, 0, 0.8); padding: 8px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        
        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; }

        .game-toast { position: absolute; top: 120px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; z-index: 2000; opacity: 0; transition: all 0.3s; pointer-events: none; border: 1px solid #444; }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; color: #333; }

        /* SLIDER FIXES */
        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-top: 10px; cursor: pointer; touch-action: none; }
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; text-transform: uppercase; font-size: 14px; pointer-events: none; }
        .slider-knob { position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px; background: var(--wolt-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; z-index: 2; transition: transform 0.1s; pointer-events: none; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 157, 224, 0.2); z-index: 0; transition: width 0.1s; }
        
        /* Taxi Styles */
        .taxi-active .slider-knob { background: var(--taxi-yellow); color: black; }
        .taxi-active .pedal-btn { background: var(--taxi-yellow); color: black; box-shadow: 0 4px 0 #f57f17; }

        .pedal-btn { width: 100%; background: var(--wolt-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; margin-top: 10px; box-shadow: 0 4px 0 #007bb5; }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; }

        /* Side Menu */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display:none; }
        #side-menu-overlay.open { display:block; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 10px; font-size: 16px; color: white; }
        
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }
        .shop-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .shop-btn { padding: 8px 12px; border-radius: 8px; font-weight: bold; border: 1px solid #ddd; background: white; color: #333; }
        .shop-btn.buy { background: var(--wolt-blue); color: white; border: none; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div style="font-size:8px; color:#aaa; margin-top:2px" id="debug-id">ID: ...</div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon" id="icon-vehicle"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-vehicle" style="width: 100%"></div></div><span class="equip-label" id="lbl-vehicle">–í–ï–õ</span></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label">–°–£–ú–ö–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label">–û–î–ï–ñ–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" id="icon-energy" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label" id="lbl-energy">–°–ò–õ–´</span></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px">–ú–µ–Ω—é</h2>
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store"></i> <span id="menu-shop-text">–ú–∞–≥–∞–∑–∏–Ω</span></div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns"></i> –ë–∞–Ω–∫</div>
            <div class="menu-item" onclick="openModal('taxi-shop')"><i class="fa-solid fa-car"></i> –ê–≤—Ç–æ—Å–∞–ª–æ–Ω</div>
            <div class="menu-item" onclick="toggleTaxiMode()" id="btn-taxi-toggle" style="display:none; color:var(--taxi-yellow)"><i class="fa-solid fa-repeat"></i> –ü–µ—Ä–µ—Å–µ—Å—Ç—å –Ω–∞ –∞–≤—Ç–æ</div>
            <div class="menu-item" onclick="resetGame()" style="color:#ff3d00; margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:24px; padding:10px; cursor:pointer"></i>
            <span id="modal-title" style="font-weight:bold; font-size:18px">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0">–í–∞—Ä—à–∞–≤–∞</h3>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ù–∞–∂–º–∏ –∏–ª–∏ —Ç—è–Ω–∏</p>
            <div class="slider-container" id="offline-slider-box">
                <div class="slider-fill" id="offline-slider-fill"></div>
                <div class="slider-text">–¢–Ø–ù–ò –ò–õ–ò –ñ–ú–ò ></div>
                <div class="slider-knob" id="offline-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="font-size:12px; color:#666" id="order-offer">...</div>
                </div>
                <div style="font-size:24px" id="rest-icon">üçî</div>
            </div>
            
            <div class="slider-container" id="online-slider-box">
                <div class="slider-fill" id="online-slider-fill"></div>
                <div class="slider-text">–û–ù–õ–ê–ô–ù (–ñ–ú–ò –í–´–ô–¢–ò)</div>
                <div class="slider-knob" id="online-slider-knob"><i class="fa-solid fa-power-off"></i></div>
            </div>

            <button class="pedal-btn" id="pedal-btn" disabled>–ü–û–ò–°–ö...</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        let db = null;
        
        // --- 2. GAME STATE ---
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        let state = {
            id: 'u_' + Math.random().toString(36).substr(2, 5),
            name: 'Guest', balance: 0, debt: 0,
            isOnline: false, isSearching: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 },
            needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 },
            taxi: { unlocked: false, active: false, fuel: 100, vehicle: null, licenses: {} },
            history: [], career: { totalOrders: 0 }
        };

        // --- 3. INIT ---
        function init() {
            // Map
            const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            // Load Data
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed }; // Merge to ensure new fields (taxi) exist
            }
            
            // Telegram User Data
            const tg = window.Telegram.WebApp;
            tg.ready();
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                state.id = tg.initDataUnsafe.user.id.toString();
                state.name = tg.initDataUnsafe.user.first_name;
            }

            // DB Connect
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                showToast("‚úÖ Cloud Connected", "success");
                syncToCloud();
                listenToCloud();
            } catch(e) {
                showToast("‚ùå Cloud Error", "warn");
                console.error(e);
            }

            // UI Init
            document.getElementById('debug-id').textContent = "ID: " + state.id;
            setupSliders();
            document.getElementById('pedal-btn').onclick = pedal;
            updateUI();
            
            // Auto-save loop
            setInterval(() => { saveGame(); syncToCloud(); }, 5000);
        }

        // --- 4. SLIDER LOGIC (CLICK + SWIPE FIXED) ---
        function setupSliders() {
            createSlider('offline', () => { 
                state.isOnline = true; 
                state.isSearching = true; // Auto start searching
                document.getElementById('offline-view').style.display = 'none';
                document.getElementById('active-order-view').style.display = 'flex';
                resetSlider('online');
                startSearching();
            });
            
            createSlider('online', () => { 
                state.isOnline = false; 
                state.isSearching = false;
                document.getElementById('active-order-view').style.display = 'none';
                document.getElementById('offline-view').style.display = 'block';
                resetSlider('offline');
                stopOrderLoop();
            });
        }

        function createSlider(id, action) {
            const box = document.getElementById(id + '-slider-box');
            const knob = document.getElementById(id + '-slider-knob');
            const fill = document.getElementById(id + '-slider-fill');
            
            let isDragging = false;
            let startX = 0;

            // Touch Start
            const start = (e) => {
                isDragging = true;
                startX = (e.type === 'mousedown') ? e.clientX : e.touches[0].clientX;
            };

            // Touch Move
            const move = (e) => {
                if(!isDragging) return;
                const currentX = (e.type === 'mousemove') ? e.clientX : e.touches[0].clientX;
                let diff = currentX - startX;
                let max = box.offsetWidth - knob.offsetWidth - 8;
                diff = Math.max(0, Math.min(diff, max));
                
                knob.style.transform = `translateX(${diff}px)`;
                fill.style.width = (diff / max * 100) + '%';

                if(diff >= max * 0.95) {
                    isDragging = false;
                    action();
                }
            };

            const end = () => { isDragging = false; knob.style.transform = 'translateX(0)'; fill.style.width = '0%'; };

            // CLICK FALLBACK (IF SWIPE FAILS)
            box.onclick = (e) => {
                if(e.target !== knob) {
                    knob.style.transition = '0.3s';
                    fill.style.transition = '0.3s';
                    knob.style.transform = `translateX(${box.offsetWidth - 60}px)`;
                    fill.style.width = '100%';
                    setTimeout(() => {
                        action();
                        setTimeout(() => { 
                            knob.style.transition = ''; fill.style.transition = ''; 
                            knob.style.transform = 'translateX(0)'; fill.style.width = '0%';
                        }, 500);
                    }, 300);
                }
            };

            knob.addEventListener('mousedown', start);
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', end);
            
            knob.addEventListener('touchstart', start);
            document.addEventListener('touchmove', move);
            document.addEventListener('touchend', end);
        }

        function resetSlider(id) {
            document.getElementById(id + '-slider-knob').style.transform = 'translateX(0)';
            document.getElementById(id + '-slider-fill').style.width = '0%';
        }

        // --- 5. CLOUD SYNC & ADMIN ---
        function syncToCloud(force) {
            if(!db) return;
            db.ref('players/' + state.id).update({
                name: state.name,
                balance: state.balance,
                lastSeen: Date.now(),
                stats: state.needs,
                inventory: state.inventory,
                taxi: state.taxi,
                career: state.career,
                items: state.items
            });
        }

        function listenToCloud() {
            if(!db) return;
            // Admin Commands
            db.ref('players/' + state.id + '/adminInbox').on('child_added', snap => {
                const cmd = snap.val();
                handleAdminCmd(cmd);
                snap.ref.remove();
            });
        }

        function handleAdminCmd(cmd) {
            showToast("üîß Admin Command Received", "info");
            
            if (cmd.type === 'SET_VAR') {
                // path: 'balance', value: 100
                const parts = cmd.path.split('.');
                let obj = state;
                for(let i=0; i<parts.length-1; i++) {
                    if(!obj[parts[i]]) obj[parts[i]] = {};
                    obj = obj[parts[i]];
                }
                obj[parts[parts.length-1]] = cmd.value;
            }
            else if (cmd.type === 'MATH_VAR') {
                const parts = cmd.path.split('.');
                let obj = state;
                for(let i=0; i<parts.length-1; i++) obj = obj[parts[i]];
                obj[parts[parts.length-1]] += cmd.value;
            }
            else if (cmd.type === 'FULL_RESET') {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
                return;
            }

            saveGame();
            updateUI();
        }

        // --- 6. GAME LOGIC ---
        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function updateUI() {
            // Bars
            document.getElementById('bar-energy').style.width = state.needs.energy + '%';
            document.getElementById('bar-water').style.width = state.needs.water + '%';
            document.getElementById('bar-mood').style.width = state.needs.mood + '%';
            document.getElementById('bar-vehicle').style.width = state.items.bike + '%';
            document.getElementById('bar-bag').style.width = state.items.bag + '%';
            document.getElementById('bar-phone').style.width = state.items.phone + '%';
            document.getElementById('bar-gear').style.width = state.items.gear + '%';

            // Balance
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';

            // Taxi Mode Visuals
            const body = document.body;
            const btn = document.getElementById('pedal-btn');
            
            if (state.taxi && state.taxi.active) {
                body.classList.add('taxi-active');
                document.getElementById('lbl-vehicle').textContent = '–ê–í–¢–û';
                document.getElementById('icon-vehicle').className = 'fa-solid fa-car equip-icon';
                document.getElementById('lbl-energy').textContent = '–ë–ï–ù–ó–ò–ù';
                document.getElementById('bar-energy').style.background = '#ff9100'; // Orange for Fuel
                document.getElementById('btn-taxi-toggle').style.display = 'flex';
                document.getElementById('btn-taxi-toggle').innerHTML = '<i class="fa-solid fa-bicycle"></i> –í–µ—Ä–Ω—É—Ç—å –≤–µ–ª–∏–∫';
            } else {
                body.classList.remove('taxi-active');
                document.getElementById('lbl-vehicle').textContent = '–í–ï–õ';
                document.getElementById('icon-vehicle').className = 'fa-solid fa-bicycle equip-icon';
                document.getElementById('lbl-energy').textContent = '–°–ò–õ–´';
                document.getElementById('bar-energy').style.background = 'yellow';
                if(state.taxi && state.taxi.vehicle) {
                    document.getElementById('btn-taxi-toggle').style.display = 'flex';
                    document.getElementById('btn-taxi-toggle').innerHTML = '<i class="fa-solid fa-car"></i> –ü–µ—Ä–µ—Å–µ—Å—Ç—å –Ω–∞ –∞–≤—Ç–æ';
                }
            }
        }

        // --- ORDER LOGIC ---
        let currentOrder = null;
        let orderTimer = null;

        function startSearching() {
            const btn = document.getElementById('pedal-btn');
            btn.textContent = "–ü–û–ò–°–ö...";
            btn.disabled = true;
            
            setTimeout(() => {
                if(!state.isOnline) return;
                
                // Create Order
                const dist = (1 + Math.random() * 5).toFixed(1);
                const pay = (4 + (dist * 1.5)).toFixed(2);
                
                currentOrder = { pay: parseFloat(pay), dist: dist, progress: 0 };
                
                document.getElementById('rest-name').textContent = "McDonald's";
                document.getElementById('order-offer').textContent = `${dist} km ‚Ä¢ ${pay} PLN`;
                
                btn.textContent = "–ü–†–ò–ù–Ø–¢–¨ –ó–ê–ö–ê–ó";
                btn.disabled = false;
            }, 2000);
        }

        function pedal() {
            if(!currentOrder) { startSearching(); return; }
            
            // Consumption
            if(state.taxi.active) {
                state.taxi.fuel -= 2; // Fuel
            } else {
                state.needs.energy -= 2; // Energy
            }
            state.needs.water -= 1;

            currentOrder.progress += 10;
            const btn = document.getElementById('pedal-btn');
            btn.textContent = `–í –ü–£–¢–ò ${currentOrder.progress}%`;

            if(currentOrder.progress >= 100) {
                completeOrder();
            }
            updateUI();
        }

        function completeOrder() {
            state.balance += currentOrder.pay;
            state.career.totalOrders++;
            showToast(`‚úÖ +${currentOrder.pay} PLN`, 'success');
            currentOrder = null;
            startSearching();
            saveGame();
            syncToCloud(true);
        }

        function stopOrderLoop() {
            currentOrder = null;
        }

        // --- HELPERS ---
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = `game-toast show toast-${type}`;
            setTimeout(() => t.className = 'game-toast', 3000);
        }

        function toggleMenu() {
            const m = document.getElementById('side-menu');
            const o = document.getElementById('side-menu-overlay');
            if(m.classList.contains('open')) { m.classList.remove('open'); o.classList.remove('open'); }
            else { m.classList.add('open'); o.classList.add('open'); }
        }

        function openModal(type) {
            toggleMenu(); // close menu
            const m = document.getElementById('full-modal');
            m.classList.add('open');
            document.getElementById('modal-title').textContent = type.toUpperCase();
            
            const b = document.getElementById('modal-body');
            b.innerHTML = ''; // Clear previous

            if(type === 'shop') {
                if(state.taxi.active) {
                    b.innerHTML = `<div class="shop-card"><div><b>–ë–µ–Ω–∑–∏–Ω (20–ª)</b></div><button class="shop-btn buy" onclick="buyItem('fuel', 5)">5.00</button></div>`;
                } else {
                    b.innerHTML = `<div class="shop-card"><div><b>–í–æ–¥–∞</b></div><button class="shop-btn buy" onclick="buyItem('water', 2)">2.00</button></div>
                                   <div class="shop-card"><div><b>–°–Ω–∏–∫–µ—Ä—Å</b></div><button class="shop-btn buy" onclick="buyItem('bar', 4.5)">4.50</button></div>`;
                }
            }
            if(type === 'taxi-shop') {
                b.innerHTML = `<div class="shop-card"><div><b>Skoda Fabia</b></div><button class="shop-btn buy" onclick="buyCar('Skoda', 15000)">15000</button></div>`;
            }
        }

        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }

        function buyItem(item, cost) {
            if(state.balance >= cost) {
                state.balance -= cost;
                if(item === 'fuel') state.taxi.fuel += 20;
                else state.inventory[item]++;
                showToast("–ö—É–ø–ª–µ–Ω–æ!", "success");
                updateUI(); saveGame();
            } else {
                showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥", "warn");
            }
        }

        function buyCar(name, cost) {
            if(state.balance >= cost) {
                state.balance -= cost;
                state.taxi.vehicle = name;
                state.taxi.unlocked = true;
                showToast("–ú–∞—à–∏–Ω–∞ –∫—É–ø–ª–µ–Ω–∞!", "success");
                updateUI(); saveGame();
            } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥", "warn");
        }

        function toggleTaxiMode() {
            if(!state.taxi.vehicle) { showToast("–ù–µ—Ç –º–∞—à–∏–Ω—ã", "warn"); return; }
            state.taxi.active = !state.taxi.active;
            toggleMenu();
            updateUI();
        }

        function resetGame() {
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å?")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>

