<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #00ccff;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff3d00;
            --accent-purple: #d500f9;
            --wolt-blue: #009de0;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            user-select: none;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            filter: brightness(0.8) contrast(1.2);
        }

        /* --- TOP UI --- */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 1000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }

        .menu-btn, .stats-btn {
            background: white;
            color: black;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            pointer-events: auto;
            cursor: pointer;
            border: none;
        }

        .balance-display {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-amount {
            font-size: 18px;
            font-weight: 800;
            color: white;
        }

        .balance-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* --- BARS --- */
        .equip-bar {
            position: absolute;
            top: 70px;
            left: 15px;
            right: 15px;
            display: flex;
            gap: 6px;
            z-index: 999;
            pointer-events: none;
        }

        .equip-item {
            flex: 1;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            padding: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .equip-icon {
            font-size: 10px;
            margin-bottom: 2px;
            color: #ccc;
        }

        .progress-mini {
            width: 100%;
            height: 3px;
            background: #444;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-mini-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }

        /* --- TOAST NOTIFICATIONS --- */
        .game-toast {
            position: absolute;
            top: 140px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            border: 1px solid #333;
        }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-warn { border-color: var(--accent-orange); color: var(--accent-orange); }
        .toast-success { border-color: var(--accent-green); color: var(--accent-green); }

        /* --- BOTTOM SHEET --- */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 20px;
            z-index: 1002;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        /* SLIDER */
        .slider-container {
            position: relative;
            width: 100%;
            height: 60px;
            background: #f0f0f0;
            border-radius: 30px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; }
        .slider-knob {
            position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px;
            background: var(--wolt-blue); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; cursor: grab; z-index: 2;
        }
        .slider-fill {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
            background: rgba(0, 157, 224, 0.2); z-index: 0;
        }

        /* CONTROLS */
        .controls-row { display: flex; gap: 10px; margin-top: 15px; }

        .pedal-btn {
            flex: 1;
            background: var(--wolt-blue);
            color: white; border: none; padding: 18px; border-radius: 16px;
            font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 4px 0 #007bb5; transition: all 0.1s;
        }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; }

        .bag-btn {
            width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            color: #333; cursor: pointer; position: relative;
        }
        .bag-badge {
            position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white;
            font-size: 10px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }

        /* SMART INVENTORY POPUP */
        .quick-inv {
            position: absolute; bottom: 90px; left: 20px; width: 220px;
            background: #252525; color: white; padding: 10px; border-radius: 16px;
            z-index: 1005; display: none; flex-direction: column; gap: 8px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.6);
            border: 1px solid #444;
        }
        .quick-inv.open { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .inv-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;
            cursor: pointer; border: 1px solid transparent; transition: background 0.2s;
        }
        .inv-item:active { background: rgba(255,255,255,0.2); }
        
        /* Recommended Item Highlight */
        .inv-item.recommended {
            border: 1px solid var(--accent-green);
            background: rgba(0, 230, 118, 0.1);
        }
        .rec-tag {
            font-size: 9px; color: var(--accent-green); font-weight: bold; text-transform: uppercase;
            display: block; margin-bottom: 2px;
        }

        .inv-count { background: var(--wolt-blue); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }

        @keyframes popUp {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- MENUS --- */
        #side-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu {
            position: absolute; top: 0; left: -85%; width: 85%; max-width: 320px; height: 100%;
            background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
        }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; }

        /* --- FULL MODAL --- */
        .full-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f5; color: black; z-index: 3000;
            transform: translateY(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* SHOP CARDS */
        .shop-section { margin-bottom: 25px; }
        .shop-section h3 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .shop-card {
            background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .shop-desc { font-size: 11px; color: #888; margin-top: 4px; }
        .shop-btn {
            padding: 8px 14px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer;
            border: 1px solid var(--wolt-blue); color: var(--wolt-blue); background: white; min-width: 80px;
        }
        .shop-btn.buy { background: var(--wolt-blue); color: white; }
        .shop-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å</div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            <div class="menu-item" onclick="resetGame()" style="color:red; margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0">–í–∞—Ä—à–∞–≤–∞</h3>
            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ x1.2 –∫ –æ–ø–ª–∞—Ç–µ</p>
            <div class="slider-container" id="slider-box">
                <div class="slider-fill" id="slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div><h3 style="margin:0" id="rest-name">Rest</h3><p style="margin:0; font-size:12px; color:#888" id="order-dest">Dest</p></div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--wolt-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--wolt-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--wolt-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–ï–¥–∞: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–°—Ç–∞—Ç—É—Å</span>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó (PEDAL)</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        
        // --- SMART ITEMS DATABASE ---
        const ITEMS_DB = {
            // Service
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle', desc: '–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ–π' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open', desc: '–ó–∞–ø–ª–∞—Ç–∫–∞ –¥—ã—Ä' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen', desc: '–û–ø–ª–∞—Ç–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt', desc: '–•–∏–º—á–∏—Å—Ç–∫–∞' },
            
            // Consumables (The Smart Logic)
            water: { 
                name: '–í–æ–¥–∞ (0.5–ª)', type: 'buy', cost: 2.0, icon: 'fa-bottle-water',
                effect: { water: 35, energy: 5 }, 
                desc: '–°–ø–∞—Å–∞–µ—Ç –æ—Ç –∂–∞–∂–¥—ã. –ù–µ–º–Ω–æ–≥–æ –±–æ–¥—Ä–∏—Ç.',
                target: 'water' 
            },
            bar: { 
                name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.5, icon: 'fa-cookie-bite',
                effect: { energy: 20, mood: 15 }, 
                desc: '–ë–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ä–∞–¥–æ—Å—Ç–∏.',
                target: 'energy' // Secondary mood
            },
            energy_drink: { 
                name: 'Red Bull', type: 'buy', cost: 7.0, icon: 'fa-bolt',
                effect: { energy: 50, mood: 5, water: -5 }, 
                desc: '–ú–ê–ö–°–ò–ú–£–ú –≠–Ω–µ—Ä–≥–∏–∏! –ù–æ —Å—É—à–∏—Ç (-–í–æ–¥–∞).',
                target: 'energy' 
            },
            coffee: { 
                name: '–õ–∞—Ç—Ç–µ', type: 'buy', cost: 9.0, icon: 'fa-mug-hot',
                effect: { mood: 30, energy: 10 }, 
                desc: '–õ—É—á—à–µ–µ –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!',
                target: 'mood' 
            }
        };

        let state = {
            balance: 0,
            isOnline: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 },
            needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 },
            history: [],
            totalOrders: 0
        };

        const restaurants = [
            { name: "McDonald's", icon: "üçî" }, { name: "KFC", icon: "üçó" },
            { name: "Pasibus", icon: "üçî" }, { name: "Kebab King", icon: "üåØ" }
        ];

        let currentOrder = null;
        let map;

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            L.marker([52.2297, 21.0122]).addTo(map);
            loadGame();
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            setupSlider();
        }

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                if (!state.needs.mood) state.needs.mood = 100; // Migration
                if (!state.inventory) state.inventory = { water: 0, bar: 0, energy_drink: 0, coffee: 0 };
            }
            updateUI();
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            
            updateBar('bar-bike', state.items.bike);
            updateBar('bar-bag', state.items.bag);
            updateBar('bar-phone', state.items.phone);
            updateBar('bar-gear', state.items.gear);
            
            updateBar('bar-energy', state.needs.energy);
            updateBar('bar-water', state.needs.water);
            updateBar('bar-mood', state.needs.mood);
            
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv;
            document.getElementById('bag-count').style.display = totalInv ? 'flex' : 'none';
        }

        function updateBar(id, val) {
            document.getElementById(id).style.width = Math.max(0, Math.min(100, val)) + '%';
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : (type==='success' ? 'toast-success' : ''));
            setTimeout(() => t.className = 'game-toast', 3000);
        }

        // --- GAMEPLAY ---
        function pedal() {
            if (!currentOrder) return;
            
            // Logic: Tired = Slow
            let fatigueMult = Math.max(0.3, state.needs.energy / 100);
            
            if (state.needs.energy <= 10 || state.needs.water <= 5) {
                showToast('<i class="fa-solid fa-triangle-exclamation"></i> –°–∏–ª –Ω–µ—Ç! –û—Ç–∫—Ä–æ–π —Ä—é–∫–∑–∞–∫!', 'warn');
                openQuickInv(true); // Auto-open with suggestion
                return;
            }

            state.needs.energy -= 0.6;
            state.needs.water -= 0.4;
            state.needs.mood -= 0.15; // Slow burnout
            state.items.bike -= 0.1;

            currentOrder.progress += (4 * fatigueMult);
            currentOrder.foodTemp -= 0.15;
            
            updateTrack(currentOrder.progress);
            document.getElementById('temp-val').textContent = Math.floor(currentOrder.foodTemp) + '%';
            
            if (currentOrder.progress >= 100) nextStage();
            saveGame(); updateUI();
        }

        // --- SMART INVENTORY LOGIC ---
        function toggleQuickInv() {
            const menu = document.getElementById('quick-inv');
            menu.style.display === 'flex' ? menu.style.display = 'none' : openQuickInv();
        }

        function openQuickInv(auto = false) {
            const menu = document.getElementById('quick-inv');
            menu.innerHTML = '';
            
            // 1. Determine what is needed most
            let lowestStat = 'none';
            let minVal = 100;
            
            if (state.needs.water < minVal) { minVal = state.needs.water; lowestStat = 'water'; }
            if (state.needs.energy < minVal) { minVal = state.needs.energy; lowestStat = 'energy'; }
            if (state.needs.mood < minVal) { minVal = state.needs.mood; lowestStat = 'mood'; }

            // 2. Filter & Sort Inventory
            // We create an array of owned items
            let ownedItems = [];
            for (let [key, count] of Object.entries(state.inventory)) {
                if (count > 0) ownedItems.push({ key, count, data: ITEMS_DB[key] });
            }

            // 3. Sorting Logic: Priority to items matching the lowest stat
            ownedItems.sort((a, b) => {
                const aMatch = (a.data.target === lowestStat);
                const bMatch = (b.data.target === lowestStat);
                return bMatch - aMatch; // True (1) comes first
            });

            if (ownedItems.length === 0) {
                menu.innerHTML = '<div style="padding:10px; color:#888; font-size:12px; text-align:center">–†—é–∫–∑–∞–∫ –ø—É—Å—Ç.<br>–ó–∞–π–¥–∏ –≤ –ú–∞–≥–∞–∑–∏–Ω.</div>';
            } else {
                ownedItems.forEach((item, index) => {
                    const isRecommended = (item.data.target === lowestStat) && (minVal < 50);
                    const div = document.createElement('div');
                    div.className = 'inv-item' + (isRecommended && index === 0 ? ' recommended' : '');
                    
                    let label = `<span><i class="fa-solid ${item.data.icon}"></i> ${item.data.name}</span>`;
                    if (isRecommended && index === 0) {
                        let reason = lowestStat === 'water' ? '–ñ–∞–∂–¥–∞!' : (lowestStat === 'mood' ? '–ì—Ä—É—Å—Ç–Ω–æ...' : '–£—Å—Ç–∞–ª–æ—Å—Ç—å!');
                        label = `<div><span class="rec-tag">${reason}</span>` + label + `</div>`;
                    }

                    div.innerHTML = `
                        ${label}
                        <span class="inv-count">x${item.count}</span>
                    `;
                    div.onclick = () => useItem(item.key);
                    menu.appendChild(div);
                });
            }
            
            menu.style.display = 'flex';
            menu.classList.add('open');
        }

        function useItem(key) {
            if (state.inventory[key] <= 0) return;
            const item = ITEMS_DB[key];
            state.inventory[key]--;
            
            if (item.effect.energy) state.needs.energy += item.effect.energy;
            if (item.effect.water) state.needs.water += item.effect.water;
            if (item.effect.mood) state.needs.mood += item.effect.mood;
            
            // Cap at 100
            ['energy','water','mood'].forEach(k => { if(state.needs[k]>100) state.needs[k]=100; });
            
            showToast(`${item.name} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!`, 'success');
            toggleQuickInv(); saveGame(); updateUI();
        }

        // --- SHOP & MENU ---
        function toggleMenu() {
            document.getElementById('side-menu-overlay').classList.toggle('open');
            document.getElementById('side-menu').classList.toggle('open');
        }

        function openModal(type) {
            toggleMenu(); 
            document.getElementById('full-modal').classList.add('open');
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = type === 'shop' ? '–ú–∞–≥–∞–∑–∏–Ω' : '–ò—Å—Ç–æ—Ä–∏—è';
            
            if (type === 'shop') renderShop(body);
            else renderHistory(body);
        }

        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }

        function renderShop(container) {
            container.innerHTML = '';
            
            let html = '<div class="shop-section"><h3>üéí –ï–¥–∞ –∏ –ù–∞–ø–∏—Ç–∫–∏ (–í —Ä—é–∫–∑–∞–∫)</h3>';
            ['water', 'bar', 'energy_drink', 'coffee'].forEach(key => {
                const item = ITEMS_DB[key];
                const owned = state.inventory[key] || 0;
                html += `
                <div class="shop-card">
                    <div style="flex:1">
                        <div style="font-weight:bold"><i class="fa-solid ${item.icon}"></i> ${item.name}</div>
                        <div class="shop-desc">${item.desc}</div>
                        <div style="font-size:11px; color:#444; margin-top:2px">–í —Ä—é–∫–∑–∞–∫–µ: ${owned}</div>
                    </div>
                    <button class="shop-btn buy" onclick="buyItem('${key}')">${item.cost.toFixed(1)}</button>
                </div>`;
            });
            html += '</div>';

            html += '<div class="shop-section"><h3>üõ† –°–µ—Ä–≤–∏—Å –∏ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h3>';
            ['bike', 'bag', 'phone', 'gear'].forEach(key => {
                const item = ITEMS_DB[key];
                const cost = item.baseCost + ((state.repairs[key]||0) * 0.5);
                html += `
                <div class="shop-card">
                    <div>
                        <div style="font-weight:bold"><i class="fa-solid ${item.icon}"></i> ${item.name}</div>
                        <div class="shop-desc">${item.desc}</div>
                        <div style="font-size:11px; color:#666">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${Math.floor(state.items[key])}%</div>
                    </div>
                    <button class="shop-btn" onclick="buyRepair('${key}', ${cost})">-${cost.toFixed(1)}</button>
                </div>`;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function buyItem(key) {
            const item = ITEMS_DB[key];
            if (state.balance >= item.cost) {
                state.balance -= item.cost;
                state.inventory[key] = (state.inventory[key]||0)+1;
                showToast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, 'success');
                saveGame(); updateUI(); renderShop(document.getElementById('modal-body'));
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn');
        }

        function buyRepair(key, cost) {
            if (state.balance >= cost) {
                state.balance -= cost;
                state.items[key] = 100;
                state.repairs[key] = (state.repairs[key]||0)+1;
                showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                saveGame(); updateUI(); renderShop(document.getElementById('modal-body'));
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥', 'warn');
        }

        function renderHistory(c) {
            c.innerHTML = state.history.slice().reverse().map(h => 
                `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between">
                    <b>${h.rest}</b> <span style="color:green">+${h.earn} PLN</span>
                </div>`
            ).join('') || '<p style="text-align:center;color:#999">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
        }

        // --- UTILS ---
        function nextStage() {
            currentOrder.stage++;
            currentOrder.progress = 0;
            updateTrack(0);

            if (currentOrder.stage === 1) {
                setBtnState(true, '–ñ–î–ï–ú –ó–ê–ö–ê–ó...');
                document.getElementById('status-label').textContent = '–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç...';
                setTimeout(() => {
                    setBtnState(false, '–ñ–ú–ò –ì–ê–ó (PEDAL)');
                    document.getElementById('status-label').textContent = '–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç—É';
                    currentOrder.stage = 2;
                }, 2000);
            } else if (currentOrder.stage === 3) completeOrder();
        }

        function completeOrder() {
            let pay = 12 + (Math.random() * 5);
            if (state.needs.mood > 80 && Math.random() > 0.5) { pay += 4; showToast('–ö–ª–∏–µ–Ω—Ç –æ—Ü–µ–Ω–∏–ª –ü–æ–∑–∏—Ç–∏–≤! +–ß–∞–µ–≤—ã–µ', 'success'); }
            state.balance += pay;
            state.history.push({ rest: currentOrder.rest.name, earn: pay.toFixed(2) });
            currentOrder = null;
            document.getElementById('active-order-view').style.display = 'none';
            document.getElementById('offline-view').style.display = 'block';
            state.isOnline = false;
            resetSlider();
            showToast(`–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${pay.toFixed(2)} PLN`, 'success');
            saveGame(); updateUI();
        }

        function setBtnState(disabled, text) {
            const btn = document.getElementById('pedal-btn');
            btn.disabled = disabled;
            btn.textContent = text;
        }

        function updateTrack(p) {
            document.getElementById('track-fill').style.width = p + '%';
            document.getElementById('track-icon').style.left = p + '%';
        }

        function resetSlider() {
            document.getElementById('slider-knob').style.transform = 'translateX(0)';
            document.getElementById('slider-fill').style.width = '0%';
        }
        
        let isDragging = false, startX;
        function setupSlider() {
            const k = document.getElementById('slider-knob'), b = document.getElementById('slider-box');
            k.onmousedown = k.ontouchstart = e => {
                isDragging = true;
                startX = (e.type==='mousedown'?e.clientX:e.touches[0].clientX);
                document.onmousemove = document.ontouchmove = e => {
                    if(!isDragging) return;
                    let x = (e.type==='mousemove'?e.clientX:e.touches[0].clientX) - startX;
                    let max = b.offsetWidth - k.offsetWidth - 8;
                    x = Math.max(0, Math.min(x, max));
                    k.style.transform = `translateX(${x}px)`;
                    document.getElementById('slider-fill').style.width = `${(x/max)*100}%`;
                    if(x >= max*0.9) { goOnline(); isDragging = false; }
                };
                document.onmouseup = document.ontouchend = () => { 
                    isDragging = false; 
                    if(!state.isOnline) resetSlider(); 
                };
            };
        }

        function goOnline() {
            state.isOnline = true;
            document.getElementById('offline-view').style.display = 'none';
            document.getElementById('active-order-view').style.display = 'flex';
            setTimeout(() => {
                const r = restaurants[Math.floor(Math.random() * restaurants.length)];
                currentOrder = { rest: r, progress: 0, stage: 0, foodTemp: 100 };
                document.getElementById('rest-name').textContent = r.name;
                document.getElementById('rest-icon').textContent = r.icon;
                document.getElementById('status-label').textContent = '–ï–¥–µ–º –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω';
                setBtnState(false, '–ñ–ú–ò –ì–ê–ó (PEDAL)');
                updateTrack(0);
            }, 1000);
        }

        function resetGame() {
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) { localStorage.removeItem(SAVE_KEY); location.reload(); }
        }

        init();
    </script>
</body>
</html>
