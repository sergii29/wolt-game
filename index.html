<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Sim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #00ccff;
            --accent-green: #00e676;
            --accent-orange: #ff9100;
            --accent-red: #ff3d00;
            --accent-purple: #d500f9;
            --brand-blue: #0088cc; 
            --taxi-yellow: #ffcc00;
            --taxi-black: #222;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-primary); overflow: hidden; user-select: none; }
        #map { height: 100%; width: 100%; z-index: 1; filter: brightness(0.8) contrast(1.2); }

        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer; border: none; }
        .balance-display { background: rgba(0, 0, 0, 0.8); padding: 8px 16px; border-radius: 20px; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .balance-amount { font-size: 18px; font-weight: 800; color: white; }
        .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .debt-warning { color: var(--accent-red); font-size: 10px; font-weight: bold; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .equip-bar { position: absolute; top: 70px; left: 15px; right: 15px; display: flex; gap: 4px; z-index: 999; pointer-events: none; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(4px); }
        .equip-icon { font-size: 10px; margin-bottom: 2px; color: #ccc; }
        .progress-mini { width: 80%; height: 3px; background: #444; border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; text-transform: uppercase; color: #888; font-weight: 700; letter-spacing: 0.5px; }

        .game-toast { position: absolute; top: 140px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(0, 0, 0, 0.9); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; z-index: 1001; opacity: 0; transition: all 0.3s; pointer-events: none; display: flex; align-items: center; gap: 8px; white-space: nowrap; border: 1px solid #333; }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-warn { border-color: var(--accent-orange); color: var(--accent-orange); }
        .toast-success { border-color: var(--accent-green); color: var(--accent-green); }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; z-index: 1002; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); color: #333; }

        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-top: 10px; transition: background 0.3s; }
        .slider-text { color: #999; font-weight: 600; z-index: 1; letter-spacing: 0.5px; text-transform: uppercase; font-size: 14px; }
        .slider-knob { position: absolute; left: 4px; top: 4px; bottom: 4px; width: 52px; background: var(--brand-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: grab; z-index: 2; transition: transform 0.1s; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 136, 204, 0.2); z-index: 0; }
        
        .slider-container.taxi-mode { background: #fff9c4; border: 1px solid #fbc02d; }
        .slider-container.taxi-mode .slider-knob { background: var(--taxi-yellow); color: black; }
        .slider-container.taxi-mode .slider-fill { background: rgba(255, 204, 0, 0.3); }
        .slider-container.taxi-mode .slider-text { color: #f57f17; }
        
        .slider-container.scheduled { background: #ffebee; border: 1px solid #ffcdd2; }
        .slider-container.scheduled .slider-knob { background: var(--accent-red); }
        .slider-container.scheduled .slider-text { color: var(--accent-red); }

        .controls-row { display: flex; gap: 10px; margin-top: 15px; }
        .pedal-btn { flex: 1; background: var(--brand-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 0 #006699; transition: all 0.1s; }
        .pedal-btn:active { transform: translateY(4px); box-shadow: none; }
        .pedal-btn:disabled { background: #ccc; box-shadow: none; transform: none; }
        .pedal-btn.blocked { background: var(--accent-orange); box-shadow: 0 4px 0 #e65100; cursor: not-allowed; }
        
        .pedal-btn.taxi-pedal { background: var(--taxi-black); color: var(--taxi-yellow); box-shadow: 0 4px 0 #444; }

        .bribe-btn { display:none; flex: 1; background: #222; color: #ff3d00; border: 1px solid #ff3d00; padding: 18px; border-radius: 16px; font-size: 14px; font-weight: 800; text-transform: uppercase; cursor: pointer; animation: pulse 1s infinite; }

        .bag-btn { width: 60px; background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; position: relative; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .quick-inv { position: absolute; bottom: 90px; left: 20px; width: 220px; background: #252525; color: white; padding: 10px; border-radius: 16px; z-index: 1005; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); border: 1px solid #444; }
        .quick-inv.open { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: background 0.2s; }
        .inv-item:active { background: rgba(255,255,255,0.2); }
        .inv-item.link-btn { background: var(--brand-blue); justify-content: center; font-weight: bold; }
        .inv-count { background: var(--brand-blue); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #side-menu-overlay.open { opacity: 1; pointer-events: auto; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; max-width: 320px; height: 100%; background: #1e1e1e; transition: left 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 15px; font-size: 16px; align-items: center; }
        .menu-divider { height: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .menu-section-title { font-size: 12px; color: var(--taxi-yellow); text-transform: uppercase; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px; margin-top: 10px; }
        .menu-item.locked { opacity: 0.5; cursor: not-allowed; color: #777; }
        .menu-item.taxi-item { border-bottom: 1px solid #444; }
        .menu-item.taxi-item i { width: 25px; text-align: center; }
        
        .taxi-toggle-btn { background: #333; color: #777; width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #444; font-weight: bold; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .taxi-toggle-btn.active { background: var(--taxi-yellow); color: black; border-color: var(--taxi-yellow); box-shadow: 0 0 15px rgba(255, 204, 0, 0.4); }

        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; color: black; z-index: 3000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; }

        .shop-section { margin-bottom: 25px; }
        .shop-section h3 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .shop-card { background: white; padding: 15px; border-radius: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .shop-btn { padding: 8px 14px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; border: 1px solid var(--brand-blue); color: var(--brand-blue); background: white; min-width: 80px; transition: all 0.2s; }
        .shop-btn.buy { background: var(--brand-blue); color: white; }
        .shop-btn.bought { background: var(--accent-green); border-color: var(--accent-green); color: white; transform: scale(1.05); }
        .shop-btn:disabled { background: #eee; color: #aaa; border-color: #eee; cursor: not-allowed; }

        .bank-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 24px; font-weight: bold; margin-bottom: 15px; box-sizing: border-box; }
        .bank-actions { display: flex; gap: 10px; }
        .bank-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-loan { background: var(--accent-green); color: #004d40; }
        .btn-repay { background: var(--accent-orange); color: #3e2723; }
        .debt-alert-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ef9a9a; display: none; }
        .govt-btn { background: #37474f; color: white; border-color: #37474f; }
        
        .accept-timer-bg { width: 100%; height: 6px; background: #eee; margin-top: 8px; border-radius: 3px; overflow: hidden; display: none; }
        .accept-timer-fill { height: 100%; background: var(--accent-red); width: 100%; }
        @keyframes shrinkTimer { from { width: 100%; } to { width: 0%; } }
        .animate-timer { animation: shrinkTimer 15s linear forwards; }
        .delivery-timer { font-size: 11px; color: #666; margin-top: 2px; font-weight: bold; }

        /* AUTH STYLES */
        .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .auth-title { text-align: center; color: white; font-size: 18px; margin-bottom: 20px; text-transform: uppercase; font-weight: bold; }
        .auth-input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 14px; text-transform: uppercase; }
        .btn-login { background: var(--brand-blue); color: white; }
        .btn-register { background: transparent; border: 1px solid var(--accent-green); color: var(--accent-green); margin-top: 10px; }
        .auth-footer { text-align: center; font-size: 10px; color: #666; margin-top: 15px; line-height: 1.4; }
        .close-auth { position: absolute; top: 10px; right: 10px; color: #666; font-size: 20px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <div class="balance-display">
            <div class="balance-amount" id="balance-val">0.00 PLN</div>
            <div class="balance-label">–ë–∞–ª–∞–Ω—Å <span id="debt-warning" class="debt-warning">(–î–û–õ–ì!)</span></div>
        </div>
        <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
    </div>

    <div class="equip-bar">
        <div class="equip-item"><i class="fa-solid fa-bicycle equip-icon" id="icon-vehicle"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bike" style="width: 100%"></div></div><span class="equip-label" id="label-vehicle">–í–ï–õ</span></div>
        <div class="equip-item"><i class="fa-solid fa-box-open equip-icon" id="icon-bag"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-bag" style="width: 100%"></div></div><span class="equip-label" id="label-bag">–°–£–ú–ö–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-mobile-screen equip-icon"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-phone" style="width: 100%"></div></div><span class="equip-label">–°–í–Ø–ó–¨</span></div>
        <div class="equip-item"><i class="fa-solid fa-shirt equip-icon" id="icon-gear"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-gear" style="width: 100%"></div></div><span class="equip-label" id="label-gear">–û–î–ï–ñ–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-bolt equip-icon" id="icon-energy" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy" style="background:yellow; width: 100%"></div></div><span class="equip-label" id="label-energy">–°–ò–õ–´</span></div>
        <div class="equip-item"><i class="fa-solid fa-droplet equip-icon" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water" style="background:cyan; width: 100%"></div></div><span class="equip-label">–í–û–î–ê</span></div>
        <div class="equip-item"><i class="fa-solid fa-face-smile equip-icon" style="color:#d500f9"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood" style="background:#d500f9; width: 100%"></div></div><span class="equip-label">–ù–ê–°–¢–†</span></div>
    </div>

    <div id="toast" class="game-toast"><i class="fa-solid fa-circle-info"></i> <span>Msg</span></div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-box">
            <div style="text-align:right; margin-bottom:10px;"><i class="fa-solid fa-xmark" onclick="closeAuthModal()" style="color:#888; font-size:20px; cursor:pointer"></i></div>
            <div class="auth-title"><i class="fa-solid fa-lock"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            <input type="text" id="auth-login" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn btn-login" onclick="performLogin()">–í–æ–π—Ç–∏</button>
            <button class="auth-btn btn-register" onclick="performRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <div class="auth-footer">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤–∞—à ID –≤ –æ–±–ª–∞–∫–µ.<br>
                –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å? –ù–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω—É:<br>
                <span style="color:var(--brand-blue); font-weight:bold">@TotKtoIdet</span>
            </div>
        </div>
    </div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 5px">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="player-name-display" style="font-size:18px; color:var(--brand-blue); font-weight:bold; margin-bottom:5px"></div>
            <div id="player-id-display" style="font-size:10px; color:#666; display:block; margin-bottom:20px">Loading ID...</div>
            
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store" style="color:var(--brand-blue)"></i> –ú–∞–≥–∞–∑–∏–Ω / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns" style="color:var(--accent-green)"></i> –ë–∞–Ω–∫ / –ö—Ä–µ–¥–∏—Ç</div>
            <div class="menu-item" onclick="openModal('deflation')"><i class="fa-solid fa-scale-unbalanced-flip" style="color:#90a4ae"></i> –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ / –ò–Ω—Ñ–ª—è—Ü–∏—è</div>
            <div class="menu-item" onclick="openModal('stats')"><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
            
            <div class="menu-divider"></div>
            <div class="menu-section-title">üöñ –¢–∞–∫—Å–∏ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
            <div class="menu-item taxi-item locked" id="taxi-showroom-btn" onclick="openModal('taxi-shop')">
                <i class="fa-solid fa-car" style="color:var(--taxi-yellow)"></i> –ê–≤—Ç–æ—Å–∞–ª–æ–Ω
            </div>
            <div class="menu-item taxi-item locked" id="taxi-licenses-btn" onclick="openModal('taxi-licenses')">
                <i class="fa-solid fa-id-card" style="color:#aaa"></i> –õ–∏—Ü–µ–Ω–∑–∏–∏ / –ü—Ä–∞–≤–∞
            </div>
            
            <button id="taxi-toggle-btn" class="taxi-toggle-btn" onclick="toggleTaxiMode()" style="display:none">
                <i class="fa-solid fa-taxi"></i> <span>–í–ö–õ–Æ–ß–ò–¢–¨ TAXI</span>
            </button>

            <div id="taxi-lock-msg" style="font-size:10px; color:#666; margin-left:15px; margin-top:5px; font-style:italic">
                <i class="fa-solid fa-lock"></i> –¢—Ä–µ–±—É–µ—Ç—Å—è 50 –¥–æ—Å—Ç–∞–≤–æ–∫ (–£ –≤–∞—Å: <span id="career-count">0</span>)
            </div>

            <div style="margin-top:auto">
                <div class="menu-item" id="auth-menu-item" onclick="openAuthModal()" style="display:none; color:var(--accent-green)">
                    <i class="fa-solid fa-key"></i> üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </div>

                <div class="menu-item" onclick="resetGame()" style="color:var(--accent-red); display:flex; flex-direction:column; align-items:flex-start; gap:0">
                    <div style="display:flex; gap:15px; align-items:center"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
                    <div style="font-size:10px; opacity:0.7; margin-left:35px">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ. –¶–µ–Ω–∞: 7000 PLN (–î–æ–ª–≥)</div>
                </div>
            </div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size:20px; padding:10px; cursor:pointer"></i>
            <span id="modal-title" id="modal-title">Title</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div class="bottom-sheet">
        <div id="offline-view">
            <h3 style="margin:0" id="city-label">–í–∞—Ä—à–∞–≤–∞</h3>
            <div id="demo-mode-alert" style="color:#ff3d00; font-size:11px; margin:5px 0; display:none; border:1px solid #ff3d00; padding:5px; border-radius:5px; background:rgba(0,0,0,0.05); font-weight:bold; text-align:center;">
                ‚ö†Ô∏è –î–ï–ú–û –†–ï–ñ–ò–ú: –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –±–µ–∑ –≤—Ö–æ–¥–∞!
            </div>

            <p style="color:#888; font-size:13px">–°–ø—Ä–æ—Å: –í—ã—Å–æ–∫–∏–π ‚Ä¢ –ò–Ω—Ñ–ª—è—Ü–∏—è: –ê–∫—Ç–∏–≤–Ω–∞</p>
            <div class="slider-container" id="offline-slider-box">
                <div class="slider-fill" id="offline-slider-fill"></div>
                <div class="slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–ù–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="offline-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div id="active-order-view" style="display:none; flex-direction:column; gap:10px">
            <div style="display:flex; gap:15px; align-items:center">
                <div style="font-size:24px; width:45px; height:45px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center" id="rest-icon">üçî</div>
                <div style="flex:1">
                    <h3 style="margin:0" id="rest-name">–ü–æ–∏—Å–∫...</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px">
                        <span style="font-size:12px; color:#666" id="order-dest">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                        <span id="order-offer" style="font-weight:bold; color:var(--accent-green); font-size:15px">-- PLN</span>
                    </div>
                    <div style="display:flex; justify-content:flex-end; align-items:center">
                        <span id="delivery-timer" class="delivery-timer"></span>
                    </div>
                    <div class="accept-timer-bg" id="accept-timer"><div class="accept-timer-fill" id="accept-timer-fill"></div></div>
                </div>
            </div>

            <div style="position:relative; height:30px; margin:5px 0">
                <div style="position:absolute; top:50%; left:0; right:0; height:4px; background:#eee; transform:translateY(-50%)"></div>
                <div style="position:absolute; top:50%; left:0; height:4px; background:var(--brand-blue); transform:translateY(-50%); width:0%" id="track-fill"></div>
                <div style="position:absolute; top:50%; left:0; transform:translate(-50%, -50%); width:28px; height:28px; background:white; border:2px solid var(--brand-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--brand-blue); font-size:12px; transition:left 0.2s" id="track-icon"><i class="fa-solid fa-bicycle"></i></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666">
                <span>–°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong id="temp-val">100%</strong></span>
                <span id="status-label">–ü–æ–∏—Å–∫...</span>
            </div>

            <div class="slider-container" id="online-slider-box">
                <div class="slider-fill" id="online-slider-fill"></div>
                <div class="slider-text" id="online-slider-text">–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê</div>
                <div class="slider-knob" id="online-slider-knob"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div class="quick-inv" id="quick-inv"></div>

            <div class="controls-row">
                <div class="bag-btn" onclick="toggleQuickInv()">
                    <i class="fa-solid fa-bag-shopping"></i>
                    <div class="bag-badge" id="bag-count">0</div>
                </div>
                <button class="pedal-btn" id="pedal-btn">–ñ–ú–ò –ì–ê–ó (PEDAL)</button>
                <button class="bribe-btn" id="bribe-btn" onclick="giveBribe()">–î–ê–¢–¨ –í–ó–Ø–¢–ö–£ (-20)</button>
            </div>
            <div id="garnishment-info" style="font-size:11px; color:var(--accent-red); text-align:center; display:none">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", 
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Connected");
        } catch(e) { console.error("Firebase Error:", e); }

        const SAVE_KEY = 'WARSZAWA_FOREVER';
        const TAXI_UNLOCK_REQ = 50;
        
        let gameConfig = {
            basePickupPay: 4.0, perKmPay: 1.5, payVariance: 2.0, 
            inflationRate: 0.1, trafficChance: 0.1, trafficDuration: 5000,
            energyDrain: 0.15, waterDrain: 0.10, moodDrain: 0.05, 
            deliveryTime: 60, coolingRate: 0.5, 
            tipChance: 0.5, tipBonusChance: 0.3, tipMinTemp: 60, tipMinMood: 80,
            itemPrices: {}
        };

        const ITEMS_DB = {
            bike: { name: '–í–µ–ª–æ—Å–∏–ø–µ–¥', type: 'repair', baseCost: 5, icon: 'fa-bicycle', desc: '–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ–π (+100%)' },
            bag: { name: '–°—É–º–∫–∞', type: 'repair', baseCost: 2, icon: 'fa-box-open', desc: '–ó–∞–ø–ª–∞—Ç–∫–∞ –¥—ã—Ä (+100%)' },
            phone: { name: '–°–≤—è–∑—å', type: 'repair', baseCost: 1, icon: 'fa-mobile-screen', desc: '–û–ø–ª–∞—Ç–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (+100%)' },
            gear: { name: '–û–¥–µ–∂–¥–∞', type: 'repair', baseCost: 3, icon: 'fa-shirt', desc: '–•–∏–º—á–∏—Å—Ç–∫–∞ (+100%)' },
            
            // TAXI SPECIFIC ITEMS
            car_main: { name: '–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å', type: 'repair', baseCost: 100, icon: 'fa-wrench', desc: '–†–µ–º–æ–Ω—Ç –ø–æ–¥–≤–µ—Å–∫–∏ –∏ –¢–û (+100%)' },
            car_interior: { name: '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞', type: 'repair', baseCost: 40, icon: 'fa-sparkles', desc: '–ß–∏—Å—Ç–æ—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (+100%)' },
            car_tires: { name: '–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂', type: 'repair', baseCost: 80, icon: 'fa-circle-notch', desc: '–°–º–µ–Ω–∞ —Ä–µ–∑–∏–Ω—ã (+100%)' },
            
            water: { name: '–í–æ–¥–∞ (0.5–ª)', type: 'buy', cost: 2.0, icon: 'fa-bottle-water', effect: { water: 35, energy: 5 }, desc: '–°–ø–∞—Å–∞–µ—Ç –æ—Ç –∂–∞–∂–¥—ã.', target: 'water' },
            bar: { name: '–°–Ω–∏–∫–µ—Ä—Å', type: 'buy', cost: 4.5, icon: 'fa-cookie-bite', effect: { energy: 20, mood: 15 }, desc: '–ë–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏.', target: 'energy' },
            energy_drink: { name: 'Red Bull', type: 'buy', cost: 7.0, icon: 'fa-bolt', effect: { energy: 50, mood: 5, water: -5 }, desc: '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –≠–ù–ï–†–ì–ò–ò, –Ω–æ –Ω–µ –≤–æ–¥—ã!', target: 'energy', special: 'no_drain' },
            coffee: { name: '–õ–∞—Ç—Ç–µ', type: 'buy', cost: 9.0, icon: 'fa-mug-hot', effect: { mood: 30, energy: 10 }, desc: '–î–ª—è –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!', target: 'mood' },
            chocolate: { name: '–®–æ–∫–æ–ª–∞–¥–∫–∞', type: 'buy', cost: 6.5, icon: 'fa-gift', effect: { mood: 20 }, desc: '–°—ä–µ—à—å –Ω–∞ –∑–∞–∫–∞–∑–µ - –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–æ–±—Ä–µ–µ—Ç!', target: 'mood', special: 'gift' },

            // FUEL (For taxi mode)
            gas: { name: '–ë–µ–Ω–∑–∏–Ω (10–ª)', type: 'buy', cost: 12.0, icon: 'fa-gas-pump', effect: { energy: 80 }, desc: '–ó–∞–ø—Ä–∞–≤–∫–∞ –∞–≤—Ç–æ.', target: 'energy' }
        };

        // DEFAULT STATE
        const DEFAULT_STATE = {
            name: null, 
            balance: 0, debt: 0, debtTimer: 0, debtOverdue: false,
            loanStreak: 0, 
            isOnline: false, isSearching: false, scheduledOffline: false,
            items: { bike: 100, bag: 100, phone: 100, gear: 100 },
            needs: { energy: 100, water: 100, mood: 100 },
            inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 },
            repairs: { bike: 0, bag: 0, phone: 0, gear: 0 },
            history: [],
            energyBoostActive: false,
            isAuth: false,
            career: { totalOrders: 0 },
            taxi: { unlocked: false, active: false, vehicle: null, licenses: { driver: false, insurance: false, taxi: false } }
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE)); 
        state.id = 'u_' + Math.random().toString(36).substr(2, 9);

        const restaurants = [
            { name: "McDonald's", icon: "üçî" }, { name: "KFC", icon: "üçó" },
            { name: "Pasibus", icon: "üçî" }, { name: "Kebab King", icon: "üåØ" },
            { name: "Sushi Master", icon: "üç£" }, { name: "Pizza Hut", icon: "üçï" }
        ];

        const taxiDestinations = [
            { name: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –®–æ–ø–µ–Ω", icon: "‚úàÔ∏è" }, { name: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –í–æ–∫–∑–∞–ª", icon: "üöÜ" },
            { name: "–ë–∏–∑–Ω–µ—Å –¶–µ–Ω—Ç—Ä", icon: "üè¢" }, { name: "–°—Ç–∞—Ä—ã–π –ì–æ—Ä–æ–¥", icon: "üèõ" },
            { name: "–ö–ª—É–± 'Level 27'", icon: "üç∏" }, { name: "–¢–¶ Zlote Tarasy", icon: "üõç" }
        ];
        
        const clientNames = ["–ê–Ω–Ω–∞", "–ü–µ—Ç—Ä", "–ö–∞—Å—è", "–ú–∏—Ö–∞–ª", "–û–ª—å–≥–∞", "–¢–æ–º–∞—à", "–Æ–ª–∏—è", "–Ø–∫—É–±"];
        const clientGreetings = [
            "–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Å–ø–µ—à—É –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç!", 
            "–ü—Ä–∏–≤–µ—Ç! –ù–∞ –≤–æ–∫–∑–∞–ª, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.", 
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–æ–∂–Ω–æ –ø–æ–±—ã—Å—Ç—Ä–µ–µ?", 
            "–≠–π, —à–µ—Ñ! –í —Ü–µ–Ω—Ç—Ä, –ø–ª–∞—á—É —â–µ–¥—Ä–æ!",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –Ω–∞ —Ä–∞–±–æ—Ç—É –æ–ø–∞–∑–¥—ã–≤–∞—é."
        ];

        let currentOrder = null;
        let acceptTimeout = null;
        let orderInterval = null;
        let map;
        let lastSync = 0;
        let penaltyInterval = null;

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            L.marker([52.2297, 21.0122]).addTo(map);
            
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            loadGame();

            // TELEGRAM VS ANDROID DETECTION
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                state.id = tg.initDataUnsafe.user.id.toString();
                state.name = tg.initDataUnsafe.user.first_name;
                if(tg.initDataUnsafe.user.username) {
                    state.name += ` (@${tg.initDataUnsafe.user.username})`;
                }
                saveGame();
            } else {
                if (!state.name) {
                    state.name = "Guest Courier";
                }
            }
            
            if(state.name !== "Guest Courier" && !state.isAuth) {
                state.isAuth = true; 
            }

            if(state.name === "Guest Courier" && !tg.initDataUnsafe.user) {
                document.getElementById('demo-mode-alert').style.display = 'block';
            } else {
                document.getElementById('demo-mode-alert').style.display = 'none';
            }

            document.getElementById('player-id-display').textContent = `ID: ${state.id}`;
            document.getElementById('player-name-display').textContent = state.name;
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            initSliders();
            
            setInterval(checkDebt, 1000); 
            
            // PENALTY SYSTEM FOR NEGATIVE STATS
            setInterval(checkSystemPenalties, 60000);

            listenToCloud(); syncToCloud(true);
            updateMenuState();
            updateAuthUI(); 
            updateUI(); 
        }

        function checkSystemPenalties() {
            let penalize = false;
            ['energy', 'water', 'mood'].forEach(k => { if(state.needs[k] < 0) penalize = true; });
            ['bike', 'bag', 'phone', 'gear'].forEach(k => { if(state.items[k] < 0) penalize = true; });

            if(penalize) {
                state.balance -= 1.0;
                showToast('‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï! –®—Ç—Ä–∞—Ñ -1.00 PLN', 'warn');
                saveGame(); updateUI();
            }
        }

        // AUTH FUNCTIONS
        function openAuthModal() {
            toggleMenu();
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        function performRegister() {
            const login = document.getElementById('auth-login').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();

            if(login.length < 3 || pass.length < 3) {
                showToast('–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞', 'warn');
                return;
            }

            db.ref('users_lookup/' + login).once('value', snap => {
                if(snap.exists()) {
                    showToast('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç!', 'warn');
                } else {
                    const userData = {
                        pass: pass,
                        playerId: state.id,
                        login: login
                    };

                    db.ref('users_lookup/' + login).set(userData)
                      .then(() => {
                          state.name = login; 
                          state.isAuth = true; 
                          saveGame();
                          syncToCloud(true);
                          updateUI();
                          updateAuthUI(); 
                          closeAuthModal();
                          showToast('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                          document.getElementById('player-name-display').textContent = state.name;
                          document.getElementById('demo-mode-alert').style.display = 'none';
                      });
                }
            });
        }

        function performLogin() {
            const login = document.getElementById('auth-login').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();

            db.ref('users_lookup/' + login).once('value', snap => {
                if(!snap.exists()) {
                    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warn');
                    return;
                }
                
                const data = snap.val();
                if(data.pass !== pass) {
                    showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'warn');
                    return;
                }

                const targetId = data.playerId;
                showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...', 'success');
                
                db.ref('players/' + targetId).once('value', playerSnap => {
                    let playerData = playerSnap.val();
                    if (!playerData) {
                         playerData = JSON.parse(JSON.stringify(DEFAULT_STATE));
                         playerData.name = login;
                    }
                    state = { ...DEFAULT_STATE, ...playerData };
                    state.id = targetId; 
                    state.isAuth = true;
                    
                    if(!state.items) state.items = { bike: 100, bag: 100, phone: 100, gear: 100 };
                    if(!state.needs) state.needs = { energy: 100, water: 100, mood: 100 };
                    if(!state.taxi) state.taxi = { unlocked: false, active: false, vehicle: null, licenses: { driver: false, insurance: false, taxi: false } };
                    if(!state.inventory) state.inventory = { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 };

                    saveGame(); 
                    updateUI();
                    updateMenuState();
                    updateAuthUI();
                    document.getElementById('player-id-display').textContent = `ID: ${state.id}`;
                    document.getElementById('player-name-display').textContent = state.name;
                    document.getElementById('demo-mode-alert').style.display = 'none';
                    
                    listenToCloud(); 
                    closeAuthModal();
                    showToast(`–ü—Ä–∏–≤–µ—Ç, ${state.name}!`, 'success');
                });
            });
        }

        function performLogout() {
            if(confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ, –Ω–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω.")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        function updateAuthUI() {
            const btn = document.getElementById('auth-menu-item');
            if(!btn) return;
            const tg = window.Telegram.WebApp;
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                btn.style.display = 'none';
                return;
            }
            btn.style.display = 'flex';
            const isLoggedIn = state.isAuth || (state.name && state.name !== "Guest Courier");
            if (isLoggedIn) {
                btn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> üö™ –í—ã—Ö–æ–¥';
                btn.style.color = 'var(--accent-red)';
                btn.onclick = performLogout;
            } else {
                btn.innerHTML = '<i class="fa-solid fa-key"></i> üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                btn.style.color = 'var(--accent-green)';
                btn.onclick = openAuthModal;
            }
        }

        function sendLog(msg, type='INFO') {
            if(!db) return;
            const logEntry = {
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                playerId: state.id,
                playerName: state.name || 'Anon',
                message: msg,
                type: type
            };
            db.ref('logs').push(logEntry);
        }

        function syncToCloud(force = false) {
            if (!db) return;
            const now = Date.now();
            if (force || now - lastSync > 3000) {
                db.ref('players/' + state.id).update({
                    name: state.name, 
                    balance: state.balance, isOnline: state.isOnline, lastSeen: now,
                    stats: state.needs, inventory: state.inventory, debt: state.debt, items: state.items,
                    career: state.career,
                    taxi: state.taxi,
                    isAuth: state.isAuth || false
                });
                lastSync = now;
            }
        }

        function listenToCloud() {
            if (!db) return;
            db.ref('config').on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    gameConfig = { ...gameConfig, ...val };
                    if (val.itemPrices) { 
                        for(let k in val.itemPrices) { 
                            if(ITEMS_DB[k]) ITEMS_DB[k].cost = val.itemPrices[k]; 
                        } 
                    }
                }
            });

            db.ref('players/' + state.id).off(); 
            db.ref('players/' + state.id).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                if (data.isBanned) {
                    document.body.innerHTML = `
                        <div style="display:flex;justify-content:center;align-items:center;height:100%;background:black;color:#ff3d00;font-size:20px;font-weight:bold;flex-direction:column;text-align:center;padding:20px">
                            <i class="fa-solid fa-ban" style="font-size:60px;margin-bottom:20px"></i>
                            <div style="text-transform:uppercase;letter-spacing:2px">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</div>
                        </div>`;
                    return; 
                }

                if (data.balance !== undefined && Math.abs(data.balance - state.balance) > 0.1) {
                    state.balance = data.balance;
                    updateUI();
                }
            });

            db.ref('players/' + state.id + '/adminInbox').off();
            db.ref('players/' + state.id + '/adminInbox').on('child_added', (snap) => {
                const cmd = snap.val();
                handleAdminCommand(cmd);
                snap.ref.remove();
            });
        }

        function handleAdminCommand(cmd) {
            if (cmd.type === 'SET_VAR') {
                const path = cmd.path.split('.');
                let target = state;
                for (let i = 0; i < path.length - 1; i++) {
                    if (target[path[i]] === undefined) target[path[i]] = {}; 
                    target = target[path[i]];
                }
                target[path[path.length - 1]] = cmd.value;
            }
            if (cmd.type === 'FULL_RESET') { 
                localStorage.removeItem(SAVE_KEY);
                location.reload(); 
            }
            saveGame(); updateUI();
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) {
                    state = { ...DEFAULT_STATE, ...JSON.parse(saved) };
                    if (!state.id) state.id = 'u_' + Math.random().toString(36).substr(2, 9);
                    if(!state.taxi) state.taxi = DEFAULT_STATE.taxi;
                    if(!state.career) state.career = DEFAULT_STATE.career;
                }
                state.scheduledOffline = false;
            } catch(e) {
                localStorage.removeItem(SAVE_KEY);
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                state.id = 'u_' + Math.random().toString(36).substr(2, 9);
            }
        }

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); syncToCloud(); }

        function checkDebt() {
            if (state.debt > 0 && !state.debtOverdue) {
                if (Date.now() > state.debtTimer) {
                    state.debtOverdue = true; showToast('–°–†–û–ö –ö–†–ï–î–ò–¢–ê –ò–°–¢–ï–ö! –®–¢–†–ê–§ ' + (getGarnishmentRate()*100).toFixed(0) + '%', 'warn'); updateUI();
                    if(document.getElementById('full-modal').classList.contains('open') && document.getElementById('modal-title').textContent.includes('–ë–∞–Ω–∫')) renderBank(document.getElementById('modal-body'));
                } else {
                    if(document.getElementById('full-modal').classList.contains('open') && document.getElementById('modal-title').textContent.includes('–ë–∞–Ω–∫')) {
                       updateBankTimer();
                    }
                }
            }
        }

        function getGarnishmentRate() {
            let s = state.loanStreak || 0;
            if (s === 0) return 0.10; 
            if (s === 1) return 0.20; 
            if (s === 2) return 0.30; 
            return 0.50;              
        }

        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + ' PLN';
            ['bike','bag','phone','gear'].forEach(k => updateBar(`bar-${k}`, state.items[k]));
            ['energy','water','mood'].forEach(k => updateBar(`bar-${k}`, state.needs[k]));
            const totalInv = Object.values(state.inventory).reduce((a,b)=>a+b, 0);
            document.getElementById('bag-count').textContent = totalInv;
            document.getElementById('bag-count').style.display = totalInv ? 'flex' : 'none';
            const warn = document.getElementById('debt-warning');
            const garnInfo = document.getElementById('garnishment-info');
            
            if (state.debtOverdue && state.debt > 0) { 
                warn.style.display = 'inline'; 
                garnInfo.style.display = 'block';
                garnInfo.textContent = '‚ö†Ô∏è –ü–†–û–°–†–û–ß–ö–ê! –£–¥–µ—Ä–∂–∏–≤–∞–µ–º ' + (getGarnishmentRate()*100).toFixed(0) + '% —Å –∑–∞–∫–∞–∑–∞';
            } else { 
                warn.style.display = 'none'; 
                garnInfo.style.display = 'none'; 
            }

            const isTaxi = state.taxi.active;
            const sliders = document.querySelectorAll('.slider-container');
            const pedal = document.getElementById('pedal-btn');
            
            sliders.forEach(s => {
                if(isTaxi) s.classList.add('taxi-mode');
                else s.classList.remove('taxi-mode');
            });

            const vehLabel = document.getElementById('label-vehicle');
            const vehIcon = document.getElementById('icon-vehicle');
            const bagLabel = document.getElementById('label-bag');
            const bagIcon = document.getElementById('icon-bag');
            const gearLabel = document.getElementById('label-gear');
            const gearIcon = document.getElementById('icon-gear');
            const energyLabel = document.getElementById('label-energy');
            const energyIcon = document.getElementById('icon-energy');
            const energyBar = document.getElementById('bar-energy');
            const trackIcon = document.getElementById('track-icon');

            if(isTaxi) {
                vehLabel.textContent = "–ê–í–¢–û"; vehIcon.className = "fa-solid fa-car equip-icon";
                bagLabel.textContent = "–°–ê–õ–û–ù"; bagIcon.className = "fa-solid fa-sparkles equip-icon";
                gearLabel.textContent = "–®–ò–ù–´"; gearIcon.className = "fa-solid fa-circle-notch equip-icon";
                energyLabel.textContent = "–ë–ï–ù–ó–ò–ù"; energyIcon.className = "fa-solid fa-gas-pump equip-icon";
                energyIcon.style.color = "orange"; energyBar.style.backgroundColor = "orange";
                trackIcon.innerHTML = '<i class="fa-solid fa-taxi"></i>';
                document.getElementById('city-label').innerHTML = '–í–∞—Ä—à–∞–≤–∞ <span style="font-size:10px; color:#fbc02d; border:1px solid #fbc02d; padding:0 3px; border-radius:3px">TAXI</span>';
                if(!currentOrder) pedal.textContent = "–ü–û–ò–°–ö –ö–õ–ò–ï–ù–¢–ê...";
                pedal.classList.add('taxi-pedal');
            } else {
                vehLabel.textContent = "–í–ï–õ"; vehIcon.className = "fa-solid fa-bicycle equip-icon";
                bagLabel.textContent = "–°–£–ú–ö–ê"; bagIcon.className = "fa-solid fa-box-open equip-icon";
                gearLabel.textContent = "–û–î–ï–ñ–î–ê"; gearIcon.className = "fa-solid fa-shirt equip-icon";
                energyLabel.textContent = "–°–ò–õ–´"; energyIcon.className = "fa-solid fa-bolt equip-icon";
                energyIcon.style.color = "yellow"; energyBar.style.backgroundColor = "yellow";
                trackIcon.innerHTML = '<i class="fa-solid fa-bicycle"></i>';
                document.getElementById('city-label').textContent = '–í–∞—Ä—à–∞–≤–∞';
                if(!currentOrder) pedal.textContent = "–ñ–ú–ò –ì–ê–ó (PEDAL)";
                pedal.classList.remove('taxi-pedal');
            }

            const btn = document.getElementById('taxi-toggle-btn');
            if(isTaxi) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-briefcase"></i> <span>–í–ï–†–ù–£–¢–¨–°–Ø –ö –ö–£–†–¨–ï–†–°–¢–í–£</span>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-solid fa-taxi"></i> <span>–í–ö–õ–Æ–ß–ò–¢–¨ TAXI</span>';
            }
        }

        function updateBar(id, val) { 
            // Negative value support visual
            let pct = val < 0 ? 0 : (val > 100 ? 100 : val);
            document.getElementById(id).style.width = pct + '%'; 
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast'); t.innerHTML = msg;
            t.className = 'game-toast show ' + (type === 'warn' ? 'toast-warn' : (type==='success' ? 'toast-success' : ''));
            setTimeout(() => t.className = 'game-toast', 3000);
        }

        function startOrderLoop() {
            if (orderInterval) clearInterval(orderInterval);
            orderInterval = setInterval(() => {
                if (!currentOrder || !currentOrder.accepted) return;
                currentOrder.timeLeft--;
                document.getElementById('delivery-timer').textContent = `‚è± ${currentOrder.timeLeft}—Å`;
                if (currentOrder.timeLeft <= 0) { failOrder("time"); return; }
                
                if(!state.taxi.active) {
                    let baseCooling = gameConfig.coolingRate || 0.5;
                    let decay = baseCooling * (1 + ((100 - state.items.bag) / 100));
                    currentOrder.foodTemp -= decay;
                } else {
                    let interior = state.items.bag; 
                    let decay = 0.2 + ((100 - interior) / 500);
                    currentOrder.foodTemp -= decay; 
                }
                
                if (currentOrder.foodTemp < 50 && !currentOrder.tempWarned) { showToast('‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç!', 'warn'); currentOrder.tempWarned = true; }
                
                let label = state.taxi.active ? '–ö–æ–º—Ñ–æ—Ä—Ç' : '–ï–¥–∞';
                document.getElementById('temp-val').textContent = `${label}: ` + Math.floor(currentOrder.foodTemp) + '%';
                
                if (currentOrder.foodTemp <= 0) { failOrder("cold"); return; }
            }, 1000);
        }

        function stopOrderLoop() { if (orderInterval) clearInterval(orderInterval); orderInterval = null; document.getElementById('delivery-timer').textContent = ''; }

        function failOrder(reason) {
            stopOrderLoop();
            let msg = reason === "time" ? "‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!" : "üò§ –ö–ª–∏–µ–Ω—Ç —É—à–µ–ª!";
            showToast(`${msg} –®—Ç—Ä–∞—Ñ -5.00 PLN`, 'warn');
            state.balance -= 5.00; currentOrder = null; saveGame(); updateUI(); startSearching();
        }

        function pedal() {
            if (!currentOrder) return;
            if (!currentOrder.accepted) { acceptOrder(); return; }
            
            let fatigue = Math.max(0.3, state.needs.energy / 100);
            
            if(state.taxi.active) {
                 if(state.needs.energy <= -20) {
                     showToast('‚õΩ –ë–ï–ù–ó–ò–ù –ö–û–ù–ß–ò–õ–°–Ø!', 'warn');
                     openQuickInv(true); 
                     return;
                 }
                 state.needs.energy -= 0.5; 
                 state.needs.mood -= 0.02; 
                 state.items.bike -= 0.2; 
                 state.items.gear -= 0.1; 
                 currentOrder.progress += 4; 
            } else {
                // BIKE LOGIC
                // Negative values allowed, but if too low, warn
                if (state.needs.energy <= -50 || state.needs.water <= -50) { 
                    showToast('–¢–´ –ü–†–ò –°–ú–ï–†–¢–ò! –û–¢–ö–†–û–ô –†–Æ–ö–ó–ê–ö!', 'warn'); 
                    openQuickInv(true); 
                    return; 
                }
                
                // Energy Drink Logic: Pauses Energy Drain Only
                if (!state.energyBoostActive) {
                    state.needs.energy -= gameConfig.energyDrain; 
                }
                
                // Water ALWAYS drains
                state.needs.water -= gameConfig.waterDrain; 
                state.needs.mood -= gameConfig.moodDrain;
                
                state.items.bike -= 0.1; 
                state.items.phone -= 0.05;
                currentOrder.progress += (5 * fatigue);
            }

            updateTrack(currentOrder.progress);
            
            if (Math.random() < gameConfig.trafficChance && currentOrder.stage === 2) triggerRandomEvent();
            if (currentOrder.progress >= 100) nextStage();
            saveGame(); updateUI();
        }

        function giveBribe() {
            if(state.balance < 20) { showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ –≤–∑—è—Ç–∫—É (20 PLN)', 'warn'); return; }
            state.balance -= 20;
            
            const btn = document.getElementById('pedal-btn');
            const bribeBtn = document.getElementById('bribe-btn');
            
            btn.disabled = false;
            btn.classList.remove('blocked');
            btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
            bribeBtn.style.display = 'none';
            
            showToast('üëÆ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ (-20 PLN)', 'success');
            saveGame(); updateUI();
        }

        function triggerRandomEvent() {
            const btn = document.getElementById('pedal-btn');
            const bribeBtn = document.getElementById('bribe-btn');
            
            const events = [{ text: "üöß –ü–†–û–ë–ö–ê!", time: gameConfig.trafficDuration }, { text: "üëÆ –ü–û–õ–ò–¶–ò–Ø", time: 7000 }, { text: "üöï –û–ë–™–ï–ó–î", time: 4000 }];
            const ev = events[Math.floor(Math.random()*events.length)];
            
            btn.disabled = true; btn.classList.add('blocked'); btn.textContent = ev.text; 
            
            // Show Bribe Button
            bribeBtn.style.display = 'block';
            
            showToast('–ó–∞–¥–µ—Ä–∂–∫–∞! –ñ–¥–∏ –∏–ª–∏ –ø–ª–∞—Ç–∏!', 'warn');
            
            setTimeout(() => { 
                if (currentOrder && btn.disabled) { // If still disabled (didn't bribe)
                    btn.disabled = false; btn.classList.remove('blocked'); 
                    btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)'; 
                    bribeBtn.style.display = 'none';
                } 
            }, ev.time);
        }

        function acceptOrder() {
            currentOrder.accepted = true; clearTimeout(acceptTimeout);
            document.getElementById('accept-timer').style.display = 'none';
            document.getElementById('pedal-btn').textContent = state.taxi.active ? '–ü–û–î–ê–ß–ê –ú–ê–®–ò–ù–´...' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
            document.getElementById('order-offer').style.display = 'none'; 
            startOrderLoop(); 
        }

        function missOrder() {
            state.isSearching = true; currentOrder = null; state.balance -= 0.10; 
            showToast('–ó–∞–∫–∞–∑ —É–ø—É—â–µ–Ω! –®—Ç—Ä–∞—Ñ -0.10 PLN', 'warn'); saveGame(); updateUI(); startSearching();
        }

        function nextStage() {
            currentOrder.stage++; currentOrder.progress = 0; updateTrack(0);
            if (currentOrder.stage === 1) { 
                const btn = document.getElementById('pedal-btn'); btn.disabled = true; 
                
                if(state.taxi.active) {
                    btn.textContent = '–ö–õ–ò–ï–ù–¢ –°–ê–î–ò–¢–°–Ø...';
                    document.getElementById('status-label').textContent = '–ü–æ—Å–∞–¥–∫–∞...';
                    const name = currentOrder.clientName;
                    const msg = currentOrder.clientMsg;
                    showToast(`üí¨ ${name}: "${msg}"`, 'info');
                } else {
                    btn.textContent = '–ñ–î–ï–ú –ó–ê–ö–ê–ó...';
                    document.getElementById('status-label').textContent = '–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç...';
                }

                setTimeout(() => {
                    btn.disabled = false; btn.textContent = state.taxi.active ? '–ì–ê–ó –í –ü–û–õ' : '–ñ–ú–ò –ì–ê–ó (PEDAL)';
                    document.getElementById('status-label').textContent = '–í –ø—É—Ç–∏';
                    currentOrder.stage = 2;
                }, 2000);
            } else if (currentOrder.stage === 3) { completeOrder(); }
        }

        function completeOrder() {
            stopOrderLoop();
            
            let pay = currentOrder.offerPrice; 
            const totalRepairs = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflationMult = 1 + (totalRepairs * gameConfig.inflationRate);

            let tip = 0;
            let minTemp = gameConfig.tipMinTemp || 60;
            let minMood = gameConfig.tipMinMood || 80;
            let chance = gameConfig.tipChance || 0.5;
            
            // Chocolate Bonus
            if(currentOrder.bonusHappy) {
                chance = 1.0; // Guaranteed tip chance
                minMood = -100; // Ignore my mood
                showToast('üç´ –®–æ–∫–æ–ª–∞–¥–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞!', 'success');
            }

            let tipMult = state.taxi.active ? 2.5 : 1.0;

            if (currentOrder.foodTemp > minTemp) { 
                if (Math.random() <= chance) tip += ((2 + Math.random() * 3) * inflationMult) * tipMult; 
            }
            if (state.needs.mood > minMood && currentOrder.foodTemp > 40) { 
                if (Math.random() <= 0.3) tip += (3 * inflationMult) * tipMult; 
            }
            
            let totalEarn = pay + tip;

            if (tip > 0) { 
                let msg = (state.needs.mood > 80 && currentOrder.foodTemp > 70) ? `üî• –°—É–ø–µ—Ä! +${tip.toFixed(2)} —á–∞–µ–≤—ã—Ö!` : `üëç –î–æ–≤–æ–ª–µ–Ω! +${tip.toFixed(2)} —á–∞–µ–≤—ã—Ö`; 
                showToast(msg, 'success'); 
            } 
            else if (currentOrder.foodTemp < 50) { 
                showToast('–ö–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ–≤–æ–ª–µ–Ω... –ë–µ–∑ —á–∞–µ–≤—ã—Ö.', 'warn'); 
            }

            if(!state.taxi.active) {
                state.items.bag -= 1.5; state.items.gear -= 0.8;
            } else {
                state.items.bike -= 1.0; 
                state.items.bag -= 2.0; 
            }
            
            if (state.debtOverdue && state.debt > 0) {
                const rate = getGarnishmentRate();
                let penalty = totalEarn * rate; 
                
                if (penalty > state.debt) penalty = state.debt;
                state.debt -= penalty; totalEarn -= penalty; 
                showToast(`–î–æ–ª–≥ (-${(rate*100).toFixed(0)}%): -${penalty.toFixed(2)} PLN`, 'warn');
            }
            
            state.balance += totalEarn; 
            state.career.totalOrders++;
            updateMenuState(); 

            state.history.push({ 
                rest: currentOrder.rest.name, 
                pay: pay, 
                tip: tip, 
                total: pay + tip 
            });
            
            sendLog(`–ó–∞–≤–µ—Ä—à–∏–ª –∑–∞–∫–∞–∑: +${(pay+tip).toFixed(2)} PLN`, 'ORDER');

            setTimeout(() => { showToast(`+${(pay+tip).toFixed(2)} PLN`, 'success'); }, 500);
            if (state.scheduledOffline) { goOffline(); } else { startSearching(); }
            saveGame(); syncToCloud(true); updateUI();
        }

        function startSearching() {
            if (state.scheduledOffline) { goOffline(); return; }
            if (!state.isOnline) return;

            stopOrderLoop(); state.isSearching = true;
            document.getElementById('active-order-view').style.display = 'flex';
            document.getElementById('rest-name').textContent = '–ü–æ–∏—Å–∫...';
            document.getElementById('rest-icon').textContent = 'üîç';
            document.getElementById('status-label').textContent = '–ò—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞...';
            document.getElementById('order-dest').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            document.getElementById('order-offer').textContent = '-- PLN'; 
            document.getElementById('accept-timer').style.display = 'none';
            document.getElementById('delivery-timer').textContent = '';
            document.getElementById('bribe-btn').style.display = 'none';
            resetSlider('online');
            const box = document.getElementById('online-slider-box');
            const txt = document.getElementById('online-slider-text');
            box.classList.remove('scheduled'); txt.textContent = "–°–í–ê–ô–ü –î–õ–Ø –û–§–õ–ê–ô–ù–ê";
            document.getElementById('pedal-btn').disabled = true;
            document.getElementById('pedal-btn').textContent = '–ü–û–ò–°–ö...';
            updateTrack(0);
            setTimeout(() => { 
                if (state.isOnline && state.isSearching && !state.scheduledOffline) createOrder(); 
            }, 2000);
            syncToCloud(); 
        }

        function createOrder() {
            if (!state.isOnline) return;
            state.isSearching = false;
            
            let r;
            if(state.taxi.active) {
                 r = taxiDestinations[Math.floor(Math.random() * taxiDestinations.length)];
            } else {
                 r = restaurants[Math.floor(Math.random() * restaurants.length)];
            }
            
            const dist = (0.8 + Math.random() * 5.7).toFixed(1);
            
            const totalRepairs = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflationMult = 1 + (totalRepairs * gameConfig.inflationRate);
            
            let rawPay = (gameConfig.basePickupPay || 4.0) + (dist * (gameConfig.perKmPay || 1.5));
            let finalOffer = rawPay * inflationMult;
            
            if(state.taxi.active) {
                finalOffer = finalOffer * 4.0; 
            }
            
            finalOffer += (Math.random() * gameConfig.payVariance) - (gameConfig.payVariance / 2);
            if(finalOffer < 2) finalOffer = 2; 

            let time = gameConfig.deliveryTime || 60;
            currentOrder = { 
                rest: r, 
                progress: 0, 
                stage: 0, 
                foodTemp: 100, 
                accepted: false, 
                timeLeft: time, 
                tempWarned: false,
                distance: dist,
                offerPrice: finalOffer,
                clientName: clientNames[Math.floor(Math.random() * clientNames.length)],
                clientMsg: clientGreetings[Math.floor(Math.random() * clientGreetings.length)],
                bonusHappy: false
            };

            document.getElementById('rest-name').textContent = state.taxi.active ? `–ó–∞–∫–∞–∑: ${r.name}` : `–ï–¥–µ–º –≤ ${r.name}`;
            document.getElementById('rest-icon').textContent = r.icon;
            document.getElementById('status-label').textContent = 'üî• –ü–†–ò–ú–ò –í–´–ó–û–í! üî•';
            document.getElementById('order-dest').textContent = state.taxi.active ? `–ü–æ–µ–∑–¥–∫–∞: ${dist} km` : `–ó–∞–±—Ä–∞—Ç—å: ${dist} km`;
            const offerEl = document.getElementById('order-offer');
            offerEl.style.display = 'block';
            offerEl.textContent = `üí∞ ${finalOffer.toFixed(2)} PLN`;

            document.getElementById('pedal-btn').textContent = state.taxi.active ? '–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í' : '–ü–†–ò–ù–Ø–¢–¨ –ó–ê–ö–ê–ó';
            document.getElementById('pedal-btn').disabled = false;
            const bar = document.getElementById('accept-timer');
            const fill = document.getElementById('accept-timer-fill');
            bar.style.display = 'block';
            fill.classList.remove('animate-timer');
            void fill.offsetWidth; fill.classList.add('animate-timer');
            acceptTimeout = setTimeout(missOrder, 15000); 
            resetSlider('online');
            const box = document.getElementById('online-slider-box');
            const txt = document.getElementById('online-slider-text');
            box.classList.add('scheduled'); txt.textContent = "–ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–¢–¨ –û–§–õ–ê–ô–ù";
        }

        function goOffline() {
            state.isOnline = false; state.isSearching = false; state.scheduledOffline = false;
            stopOrderLoop(); if (acceptTimeout) clearTimeout(acceptTimeout);
            document.getElementById('active-order-view').style.display = 'none';
            document.getElementById('offline-view').style.display = 'block';
            resetSlider('offline'); saveGame(); syncToCloud();
            sendLog('–£—à–µ–ª —Å –ª–∏–Ω–∏–∏ (–û—Ñ–ª–∞–π–Ω)', 'STATUS');
        }

        function initSliders() {
            setupSlider('offline', () => { 
                state.isOnline = true; 
                document.getElementById('offline-view').style.display = 'none'; 
                startSearching(); 
                sendLog(`–í—ã—à–µ–ª –Ω–∞ –ª–∏–Ω–∏—é (${state.taxi.active?'TAXI':'BIKE'})`, 'STATUS');
            });
            setupSlider('online', () => {
                if (state.isSearching) { goOffline(); }
                else {
                    state.scheduledOffline = true;
                    saveGame(); 
                    const box = document.getElementById('online-slider-box');
                    const txt = document.getElementById('online-slider-text');
                    box.classList.add('scheduled'); txt.textContent = "–û–§–õ–ê–ô–ù –ü–û–°–õ–ï –ó–ê–ö–ê–ó–ê";
                    resetSlider('online');
                }
            });
        }

        function setupSlider(prefix, callback) {
            const knob = document.getElementById(`${prefix}-slider-knob`);
            const box = document.getElementById(`${prefix}-slider-box`);
            const fill = document.getElementById(`${prefix}-slider-fill`);
            let isDragging = false, startX = 0;
            knob.addEventListener('mousedown', start); knob.addEventListener('touchstart', start);
            function start(e) { isDragging = true; startX = (e.type === 'mousedown') ? e.clientX : e.touches[0].clientX; document.addEventListener('mousemove', move); document.addEventListener('touchmove', move); document.addEventListener('mouseup', end); document.addEventListener('touchend', end); }
            function move(e) { if (!isDragging) return; const clientX = (e.type === 'mousemove') ? e.clientX : e.touches[0].clientX; let x = clientX - startX; let max = box.offsetWidth - knob.offsetWidth - 8; x = Math.max(0, Math.min(x, max)); knob.style.transform = `translateX(${x}px)`; fill.style.width = `${(x / max) * 100}%`; if (x >= max * 0.95) { isDragging = false; end(); callback(); } }
            function end() { isDragging = false; document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); knob.style.transform = 'translateX(0)'; fill.style.width = '0%'; }
        }

        function resetSlider(prefix) { document.getElementById(`${prefix}-slider-knob`).style.transform = 'translateX(0)'; document.getElementById(`${prefix}-slider-fill`).style.width = '0%'; }

        function toggleQuickInv() { const menu = document.getElementById('quick-inv'); menu.style.display === 'flex' ? menu.style.display = 'none' : openQuickInv(); }
        function openQuickInv(forced = false) {
            const menu = document.getElementById('quick-inv'); menu.innerHTML = '';
            
            let owned = [];
            for (let [k, c] of Object.entries(state.inventory)) { 
                if (c > 0) {
                     const itemData = ITEMS_DB[k];
                     if(state.taxi.active) {
                         owned.push({ k, c, data: itemData });
                     } else {
                         if(k !== 'gas') owned.push({ k, c, data: itemData });
                     }
                } 
            }
            
            if (owned.length === 0) { menu.innerHTML = `<div style="padding:5px; color:#fff; text-align:center; font-size:12px">–ü—É—Å—Ç–æ!</div><div class="inv-item link-btn" onclick="openModal('shop')">–í –ú–ê–ì–ê–ó–ò–ù</div>`; }
            else {
                owned.forEach(item => {
                    const div = document.createElement('div'); div.className = 'inv-item';
                    div.innerHTML = `<span><i class="fa-solid ${item.data.icon}"></i> ${item.data.name}</span><span class="inv-count">x${item.c}</span>`;
                    div.onclick = () => useItem(item.k); menu.appendChild(div);
                });
            }
            menu.style.display = 'flex'; menu.classList.add('open');
        }

        function useItem(key) {
            const item = ITEMS_DB[key]; 
            if(state.inventory[key] <= 0) return;
            state.inventory[key]--;

            // New Mechanic: CHOCOLATE (Gift)
            if (item.special === 'gift') {
                if (currentOrder && !currentOrder.bonusHappy) {
                    currentOrder.bonusHappy = true;
                    showToast('–®–æ–∫–æ–ª–∞–¥–∫–∞ –≤—Ä—É—á–µ–Ω–∞! –ö–ª–∏–µ–Ω—Ç —Å—á–∞—Å—Ç–ª–∏–≤!', 'success');
                } else if (!currentOrder) {
                    state.needs.mood += item.effect.mood;
                    showToast('–°—ä–µ–ª —à–æ–∫–æ–ª–∞–¥–∫—É —Å–∞–º. –í–∫—É—Å–Ω–æ!', 'success');
                } else {
                    showToast('–ö–ª–∏–µ–Ω—Ç —É–∂–µ –¥–æ–≤–æ–ª–µ–Ω!', 'warn');
                    state.inventory[key]++; // Return item
                    return;
                }
            }
            else {
                // ADDITIVE LOGIC (Can repair from negative)
                if (item.effect.energy) state.needs.energy += item.effect.energy;
                if (item.effect.water) state.needs.water += item.effect.water;
                if (item.effect.mood) state.needs.mood += item.effect.mood;
            }

            if (item.special === 'no_drain') {
                state.energyBoostActive = true; showToast('üöÄ –≠–ù–ï–†–ì–ï–¢–ò–ö: –£—Å—Ç–∞–ª–æ—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                setTimeout(() => { state.energyBoostActive = false; showToast('–î–µ–π—Å—Ç–≤–∏–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å', 'info'); }, 30000);
            }
            
            // Limit max to 100, but allow negative start
            ['energy','water','mood'].forEach(k => { if(state.needs[k]>100) state.needs[k]=100; });
            
            toggleQuickInv(); saveGame(); updateUI();
        }

        function toggleMenu() { 
            updateMenuState();
            document.getElementById('side-menu-overlay').classList.toggle('open'); 
            document.getElementById('side-menu').classList.toggle('open'); 
        }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }
        function openModal(type) {
            toggleMenu(); 
            const m = document.getElementById('full-modal'); const b = document.getElementById('modal-body'); m.classList.add('open');
            if (type === 'shop') { document.getElementById('modal-title').textContent = '–ú–∞–≥–∞–∑–∏–Ω'; renderShop(b); }
            else if (type === 'bank') { document.getElementById('modal-title').textContent = '–ë–∞–Ω–∫ (–ö—Ä–µ–¥–∏—Ç)'; renderBank(b); }
            else if (type === 'deflation') { document.getElementById('modal-title').textContent = '–ë–æ—Ä—å–±–∞ —Å –∏–Ω—Ñ–ª—è—Ü–∏–µ–π'; renderDeflation(b); }
            else if (type === 'taxi-shop') { document.getElementById('modal-title').textContent = '–ê–≤—Ç–æ—Å–∞–ª–æ–Ω'; renderTaxiShop(b); }
            else if (type === 'taxi-licenses') { document.getElementById('modal-title').textContent = '–õ–∏—Ü–µ–Ω–∑–∏–∏ –∏ –î–æ–∫—É–º–µ–Ω—Ç—ã'; renderTaxiLicenses(b); }
            else { document.getElementById('modal-title').textContent = '–ò—Å—Ç–æ—Ä–∏—è'; renderHistory(b); }
        }

        function updateMenuState() {
            const total = state.career.totalOrders;
            document.getElementById('career-count').textContent = total;
            const isUnlocked = state.taxi.unlocked || total >= TAXI_UNLOCK_REQ;
            const btns = document.querySelectorAll('.taxi-item');
            const msg = document.getElementById('taxi-lock-msg');
            const toggleBtn = document.getElementById('taxi-toggle-btn');
            
            if (isUnlocked) {
                btns.forEach(b => { 
                    b.classList.remove('locked'); 
                    b.onclick = null; 
                    if(b.id === 'taxi-showroom-btn') b.onclick = () => openModal('taxi-shop');
                    if(b.id === 'taxi-licenses-btn') b.onclick = () => openModal('taxi-licenses');
                });
                msg.style.display = 'none';

                const hasCar = state.taxi.vehicle !== null;
                const hasLic = state.taxi.licenses.driver && state.taxi.licenses.insurance && state.taxi.licenses.taxi;
                
                if(hasCar && hasLic) {
                    toggleBtn.style.display = 'flex';
                } else {
                    toggleBtn.style.display = 'none';
                }

            } else {
                btns.forEach(b => { 
                    b.classList.add('locked'); 
                    b.onclick = showLockedMsg; 
                });
                msg.style.display = 'block';
                toggleBtn.style.display = 'none';
            }
        }

        function showLockedMsg() {
            showToast(`–ù—É–∂–Ω–æ ${TAXI_UNLOCK_REQ} –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤!`, 'warn');
        }

        function toggleTaxiMode() {
            if (!state.taxi.vehicle || !state.taxi.licenses.driver || !state.taxi.licenses.insurance) {
                showToast('–ö—É–ø–∏—Ç–µ –º–∞—à–∏–Ω—É –∏ –ª–∏—Ü–µ–Ω–∑–∏–∏!', 'warn');
                return;
            }

            if(state.isOnline) {
                showToast('–°–Ω–∞—á–∞–ª–∞ —É–π–¥–∏ –≤ –æ—Ñ–ª–∞–π–Ω!', 'warn');
                return;
            }

            state.taxi.active = !state.taxi.active;
            saveGame();
            updateUI();
            updateMenuState();
            
            let msg = state.taxi.active ? 'üöï –†–ï–ñ–ò–ú –¢–ê–ö–°–ò –í–ö–õ–Æ–ß–ï–ù' : 'üö≤ –†–ï–ñ–ò–ú –ö–£–†–¨–ï–†–ê –í–ö–õ–Æ–ß–ï–ù';
            showToast(msg, 'success');
        }

        // --- TAXI SYSTEM LOGIC ---
        
        function renderTaxiShop(c) {
            const owned = state.taxi.vehicle;
            const cars = [
                { id: 'skoda', name: 'Skoda Fabia (LPG)', price: 15000, desc: '–ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—á–∞—è –ª–æ—à–∞–¥–∫–∞. –î–µ—à–µ–≤—ã–π —Ä–µ–º–æ–Ω—Ç.', icon: 'fa-car-side' },
                { id: 'toyota', name: 'Toyota Prius (Hybrid)', price: 45000, desc: '–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–ø–ª–∏–≤–∞ –∏ —Ö–æ—Ä–æ—à–∏–π —á–∞–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤.', icon: 'fa-car' },
                { id: 'tesla', name: 'Tesla Model 3', price: 120000, desc: '–ü—Ä–µ—Å—Ç–∏–∂. –î–æ—Å—Ç—É–ø –∫ VIP –∑–∞–∫–∞–∑–∞–º.', icon: 'fa-bolt' }
            ];

            let html = '<div style="text-align:center; padding:10px; color:#666; font-size:12px">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ç–∞–∫—Å–∏.</div>';
            
            cars.forEach(car => {
                const isOwned = (owned === car.id);
                const btnClass = isOwned ? 'shop-btn bought' : 'shop-btn buy';
                const btnText = isOwned ? '–ö–£–ü–õ–ï–ù–û' : `${car.price.toLocaleString()} PLN`;
                const action = isOwned ? '' : `onclick="buyVehicle('${car.id}', ${car.price})"`;
                
                html += `
                <div class="shop-card">
                    <div><div style="font-weight:bold"><i class="fa-solid ${car.icon}"></i> ${car.name}</div><div class="shop-desc">${car.desc}</div></div>
                    <button class="${btnClass}" ${action} ${isOwned ? 'disabled' : ''}>${btnText}</button>
                </div>`;
            });
            c.innerHTML = html;
        }

        function renderTaxiLicenses(c) {
            const l = state.taxi.licenses;
            
            const licenses = [
                { id: 'driver', name: '–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ (B)', price: 2500 },
                { id: 'insurance', name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ OC/AC', price: 1200 },
                { id: 'taxi', name: '–õ–∏—Ü–µ–Ω–∑–∏—è –¢–∞–∫—Å–∏', price: 5000 }
            ];

            let html = '';
            licenses.forEach(lic => {
                const hasIt = l[lic.id];
                const btnClass = hasIt ? 'shop-btn bought' : 'shop-btn buy';
                const btnText = hasIt ? '–ï–°–¢–¨' : `${lic.price.toLocaleString()} PLN`;
                const action = hasIt ? '' : `onclick="buyLicense('${lic.id}', ${lic.price})"`;

                html += `
                <div class="shop-card">
                    <div><div style="font-weight:bold">${lic.name}</div></div>
                    <button class="${btnClass}" ${action} ${hasIt ? 'disabled' : ''}>${btnText}</button>
                </div>`;
            });
            c.innerHTML = html;
        }

        function buyVehicle(id, price) {
            if (state.balance >= price) {
                state.balance -= price;
                state.taxi.vehicle = id;
                showToast('üöó –ú–∞—à–∏–Ω–∞ –∫—É–ø–ª–µ–Ω–∞! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', 'success');
                sendLog(`–ö—É–ø–∏–ª –º–∞—à–∏–Ω—É: ${id}`, 'BUY');
                saveGame(); syncToCloud(true); updateUI();
                renderTaxiShop(document.getElementById('modal-body'));
                updateMenuState(); 
            } else {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'warn');
            }
        }

        function buyLicense(id, price) {
            if (state.balance >= price) {
                state.balance -= price;
                state.taxi.licenses[id] = true;
                showToast('üìÑ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω!', 'success');
                sendLog(`–ö—É–ø–∏–ª –ª–∏—Ü–µ–Ω–∑–∏—é: ${id}`, 'BUY');
                saveGame(); syncToCloud(true); updateUI();
                renderTaxiLicenses(document.getElementById('modal-body'));
                updateMenuState(); 
            } else {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'warn');
            }
        }

        function renderShop(c) {
            let html = '';
            const levelSum = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflation = 1 + (levelSum * gameConfig.inflationRate); 
            
            html += '<div class="shop-section"><h3>üéí –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</h3>';
            ['chocolate', 'gas', 'water', 'bar', 'energy_drink', 'coffee'].forEach(k => {
                if(state.taxi.active) {
                    if(k !== 'gas' && k !== 'coffee' && k !== 'water' && k !== 'bar' && k !== 'energy_drink' && k !== 'chocolate') return; 
                } else {
                    if(k === 'gas') return; 
                }

                const i = ITEMS_DB[k];
                const price = i.cost * inflation;
                const owned = state.inventory[k] || 0;
                html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} <span style="font-size:11px; color:#009de0; font-weight:normal">(–í –Ω–∞–ª–∏—á–∏–∏: ${owned})</span></div><div class="shop-desc">${i.desc}</div></div><button class="shop-btn buy" onclick="buyItem('${k}', ${price}, this)">${price.toFixed(1)}</button></div>`;
            });
            html += '</div>';

            html += '<div class="shop-section"><h3>üõ† –°–µ—Ä–≤–∏—Å (–†–µ–º–æ–Ω—Ç)</h3>';
            
            let repairKeys = [];
            if(state.taxi.active) {
                const carItems = [
                    { key: 'bike', db: ITEMS_DB.car_main },      
                    { key: 'bag', db: ITEMS_DB.car_interior },   
                    { key: 'gear', db: ITEMS_DB.car_tires }      
                ];

                carItems.forEach(obj => {
                    const i = obj.db;
                    const base = i.baseCost + ((state.repairs[obj.key]||0)*2.0); 
                    const price = base * inflation;
                    const currentHealth = Math.floor(state.items[obj.key]);
                    
                    // REPAIR IS ALWAYS AVAILABLE NOW if not 100%
                    const btnText = `–†–µ–º–æ–Ω—Ç (+100%) -${price.toFixed(1)}`;
                    
                    html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} (Lvl ${state.repairs[obj.key]||0})</div><div class="shop-desc" style="color:${currentHealth<0?'red':'black'}">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentHealth}%</div></div><button class="shop-btn" onclick="buyRepair('${obj.key}', ${price}, this)">${btnText}</button></div>`;
                });

            } else {
                ['bike', 'bag', 'phone', 'gear'].forEach(k => {
                    const i = ITEMS_DB[k];
                    const base = i.baseCost + ((state.repairs[k]||0)*0.5);
                    const price = base * inflation;
                    const currentHealth = Math.floor(state.items[k]);
                    
                    const btnText = `–†–µ–º–æ–Ω—Ç (+100%) -${price.toFixed(1)}`;
                    
                    html += `<div class="shop-card"><div><div style="font-weight:bold">${i.name} (Lvl ${state.repairs[k]||0})</div><div class="shop-desc" style="color:${currentHealth<0?'red':'black'}">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentHealth}%</div></div><button class="shop-btn" onclick="buyRepair('${k}', ${price}, this)">${btnText}</button></div>`;
                });
            }
            html += '</div>'; c.innerHTML = html;
        }

        function renderDeflation(c) {
            const levelSum = Object.values(state.repairs).reduce((a,b)=>a+b,0);
            const inflation = 1 + (levelSum * gameConfig.inflationRate);
            const cost1 = 2700 * inflation; const cost2 = 5000 * inflation;
            c.innerHTML = `<div style="text-align:center; padding:20px 0;"><i class="fa-solid fa-scale-unbalanced-flip" style="font-size:40px; color:#90a4ae"></i><h2>–ò–Ω—Ñ–ª—è—Ü–∏—è: ${((inflation-1)*100).toFixed(0)}%</h2><p style="color:#666; font-size:14px">–°–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ñ–ª—è—Ü–∏–∏ —É–º–µ–Ω—å—à–∞–µ—Ç —Ü–µ–Ω—ã –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö, –Ω–æ —Å—Ç–æ–∏—Ç –±–æ–ª—å—à–∏—Ö –¥–µ–Ω–µ–≥.</p></div><div class="shop-card"><div><div style="font-weight:bold">–û—Ç–∫–∞—Ç (-1 —É—Ä–æ–≤–µ–Ω—å)</div><div class="shop-desc">–°–Ω–∏–∂–∞–µ—Ç —Ü–µ–Ω—ã –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥</div></div><button class="shop-btn govt-btn" onclick="buyDeflation(1, ${cost1})">-${cost1.toFixed(0)}</button></div><div class="shop-card"><div><div style="font-weight:bold">–°–∏–ª—å–Ω—ã–π –æ—Ç–∫–∞—Ç (-2 —É—Ä.)</div><div class="shop-desc">–°–µ—Ä—å–µ–∑–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω</div></div><button class="shop-btn govt-btn" onclick="buyDeflation(2, ${cost2})">-${cost2.toFixed(0)}</button></div>`;
        }

        function buyItem(k, cost, btn) {
            if(state.balance >= cost) { 
                state.balance-=cost; 
                state.inventory[k]=(state.inventory[k]||0)+1; 
                const originalText = btn.textContent; btn.textContent = '–ö–£–ü–õ–ï–ù–û!'; btn.className = 'shop-btn bought'; 
                sendLog(`–ö—É–ø–∏–ª: ${ITEMS_DB[k].name} –∑–∞ ${cost.toFixed(2)}`, 'BUY');
                setTimeout(() => { btn.textContent = originalText; btn.className = 'shop-btn buy'; renderShop(document.getElementById('modal-body')); }, 600); 
                saveGame(); syncToCloud(true); updateUI(); 
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn');
        }

        function buyRepair(k, cost, btn) {
            if(state.balance >= cost) { 
                state.balance-=cost; 
                
                // FIXED LOGIC: ADDITIVE REPAIR
                state.items[k] += 100;
                if(state.items[k] > 100) state.items[k] = 100;
                
                state.repairs[k]=(state.repairs[k]||0)+1; 
                btn.textContent = '–ì–û–¢–û–í–û!'; btn.className = 'shop-btn bought'; 
                
                let itemName = ITEMS_DB[k] ? ITEMS_DB[k].name : 'Repair';
                if(state.taxi.active) {
                    if(k==='bike') itemName = ITEMS_DB.car_main.name;
                    if(k==='bag') itemName = ITEMS_DB.car_interior.name;
                    if(k==='gear') itemName = ITEMS_DB.car_tires.name;
                }

                sendLog(`–ü–æ—á–∏–Ω–∏–ª: ${itemName}`, 'REPAIR');
                setTimeout(() => { renderShop(document.getElementById('modal-body')); }, 600); saveGame(); syncToCloud(true); updateUI(); 
            } else showToast('–ù–µ—Ç –¥–µ–Ω–µ–≥','warn');
        }

        function buyDeflation(levels, cost) {
            if (state.balance < cost) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'warn'); return; }
            let reduced = 0;
            for (let i = 0; i < levels; i++) { const key = Object.keys(state.repairs).find(k => state.repairs[k] > 0); if (key) { state.repairs[key]--; reduced++; } }
            if (reduced > 0) { state.balance -= cost; showToast(`–ò–Ω—Ñ–ª—è—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ ${reduced} —É—Ä.!`, 'success'); saveGame(); syncToCloud(true); updateUI(); renderDeflation(document.getElementById('modal-body')); } else { showToast('–ò–Ω—Ñ–ª—è—Ü–∏—è —É–∂–µ –Ω–∞ –º–∏–Ω–∏–º—É–º–µ!', 'warn'); }
        }

        function renderBank(c) {
            let timeLeftStr = "00:00";
            if(state.debt > 0 && !state.debtOverdue) {
                let diff = Math.max(0, state.debtTimer - Date.now());
                let m = Math.floor(diff / 60000); let s = Math.floor((diff % 60000) / 1000);
                timeLeftStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            if(document.getElementById('bank-ui-root')) {
                updateBankTimer(); 
                return;
            }

            let interestRate = 0;
            let streak = state.loanStreak || 0;
            if (streak === 0) interestRate = 0;      
            else if (streak === 1) interestRate = 10; 
            else if (streak === 2) interestRate = 20; 
            else interestRate = 50;  

            const limit = 1000 + (state.career.totalOrders * 50);

            const hasFood = (state.inventory.bar > 0 || state.inventory.water > 0 || state.inventory.energy_drink > 0);
            const isCrisis = state.balance < 5 && !hasFood;
            
            let sosHtml = '';
            if (isCrisis) {
                sosHtml = `
                <div style="margin-bottom:15px; padding:10px; background:#37474f; border:1px border:#cfd8dc; border-radius:10px; text-align:center">
                    <div style="color:#ff9100; font-weight:bold; font-size:12px; margin-bottom:5px">üÜò –ü–ê–ö–ï–¢ –í–´–ñ–ò–í–ê–ù–ò–Ø</div>
                    <div style="font-size:11px; color:#b0bec5">–í–æ–¥–∞ + –°–Ω–∏–∫–µ—Ä—Å. –¶–µ–Ω–∞ x2 –≤ –¥–æ–ª–≥.</div>
                    <button class="bank-btn" style="background:#ff3d00; color:white; margin-top:5px; padding:8px" onclick="takeSOS()">–í–ó–Ø–¢–¨ (–î–û–õ–ì x2)</button>
                </div>`;
            }

            const garnishmentPercent = (getGarnishmentRate() * 100).toFixed(0);

            c.innerHTML = `
                <div id="bank-ui-root">
                    <div class="debt-alert-box" id="bank-alert" style="display:${state.debtOverdue?'block':'none'}">‚ö†Ô∏è <strong>–ü–†–û–°–†–û–ß–ï–ù–û!</strong><br>–£–¥–µ—Ä–∂–∏–≤–∞–µ–º ${garnishmentPercent}% —Å –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞.</div>
                    
                    <div style="text-align:center; margin-bottom:20px">
                        <div style="font-size:14px; color:#666">–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥</div>
                        <div style="font-size:32px; font-weight:800; color:${state.debt>0?'var(--accent-red)':'#333'}" id="bank-debt-display">${state.debt.toFixed(2)} PLN</div>
                        <div style="font-size:12px; color:${state.debtOverdue?'red':'#00c853'}; font-weight:bold; margin-top:5px" id="bank-timer-display">
                            ${state.debt > 0 ? (state.debtOverdue ? '–í–ó–´–°–ö–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û' : '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ' + timeLeftStr) : '–ù–µ—Ç –¥–æ–ª–≥–æ–≤'}
                        </div>
                    </div>
                    
                    <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:12px">
                        –í–∞—à –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç: <span style="color:white; font-weight:bold">${limit.toLocaleString()} PLN</span>
                    </div>

                    ${sosHtml}

                    <div style="background:#f5f5f5; padding:10px; border-radius:10px; margin-bottom:10px">
                        <div style="font-size:11px; color:#666; margin-bottom:5px">–£–°–õ–û–í–ò–Ø –ö–†–ï–î–ò–¢–ê:</div>
                        <div style="display:flex; justify-content:space-between; font-size:13px">
                            <span>–ü–æ–ø—ã—Ç–∫–∞ ‚Ññ${streak + 1}</span>
                            <span style="font-weight:bold; color:${interestRate>0?'var(--accent-red)':'var(--accent-green)'}">–ö–æ–º–∏—Å—Å–∏—è: +${interestRate}%</span>
                        </div>
                    </div>

                    <input type="number" id="loan-amount" class="bank-input" placeholder="–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞...">
                    <div class="bank-actions">
                        <button class="bank-btn btn-loan" onclick="takeLoan()">–í–ó–Ø–¢–¨</button>
                        ${state.debt > 0 ? '<button class="bank-btn btn-repay" onclick="repayLoan()">–í–ï–†–ù–£–¢–¨</button>' : ''}
                    </div>
                </div>
            `;
        }

        function updateBankTimer() {
            const timerDisplay = document.getElementById('bank-timer-display');
            const debtDisplay = document.getElementById('bank-debt-display');
            
            let timeStr = "00:00";
            if(state.debt > 0 && !state.debtOverdue) {
                let diff = Math.max(0, state.debtTimer - Date.now());
                let m = Math.floor(diff / 60000); let s = Math.floor((diff % 60000) / 1000);
                timeStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            if(timerDisplay) {
                if(state.debt > 0) {
                    timerDisplay.textContent = state.debtOverdue ? '–í–ó–´–°–ö–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û' : '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: ' + timeStr;
                    timerDisplay.style.color = state.debtOverdue ? 'red' : '#00c853';
                    document.getElementById('bank-alert').style.display = state.debtOverdue ? 'block' : 'none';
                } else {
                    timerDisplay.textContent = '–ù–µ—Ç –¥–æ–ª–≥–æ–≤';
                    document.getElementById('bank-alert').style.display = 'none';
                }
            }
            if(debtDisplay) debtDisplay.textContent = state.debt.toFixed(2) + ' PLN';
        }

        function takeSOS() {
            const costWater = (ITEMS_DB.water.cost || 2.0);
            const costBar = (ITEMS_DB.bar.cost || 4.5);
            const totalVal = costWater + costBar;
            const debtIncrease = totalVal * 2;

            state.inventory.water = (state.inventory.water || 0) + 1;
            state.inventory.bar = (state.inventory.bar || 0) + 1;

            state.debt += debtIncrease;
            
            if (state.debtTimer === 0 || state.debt <= debtIncrease) {
                state.debtTimer = Date.now() + (5 * 60 * 1000); 
                state.debtOverdue = false;
            }

            showToast(`üÜò SOS –ø–æ–ª—É—á–µ–Ω! –î–æ–ª–≥ +${debtIncrease.toFixed(2)} PLN`, 'warn');
            sendLog(`–í–∑—è–ª SOS –ø–∞–∫–µ—Ç. –î–æ–ª–≥ +${debtIncrease}`, 'LOAN');
            
            document.getElementById('modal-body').innerHTML = ''; 
            renderBank(document.getElementById('modal-body')); 
            saveGame(); syncToCloud(true); updateUI();
        }

        function takeLoan() {
            const input = document.getElementById('loan-amount'); 
            const amt = parseFloat(input.value);
            if (!amt || amt <= 0) return;

            const limit = 1000 + (state.career.totalOrders * 50);

            if (state.debt > 0.1) {
                showToast('‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–¥–∏—Ç!', 'warn');
                return;
            }

            if (amt > limit) {
                showToast(`‚õî –õ–∏–º–∏—Ç –¥–æ–≤–µ—Ä–∏—è: ${limit} PLN. –†–∞–±–æ—Ç–∞–π—Ç–µ –±–æ–ª—å—à–µ!`, 'warn');
                return;
            }

            let streak = state.loanStreak || 0;
            let interest = 0;
            
            if (streak === 0) interest = 0;      
            else if (streak === 1) interest = 0.10; 
            else if (streak === 2) interest = 0.20; 
            else interest = 0.50;                 

            const debtIncrease = amt * (1 + interest);

            state.balance += amt; 
            state.debt += debtIncrease; 
            state.loanStreak = streak + 1;

            if (state.debt <= debtIncrease) { 
                state.debtTimer = Date.now() + (5 * 60 * 1000); 
                state.debtOverdue = false; 
            }
            
            let msg = interest === 0 ? `–í–∑—è—Ç –∫—Ä–µ–¥–∏—Ç: ${amt} PLN (0%)` : `–í–∑—è—Ç–æ: ${amt}. –î–æ–ª–≥: +${debtIncrease.toFixed(2)} (+${interest*100}%)`;
            showToast(msg, interest > 0 ? 'warn' : 'success'); 
            input.value = ''; 
            
            sendLog(`–í–∑—è–ª –∫—Ä–µ–¥–∏—Ç: ${amt} (Streak: ${state.loanStreak})`, 'LOAN');
            document.getElementById('modal-body').innerHTML = ''; renderBank(document.getElementById('modal-body')); 
            saveGame(); syncToCloud(true); updateUI();
        }

        function repayLoan() {
            const input = document.getElementById('loan-amount'); 
            let amt = parseFloat(input.value);
            if (!amt || amt <= 0) return;
            
            if (amt > state.balance) amt = state.balance; 
            if (amt > state.debt) amt = state.debt;
            
            state.balance -= amt; 
            state.debt -= amt; 
            
            if (state.debt <= 0.01) { 
                state.debt = 0; 
                state.debtOverdue = false;
                state.debtTimer = 0;
                state.loanStreak = 0; 
                showToast(`–î–æ–ª–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω! –ü—Ä–æ—Ü–µ–Ω—Ç —Å–±—Ä–æ—à–µ–Ω.`, 'success');
            } else {
                showToast(`–ü–æ–≥–∞—à–µ–Ω–æ: ${amt} PLN. –û—Å—Ç–∞—Ç–æ–∫: ${state.debt.toFixed(2)}`, 'success'); 
            }

            input.value = ''; 
            sendLog(`–í–µ—Ä–Ω—É–ª –¥–æ–ª–≥: ${amt} PLN`, 'LOAN');
            document.getElementById('modal-body').innerHTML = ''; renderBank(document.getElementById('modal-body')); 
            saveGame(); syncToCloud(true); updateUI();
        }

        function renderHistory(c) { 
            c.innerHTML = state.history.slice().reverse().map(h => {
                let amount = 0;
                let tipStr = "";
                if (h.total) {
                    amount = h.total;
                    if (h.tip > 0) {
                        tipStr = `<span style="color:#00e676; font-size:10px; margin-left:5px">(+${h.tip.toFixed(2)} napiwek)</span>`;
                    }
                } else {
                    amount = parseFloat(h.earn); 
                }
                return `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center">
                    <div><b>${h.rest}</b>${tipStr}</div>
                    <span style="font-weight:bold">+${amount.toFixed(2)}</span>
                </div>`;
            }).join(''); 
        }

        function updateTrack(p) { document.getElementById('track-fill').style.width=p+'%'; document.getElementById('track-icon').style.left=p+'%'; }
        
        function resetGame(penalty = 0) {
            let msg = '–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?';
            if (penalty > 0) msg += ` –° –≤–∞—Å –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ ${penalty} PLN –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã.`;
            if(confirm(msg)) {
                localStorage.removeItem(SAVE_KEY);
                const newState = {
                    id: state.id, 
                    name: null,
                    balance: 0, debt: (7000 + penalty), debtTimer: Date.now(), debtOverdue: true,
                    loanStreak: 0, 
                    isOnline: false, isSearching: false, scheduledOffline: false,
                    items: { bike: 100, bag: 100, phone: 100, gear: 100 },
                    needs: { energy: 100, water: 100, mood: 100 },
                    inventory: { water: 0, bar: 0, energy_drink: 0, coffee: 0, gas: 0, chocolate: 0 },
                    repairs: { bike: 0, bag: 0, phone: 0, gear: 0 },
                    history: []
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(newState));
                location.reload();
            }
        }

    init();
  </script>
<script src="patches/design_update.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
(function() {
    console.log(">>> Patch v62: ONLINE CONNECTED");

    // 1. –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE (–¢–í–û–ò)
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1",
        measurementId: "G-TGSCHBVLX2"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê
    let myId = localStorage.getItem('wolt_player_id');
    if (!myId) {
        myId = 'courier_' + Math.random().toString(36).substr(2, 6);
        localStorage.setItem('wolt_player_id', myId);
    }

    const userRef = db.ref('users/' + myId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    userRef.once('value').then((snapshot) => {
        const data = snapshot.val();
        if (data) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
            if(data.password && data.password.length > 0) {
                const input = prompt("üîê –í–í–ï–î–ò–¢–ï –ü–ê–†–û–õ–¨:");
                if(input !== data.password) {
                    document.body.innerHTML = "<div style='background:black;color:red;height:100vh;display:flex;justify-content:center;align-items:center;font-size:30px;font-weight:bold'>–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù</div>";
                    return;
                }
            }
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑ –æ–±–ª–∞–∫–∞
            window.state = data;
            if(window.updateUI) window.updateUI();
        } else {
            // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ -> —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ
            window.saveGame();
        }
    });

    // 3. –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø (–í –û–ë–õ–ê–ö–û)
    window.saveGame = function() {
        if(!window.state) return;
        window.state._last_seen = Date.now();
        window.state._device = navigator.userAgent; // –ò–Ω—Ñ–æ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
        userRef.set(window.state);
    };
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(window.saveGame, 3000);

    // 4. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ò–ù–§–õ–Ø–¶–ò–Ø (–°–ª—É—à–∞–µ–º –ê–¥–º–∏–Ω–∞)
    db.ref('config/inflation').on('value', (snap) => {
        window.clientInflation = snap.val() || 1.0;
        // –ü–µ—Ä–µ—Å—á–µ—Ç —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
        if(state.activeOrder && !state.activeOrder.inflated) {
            state.activeOrder.price = Math.floor(state.activeOrder.price * window.clientInflation);
            state.activeOrder.inflated = true;
        }
    });

    // 5. –í–ò–ó–£–ê–õ (–ü–†–û–¶–ï–ù–¢–´ –ü–û –¶–ï–ù–¢–†–£)
    const style = document.createElement('style');
    style.innerHTML = `
        .tiny-stat { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10px; font-weight: 900; color: #fff; text-shadow: 0 0 3px #000; 
            z-index: 50; pointer-events: none;
        }
        .equip-item { position: relative; }
        .equip-label { margin-top: 5px; display: block; }
    `;
    document.head.appendChild(style);

    function updateVisualStats() {
        if(typeof state === 'undefined' || !state.items) return;
        const stats = { 'bike':state.items.bike, 'bag':state.items.bag, 'phone':state.items.phone, 'gear':state.items.gear, 'energy':state.needs.energy, 'water':state.needs.water, 'mood':state.needs.mood };
        
        for (let [key, val] of Object.entries(stats)) {
            const bar = document.getElementById(`bar-${key}`);
            if(bar) {
                const parent = bar.closest('.equip-item') || bar.parentElement.parentElement;
                let num = parent.querySelector('.tiny-stat');
                if(!num) { num = document.createElement('div'); num.className = 'tiny-stat'; parent.appendChild(num); }
                const clean = Math.floor(val);
                num.textContent = clean + '%';
                num.style.color = (clean < 0) ? '#ff3d00' : '#fff';
            }
        }
    }
    setInterval(updateVisualStats, 1000);

    // 6. –ú–ê–ì–ê–ó–ò–ù –ò –ú–ê–®–ò–ù–ê (PLN + –ö–†–ê–§–¢)
    const CYBER_CAR = { id: 'cyber_taxi' };

    window.craftCyber = function() {
        if(state.inventory.part_chip > 0 && state.inventory.part_engine > 0 && state.inventory.part_alloy > 0) {
            state.inventory.part_chip--; state.inventory.part_engine--; state.inventory.part_alloy--;
            state.taxi.vehicle = CYBER_CAR.id;
            window.saveGame(); window.updateMenuState();
            if(window.showToast) window.showToast('ü§ñ CYBER TAXI –ì–û–¢–û–í–û!', 'success');
            const b = document.getElementById('modal-body'); if(b) window.renderTaxiShop(b);
        } else {
            if(window.showToast) window.showToast('‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ—Ç–∞–ª–µ–π (–∏—â–∏ –≤ –∑–∞–∫–∞–∑–∞—Ö)', 'error');
        }
    };

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
    const originalRenderShop = window.renderTaxiShop;
    window.renderTaxiShop = function(container) {
        container.innerHTML = '';
        
        // –ë–ª–æ–∫ 1: –õ–∏—Ü–µ–Ω–∑–∏—è
        const hasLicense = state.taxi.license;
        const divL = document.createElement('div');
        divL.style.cssText = "padding:10px; background:#fff; border-radius:8px; margin-bottom:10px; border:1px solid #ddd; text-align:center";
        
        if(hasLicense) {
            divL.innerHTML = `<div style="color:#00c853; font-weight:bold">‚úÖ –õ–ò–¶–ï–ù–ó–ò–Ø –ê–ö–¢–ò–í–ù–ê</div>`;
        } else {
            const price = 500; // –¶–ï–ù–ê 500 PLN
            const canBuy = state.balance >= price;
            const unlocked = state.stats.total_deliveries >= 5; 
            
            if(unlocked) {
                divL.innerHTML = `
                    <div style="font-weight:bold; color:#000">üöï –õ–∏—Ü–µ–Ω–∑–∏—è –¢–∞–∫—Å–∏</div>
                    <button onclick="window.buyLicense(${price})" style="width:100%; margin-top:5px; background:${canBuy?'#f90':'#ccc'}; border:none; padding:10px; color:white; border-radius:4px; font-weight:bold; cursor:pointer">
                        –ö–£–ü–ò–¢–¨ (${price} PLN)
                    </button>
                `;
            } else {
                divL.innerHTML = `<div style="color:#999; font-size:11px">üîí –í—ã–ø–æ–ª–Ω–∏ 5 –∑–∞–∫–∞–∑–æ–≤, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.</div>`;
            }
        }
        container.appendChild(divL);

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏
        window.buyLicense = function(cost) {
            if(state.balance >= cost) { 
                state.balance -= cost; 
                state.taxi.license = true; 
                window.saveGame(); window.updateUI(); 
                window.renderTaxiShop(container); 
            }
        };

        // –ë–ª–æ–∫ 2: –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è
        const divM = document.createElement('div');
        divM.style.cssText = "padding:10px; background:rgba(0,0,0,0.05); border-radius:8px; border:1px solid #d500f9; text-align:center";
        const hasParts = (state.inventory.part_chip>0 && state.inventory.part_engine>0 && state.inventory.part_alloy>0);
        const hasCar = (state.taxi.vehicle === CYBER_CAR.id);
        
        divM.innerHTML = `
            <div style="color:#d500f9; font-weight:bold; font-size:12px; margin-bottom:5px">üîß CYBER-X WORKSHOP</div>
            <div style="font-size:11px; margin-bottom:10px; display:flex; gap:5px; justify-content:center">
                <span style="color:${state.inventory.part_chip?'#0a0':'#f00'}">üîã –ß–∏–ø: ${state.inventory.part_chip||0}</span>
                <span style="color:${state.inventory.part_engine?'#0a0':'#f00'}">‚öôÔ∏è –î–≤–∏–≥: ${state.inventory.part_engine||0}</span>
                <span style="color:${state.inventory.part_alloy?'#0a0':'#f00'}">üî© –°–ø–ª–∞–≤: ${state.inventory.part_alloy||0}</span>
            </div>
            ${hasCar ? '<div style="background:#0a0; color:white; padding:5px; border-radius:4px">‚úÖ –°–û–ë–†–ê–ù–û</div>' :
            `<button onclick="window.craftCyber()" style="width:100%; padding:8px; background:${hasParts?'#d500f9':'#444'}; color:white; border:none; border-radius:4px; font-weight:bold; cursor:${hasParts?'pointer':'not-allowed'}">
                ${hasParts ? '–°–û–ë–†–ê–¢–¨ –ú–ê–®–ò–ù–£' : '–ù–ï–¢ –î–ï–¢–ê–õ–ï–ô'}
            </button>`}
        `;
        container.appendChild(divM);
    };

})();
</script>
    
</script>
</body> </html>
