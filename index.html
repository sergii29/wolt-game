<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: STABLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg-dark: #1a1a1a; --brand-blue: #0088cc; --taxi-yellow: #ffcc00; --accent-green: #00e676; --accent-red: #ff3d00; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: var(--bg-dark); color: white; overflow: hidden; user-select: none; -webkit-user-select: none; }
        
        #map { height: 100%; width: 100%; z-index: 0; background: #222; position: absolute; top: 0; left: 0; }
        
        /* UI OVERLAY - Z-INDEX MUST BE HIGHER THAN MAP */
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .pointer-events-auto { pointer-events: auto; }

        .top-bar { padding: 15px; display: flex; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .menu-btn, .stats-btn { background: white; color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; cursor: pointer; }
        .balance-display { background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        
        .equip-bar { display: flex; gap: 4px; padding: 0 15px; margin-top: 10px; }
        .equip-item { flex: 1; background: rgba(0,0,0,0.8); border-radius: 6px; padding: 4px 2px; text-align: center; position: relative; }
        .progress-mini { width: 80%; height: 3px; background: #444; margin: 2px auto; }
        .progress-mini-fill { height: 100%; background: var(--accent-green); transition: width 0.3s; }
        .equip-label { font-size: 7px; color: #aaa; display: block; font-weight: bold; }
        .tiny-stat { font-size: 10px; font-weight: bold; position: absolute; width: 100%; top: 50%; left: 0; transform: translateY(-50%); text-shadow: 0 1px 2px black; }

        .bottom-sheet { background: white; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; color: #333; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); pointer-events: auto; }
        
        .slider-container { position: relative; width: 100%; height: 60px; background: #f0f0f0; border-radius: 30px; overflow: hidden; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .slider-knob { position: absolute; left: 4px; width: 52px; height: 52px; background: var(--brand-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: grab; z-index: 2; }
        .slider-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: rgba(0, 136, 204, 0.2); }
        .slider-text { z-index: 1; font-weight: bold; color: #999; font-size: 14px; text-transform: uppercase; }
        
        .pedal-btn { width: 100%; background: var(--brand-blue); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; text-transform: uppercase; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        .pedal-btn:active { transform: scale(0.98); }
        .pedal-btn:disabled { background: #ccc; transform: none; }
        .pedal-btn.blocked { background: var(--accent-orange); }

        .game-toast { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000; text-align: center; width: 80%; }
        .game-toast.show { opacity: 1; }

        /* Other UI elements omitted for brevity but classes kept for logic compatibility */
        .auth-modal, .full-modal, #side-menu-overlay { display: none; } 
        .auth-modal.open, .full-modal.open, #side-menu-overlay.open { display: flex; }
        
        /* Side Menu Styles */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; }
        #side-menu { position: absolute; top: 0; left: -85%; width: 85%; max-width: 300px; height: 100%; background: #222; transition: left 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; color: white; display: flex; align-items: center; gap: 10px; }
        
        /* Modal Styles */
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 4000; flex-direction: column; color: black; }
        .modal-header { padding: 15px; background: white; font-weight: bold; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #eee; }
        .modal-content { padding: 15px; overflow-y: auto; flex: 1; }
        .shop-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .shop-btn { padding: 8px 15px; border-radius: 8px; border: none; font-weight: bold; background: var(--brand-blue); color: white; cursor: pointer; }
        
        /* Quick Inv */
        .quick-inv { position: absolute; bottom: 100px; left: 20px; background: #333; padding: 10px; border-radius: 10px; display: none; flex-direction: column; gap: 5px; width: 200px; z-index: 2000; }
        .quick-inv.open { display: flex; }
        .inv-item { padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        
        .bribe-btn { background: #222; color: var(--accent-red); border: 1px solid var(--accent-red); padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; margin-top: 5px; display: none; }
        
        /* Map Icons */
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ui-layer">
        <div class="top-bar pointer-events-auto">
            <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
            <div class="balance-display">
                <div class="balance-amount" id="balance-val">0.00 PLN</div>
                <div style="font-size:10px; color:#ccc">–ë–∞–ª–∞–Ω—Å <span id="debt-warning" style="color:red;display:none">!–î–û–õ–ì!</span></div>
            </div>
            <button class="stats-btn" onclick="openModal('stats')"><i class="fa-solid fa-chart-simple"></i></button>
        </div>

        <div class="equip-bar pointer-events-auto">
            <div class="equip-item"><i class="fa-solid fa-bolt" style="color:yellow"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-energy"></div></div><div class="tiny-stat" id="stat-energy"></div></div>
            <div class="equip-item"><i class="fa-solid fa-droplet" style="color:cyan"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-water"></div></div><div class="tiny-stat" id="stat-water"></div></div>
            <div class="equip-item"><i class="fa-solid fa-face-smile" style="color:magenta"></i><div class="progress-mini"><div class="progress-mini-fill" id="bar-mood"></div></div><div class="tiny-stat" id="stat-mood"></div></div>
        </div>

        <div id="toast" class="game-toast"></div>

        <div class="bottom-sheet">
            <div id="offline-view">
                <h3>–í–∞—Ä—à–∞–≤–∞ <span style="font-size:12px;color:#999">–û—Ñ–ª–∞–π–Ω</span></h3>
                <div class="slider-container">
                    <div class="slider-fill" id="off-fill"></div>
                    <div class="slider-text">–°–í–ê–ô–ü -> –†–ê–ë–û–¢–ê</div>
                    <div class="slider-knob" id="off-knob"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            </div>

            <div id="active-view" style="display:none">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <div>
                        <h3 id="order-title" style="margin:0">–ü–æ–∏—Å–∫...</h3>
                        <div id="order-subtitle" style="font-size:12px; color:#666">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    <div id="order-price" style="font-size:18px; font-weight:bold; color:var(--accent-green)">--</div>
                </div>

                <div style="height:4px; background:#eee; margin:15px 0; position:relative">
                    <div id="trip-progress" style="height:100%; width:0%; background:var(--brand-blue); transition:width 0.2s"></div>
                </div>

                <div class="controls-row" style="display:flex; gap:10px">
                    <div class="bag-btn pointer-events-auto" style="width:50px; background:#f0f0f0; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer" onclick="toggleQuickInv()">üéí</div>
                    <div style="flex:1">
                        <button id="pedal-btn" class="pedal-btn">–ñ–ú–ò –ì–ê–ó</button>
                        <button id="bribe-btn" class="bribe-btn" onclick="payBribe()">–í–ó–Ø–¢–ö–ê (-20)</button>
                    </div>
                </div>

                <div class="slider-container" style="height:40px; margin-top:15px; background:#fff0f0">
                    <div class="slider-fill" id="on-fill" style="background:#ffcdd2"></div>
                    <div class="slider-text" style="font-size:10px; color:red">–°–í–ê–ô–ü -> –û–§–õ–ê–ô–ù</div>
                    <div class="slider-knob" id="on-knob" style="width:32px; height:32px; background:red; font-size:14px"><i class="fa-solid fa-power-off"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div id="quick-inv" class="quick-inv pointer-events-auto"></div>

    <div id="side-menu-overlay" onclick="toggleMenu()">
        <div id="side-menu" onclick="event.stopPropagation()">
            <h2 style="color:white">–ú–µ–Ω—é</h2>
            <div class="menu-item" onclick="openModal('shop')"><i class="fa-solid fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω</div>
            <div class="menu-item" onclick="openModal('bank')"><i class="fa-solid fa-building-columns"></i> –ë–∞–Ω–∫</div>
            <div class="menu-item" onclick="toggleTaxi()"><i class="fa-solid fa-taxi"></i> –†–µ–∂–∏–º –¢–∞–∫—Å–∏</div>
            <div class="menu-item" onclick="resetGame()" style="color:red; margin-top:auto"><i class="fa-solid fa-trash"></i> –°–±—Ä–æ—Å</div>
        </div>
    </div>

    <div id="full-modal" class="full-modal">
        <div class="modal-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()"></i>
            <span id="modal-title">...</span>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>

    <div id="auth-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:5000;display:none;justify-content:center;align-items:center;flex-direction:column">
        <h3 style="color:white">–í—Ö–æ–¥</h3>
        <input id="auth-login" placeholder="–õ–æ–≥–∏–Ω" style="padding:10px;margin:5px">
        <button onclick="performAuth()" style="padding:10px;background:var(--brand-blue);color:white;border:none">OK</button>
        <button onclick="document.getElementById('auth-modal').style.display='none'" style="margin-top:10px;background:none;color:#aaa;border:none">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. CORE GAME STATE (ROBUST) ---
        const SAVE_KEY = 'WARSZAWA_FOREVER_V2';
        const DEFAULT_STATE = {
            balance: 0, debt: 0, 
            inventory: { water: 0, bar: 0, gas: 0 },
            stats: { energy: 100, water: 100, mood: 100 },
            items: { bike: 100 },
            taxi: { active: false },
            isOnline: false
        };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

        // --- 2. MAP VARIABLES (SAFE) ---
        let map = null;
        let mapLoaded = false;
        let routeLine = null;
        let markers = [];
        const WARSAW = [52.2297, 21.0122];
        let currentDest = null;
        let courierPos = [...WARSAW];

        // --- 3. GAME VARIABLES ---
        let currentOrder = null;
        let orderTimer = null;

        // --- 4. INITIALIZATION ---
        function init() {
            // Load Save
            try {
                const s = localStorage.getItem(SAVE_KEY);
                if(s) state = { ...DEFAULT_STATE, ...JSON.parse(s) };
            } catch(e) { console.error("Save load error", e); }

            // INIT SLIDERS FIRST (So they work even if map fails)
            initSliders();
            
            // Buttons
            document.getElementById('pedal-btn').addEventListener('click', pedal);
            
            // UI Update
            updateUI();

            // Try Init Map
            try {
                setTimeout(() => {
                    map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW, 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);
                    mapLoaded = true;
                    console.log("Map Loaded Successfully");
                }, 500);
            } catch(e) {
                console.error("Map Failed:", e);
                document.getElementById('map').style.background = '#333'; // Fallback bg
                document.getElementById('map').innerHTML = '<div style="color:white;text-align:center;padding-top:100px">–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å<br>–ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ</div>';
            }

            // Start Loops
            setInterval(updateUI, 1000);
            
            // Restore state if online
            if(state.isOnline) {
                goOnlineUI();
                startSearching();
            }
        }

        // --- 5. SLIDER LOGIC (PURE JS, NO MAP DEPENDENCY) ---
        function initSliders() {
            setupSlider('off', () => { 
                state.isOnline = true; 
                goOnlineUI();
                startSearching();
                saveGame();
            });
            setupSlider('on', () => { 
                state.isOnline = false; 
                goOfflineUI();
                saveGame();
            });
        }

        function setupSlider(id, callback) {
            const knob = document.getElementById(id + '-knob');
            const fill = document.getElementById(id + '-fill');
            const box = knob.parentElement;
            let startX = 0, dragging = false;

            const start = (x) => { dragging = true; startX = x; };
            const move = (x) => {
                if(!dragging) return;
                let val = x - startX;
                let max = box.offsetWidth - knob.offsetWidth;
                if(val < 0) val = 0; if(val > max) val = max;
                knob.style.transform = `translateX(${val}px)`;
                fill.style.width = (val/max*100) + '%';
                if(val > max * 0.9) { dragging = false; reset(); callback(); }
            };
            const end = () => { dragging = false; reset(); };
            const reset = () => { knob.style.transform = 'translateX(0)'; fill.style.width = '0%'; };

            knob.addEventListener('mousedown', e => start(e.clientX));
            knob.addEventListener('touchstart', e => start(e.touches[0].clientX));
            document.addEventListener('mousemove', e => move(e.clientX));
            document.addEventListener('touchmove', e => move(e.touches[0].clientX));
            document.addEventListener('mouseup', end);
            document.addEventListener('touchend', end);
        }

        // --- 6. GAMEPLAY LOGIC ---
        function goOnlineUI() {
            document.getElementById('offline-view').style.display = 'none';
            document.getElementById('active-view').style.display = 'block';
        }
        function goOfflineUI() {
            document.getElementById('offline-view').style.display = 'block';
            document.getElementById('active-view').style.display = 'none';
            currentOrder = null;
            clearMap();
        }

        function startSearching() {
            if(!state.isOnline) return;
            document.getElementById('order-title').textContent = "–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞...";
            document.getElementById('pedal-btn').disabled = true;
            document.getElementById('pedal-btn').textContent = "–ü–û–ò–°–ö...";
            
            // Simulate delay
            setTimeout(() => {
                if(!state.isOnline) return;
                createOrder();
            }, 2000);
        }

        function createOrder() {
            // Generate Random Coords nearby
            const dest = [WARSAW[0] + (Math.random()-0.5)*0.05, WARSAW[1] + (Math.random()-0.5)*0.08];
            currentDest = dest;

            // Calc Distance (Safe Mode)
            let distKm = 3.5; // Default fallback
            try {
                if(mapLoaded) {
                    distKm = (map.distance(courierPos, dest) / 1000).toFixed(1);
                }
            } catch(e) { console.warn("Dist calc failed", e); }

            let pay = (4 + (distKm * 1.5)).toFixed(2);
            if(state.taxi.active) pay = (pay * 3).toFixed(2);

            currentOrder = {
                pay: parseFloat(pay),
                dist: distKm,
                progress: 0,
                stage: 1 // 1 = Picking up, 2 = Delivering
            };

            document.getElementById('order-title').textContent = state.taxi.active ? "üöñ –ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω" : "üçî –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω";
            document.getElementById('order-subtitle').textContent = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${distKm} –∫–º`;
            document.getElementById('order-price').textContent = pay + " PLN";
            
            const btn = document.getElementById('pedal-btn');
            btn.disabled = false;
            btn.textContent = "–ü–†–ò–ù–Ø–¢–¨";
            btn.onclick = acceptOrder;

            // Draw on Map (Safe Mode)
            drawMapRoute(courierPos, dest);
        }

        function acceptOrder() {
            const btn = document.getElementById('pedal-btn');
            btn.textContent = state.taxi.active ? "–ì–ê–ó –í –ü–û–õ" : "–ö–†–£–¢–ò –ü–ï–î–ê–õ–ò";
            btn.onclick = pedal;
            document.getElementById('order-subtitle').textContent = "–í –ø—É—Ç–∏...";
        }

        function pedal() {
            if(!currentOrder) return;

            // Stats Logic
            if(state.stats.energy <= 0) { showToast("–ù–µ—Ç —Å–∏–ª! –°—ä–µ—à—å —á—Ç–æ-–Ω–∏–±—É–¥—å", "warn"); return; }
            state.stats.energy -= 1;
            state.stats.water -= 0.5;

            // Progress Logic
            currentOrder.progress += 5; // 5% per click
            
            // Visual Updates
            document.getElementById('trip-progress').style.width = currentOrder.progress + '%';
            
            // Map Movement (Safe Mode)
            updateCourierMapPos(currentOrder.progress);

            // Random Events (Simulated)
            if(Math.random() < 0.05) { // 5% chance
                triggerEvent("police");
            } else if (Math.random() < 0.05) {
                triggerEvent("traffic");
            }

            if(currentOrder.progress >= 100) {
                finishOrder();
            }
            
            saveGame();
            updateUI();
        }

        function finishOrder() {
            state.balance += currentOrder.pay;
            showToast(`+${currentOrder.pay} PLN`, 'success');
            currentOrder = null;
            document.getElementById('trip-progress').style.width = '0%';
            clearMap();
            startSearching();
        }

        function triggerEvent(type) {
            const btn = document.getElementById('pedal-btn');
            btn.disabled = true;
            
            if(type === 'police') {
                btn.textContent = "üëÆ –ü–û–õ–ò–¶–ò–Ø!";
                document.getElementById('bribe-btn').style.display = 'block';
                showToast("–í–∞—Å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏!", "warn");
                setTimeout(() => { if(btn.disabled) resumeFromEvent(); }, 5000);
            } else {
                btn.textContent = "üöß –ü–†–û–ë–ö–ê...";
                showToast("–°—Ç–æ–∏–º –≤ –ø—Ä–æ–±–∫–µ", "warn");
                setTimeout(() => resumeFromEvent(), 3000);
            }
        }

        function payBribe() {
            if(state.balance >= 20) {
                state.balance -= 20;
                showToast("–í–∑—è—Ç–∫–∞ –¥–∞–Ω–∞ (-20 PLN)", "warn");
                resumeFromEvent();
            } else {
                showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!", "warn");
            }
        }

        function resumeFromEvent() {
            const btn = document.getElementById('pedal-btn');
            btn.disabled = false;
            btn.textContent = state.taxi.active ? "–ì–ê–ó –í –ü–û–õ" : "–ö–†–£–¢–ò –ü–ï–î–ê–õ–ò";
            document.getElementById('bribe-btn').style.display = 'none';
        }

        // --- 7. SAFE MAP DRAWING ---
        function drawMapRoute(start, end) {
            try {
                if(!mapLoaded || !map) return;
                clearMap();
                
                // Route Line
                routeLine = L.polyline([start, end], {color: '#00ccff', weight: 5}).addTo(map);
                
                // Markers
                const startIcon = L.divIcon({html: 'üî¥', className:'icon'});
                const endIcon = L.divIcon({html: 'üèÅ', className:'icon'});
                
                markers.push(L.marker(start).addTo(map));
                markers.push(L.marker(end, {icon: endIcon}).addTo(map));
                
                map.fitBounds([start, end], {padding: [50,50]});
            } catch(e) { console.log("Map draw error (ignoring)", e); }
        }

        function updateCourierMapPos(pct) {
            try {
                if(!mapLoaded || !map || !routeLine) return;
                // Interpolate position
                const start = courierPos;
                const end = currentDest;
                const lat = start[0] + (end[0] - start[0]) * (pct/100);
                const lng = start[1] + (end[1] - start[1]) * (pct/100);
                
                // Move marker (simulated by clearing for simplicity in stable version)
                // In a robust version we'd update a specific marker object
            } catch(e) {}
        }

        function clearMap() {
            try {
                if(!mapLoaded || !map) return;
                if(routeLine) map.removeLayer(routeLine);
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                // Reset courier to center for next order simulation
                courierPos = [...WARSAW]; 
            } catch(e) {}
        }

        // --- 8. UI HELPERS ---
        function updateUI() {
            document.getElementById('balance-val').textContent = state.balance.toFixed(2) + " PLN";
            updateBar('bar-energy', state.stats.energy, 'stat-energy');
            updateBar('bar-water', state.stats.water, 'stat-water');
            updateBar('bar-mood', state.stats.mood, 'stat-mood');
        }

        function updateBar(id, val, textId) {
            let pct = Math.max(0, Math.min(100, val));
            document.getElementById(id).style.width = pct + '%';
            if(document.getElementById(textId)) document.getElementById(textId).textContent = Math.floor(val) + '%';
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.border = type === 'warn' ? '1px solid orange' : '1px solid #00e676';
            t.style.color = type === 'warn' ? 'orange' : '#00e676';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function toggleMenu() { document.getElementById('side-menu-overlay').classList.toggle('open'); document.getElementById('side-menu').classList.toggle('open'); }
        function closeModal() { document.getElementById('full-modal').classList.remove('open'); }
        function openModal(t) { 
            toggleMenu(); document.getElementById('full-modal').classList.add('open'); document.getElementById('modal-title').textContent = t; 
            renderShop(t);
        }
        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
        function resetGame() { if(confirm("–°–±—Ä–æ—Å?")) { localStorage.removeItem(SAVE_KEY); location.reload(); } }
        
        // --- 9. SHOP LOGIC (Mini) ---
        function renderShop(type) {
            const c = document.getElementById('modal-body'); c.innerHTML = '';
            if(type === 'shop') {
                c.innerHTML += itemCard('–°–Ω–∏–∫–µ—Ä—Å', '–≠–Ω–µ—Ä–≥–∏—è +20', 5, 'bar');
                c.innerHTML += itemCard('–í–æ–¥–∞', '–í–æ–¥–∞ +35', 2, 'water');
            } else if (type === 'bank') {
                c.innerHTML = '<div style="text-align:center"><h3>–ö—Ä–µ–¥–∏—Ç—ã</h3><button class="shop-btn" onclick="takeLoan()">–í–∑—è—Ç—å 100 PLN</button></div>';
            }
        }
        
        function itemCard(name, desc, price, id) {
            return `<div class="shop-card"><div><b>${name}</b><br><small>${desc}</small></div><button class="shop-btn" onclick="buy('${id}', ${price})">${price}</button></div>`;
        }
        
        function buy(id, price) {
            if(state.balance >= price) {
                state.balance -= price;
                if(id==='bar') state.stats.energy += 20;
                if(id==='water') state.stats.water += 35;
                showToast("–ö—É–ø–ª–µ–Ω–æ!", "success");
                updateUI();
            } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥", "warn");
        }
        
        function takeLoan() { state.balance += 100; state.debt += 150; showToast("–ö—Ä–µ–¥–∏—Ç –≤–∑—è—Ç", "warn"); updateUI(); closeModal(); }

        function toggleQuickInv() {
            const q = document.getElementById('quick-inv');
            q.classList.toggle('open');
            q.innerHTML = `<div class="inv-item" onclick="buy('bar',5)">–°—ä–µ—Å—Ç—å –°–Ω–∏–∫–µ—Ä—Å (5 PLN)</div>`;
        }

        function toggleTaxi() {
            state.taxi.active = !state.taxi.active;
            showToast(state.taxi.active ? "–†–µ–∂–∏–º –¢–∞–∫—Å–∏" : "–†–µ–∂–∏–º –ö—É—Ä—å–µ—Ä–∞", "success");
            toggleMenu();
        }

        // Start
        init();
    </script>
    <script src="patches/design_update.js"></script>
</body>
</html>

