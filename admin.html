<!-- ИГРОКИ -->
<div class="card">
  <h2>Игроки</h2>
  <select id="playerSelect"></select>
  <button onclick="loadPlayer()">Загрузить</button>

  <div id="playerEditor" style="display:none">
    Баланс: <input id="pBalance" type="number"><br>
    Энергия: <input id="pEnergy" type="number"><br>
    Настроение: <input id="pMood" type="number"><br>
    <button onclick="savePlayer()">Сохранить</button>
  </div>
</div>

<script>
let currentPlayer = null;

db.ref("players").on("value", snap => {
  const select = document.getElementById("playerSelect");
  select.innerHTML = "";
  snap.forEach(child => {
    const o = document.createElement("option");
    o.value = child.key;
    o.textContent = child.key;
    select.appendChild(o);
  });
});

function loadPlayer(){
  const id = playerSelect.value;
  currentPlayer = id;
  db.ref("players/"+id).once("value").then(s=>{
    const d = s.val() || {};
    pBalance.value = d.balance ?? 0;
    pEnergy.value = d.energy ?? 0;
    pMood.value = d.mood ?? 0;
    playerEditor.style.display = "block";
  });
}

function savePlayer(){
  if(!currentPlayer) return;
  db.ref("players/"+currentPlayer).once("value").then(old=>{
    const before = old.val() || {};
    const after = {
      balance:+pBalance.value,
      energy:+pEnergy.value,
      mood:+pMood.value
    };
    db.ref("players/"+currentPlayer).update(after);
    addLog("Игрок "+currentPlayer, before, after);
    alert("Сохранено");
  });
}
</script>

<!-- ДОСТАВКА -->
<div class="card">
  <h2>Тарифы доставки</h2>
  База: <input id="delBase"><br>
  За км: <input id="delKm"><br>
  <button onclick="saveDelivery()">Сохранить</button>
</div>

<script>
db.ref("delivery").once("value").then(s=>{
  const d = s.val() || {};
  delBase.value = d.basePrice ?? 0;
  delKm.value = d.pricePerKm ?? 0;
});

function saveDelivery(){
  db.ref("delivery").update({
    basePrice:+delBase.value,
    pricePerKm:+delKm.value
  });
}
</script>

<!-- ЦЕЛИ -->
<div class="card">
  <h2>Цель курьера</h2>
  Минуты: <input id="gTime"><br>
  Доставки: <input id="gCount"><br>
  Бонус: <input id="gBonus"><br>
  <button onclick="saveGoal()">Сохранить</button>
</div>

<script>
function saveGoal(){
  db.ref("goals/daily").set({
    time:+gTime.value,
    deliveries:+gCount.value,
    bonus:+gBonus.value
  });
}
</script>

<!-- ЭКОНОМИКА -->
<div class="card">
  <h2>Экономика</h2>
  Инфляция: <input id="infl"><br>
  Доверие банка: <input id="trust"><br>
  <button onclick="saveEco()">Сохранить</button>
</div>

<script>
db.ref("economy").once("value").then(s=>{
  const d = s.val() || {};
  infl.value = d.inflation ?? 0;
  trust.value = d.bankTrust ?? 0;
});

function saveEco(){
  db.ref("economy").update({
    inflation:+infl.value,
    bankTrust:+trust.value
  });
}
</script>

<!-- МАГАЗИН -->
<div class="card">
  <h2>Магазин</h2>
  <select id="shopItem"></select><br>
  Цена: <input id="shopPrice"><br>
  Энергия: <input id="shopEnergy"><br>
  <button onclick="saveShop()">Сохранить</button>
</div>

<script>
let currentItem = null;

db.ref("shop/products").on("value", snap=>{
  shopItem.innerHTML="";
  snap.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.key;
    o.textContent=p.key;
    shopItem.appendChild(o);
  });
  shopItem.dispatchEvent(new Event("change"));
});

shopItem.onchange=()=>{
  currentItem=shopItem.value;
  db.ref("shop/products/"+currentItem).once("value").then(s=>{
    const d=s.val()||{};
    shopPrice.value=d.price??0;
    shopEnergy.value=d.energy??0;
  });
};

function saveShop(){
  if(!currentItem) return;
  db.ref("shop/products/"+currentItem).update({
    price:+shopPrice.value,
    energy:+shopEnergy.value
  });
}
</script>

<!-- ТАКСИ -->
<div class="card">
  <h2>Такси</h2>
  База: <input id="taxiBase"><br>
  Шанс: <input id="taxiChance"><br>
  Таймер: <input id="taxiTimer"><br>
  <button onclick="saveTaxi()">Сохранить</button>
</div>

<script>
db.ref("taxi").once("value").then(s=>{
  const d=s.val()||{};
  taxiBase.value=d.basePrice??0;
  taxiChance.value=d.chance??0;
  taxiTimer.value=d.timer??0;
});

function saveTaxi(){
  db.ref("taxi").update({
    basePrice:+taxiBase.value,
    chance:+taxiChance.value,
    timer:+taxiTimer.value
  });
}
</script>

<!-- ЛОГИ -->
<div class="card">
  <h2>Логи</h2>
  <button onclick="loadLogs()">Обновить</button>
  <pre id="logBox" style="max-height:300px;overflow:auto"></pre>
</div>

<script>
function addLog(action,before,after){
  db.ref("adminLogs").push({
    time:new Date().toLocaleString(),
    action,before,after
  });
}

function loadLogs(){
  db.ref("adminLogs").limitToLast(30).once("value").then(s=>{
    logBox.textContent="";
    s.forEach(l=>{
      logBox.textContent+=
      `[${l.val().time}] ${l.val().action}\n`+
      `Было: ${JSON.stringify(l.val().before)}\n`+
      `Стало: ${JSON.stringify(l.val().after)}\n\n`;
    });
  });
}
</script>

<!-- СОБЫТИЯ -->
<div class="card">
  <h2>События</h2>
  <select id="eventType">
    <option value="crisis">Кризис</option>
    <option value="boom">Рост</option>
    <option value="taxi">Забастовка такси</option>
  </select>
  <button onclick="runEvent()">Запустить</button>
</div>

<script>
function runEvent(){
  const t=eventType.value;

  if(t==="crisis"){
    db.ref("economy").once("value").then(s=>{
      const b=s.val();
      const a={inflation:b.inflation+10,bankTrust:b.bankTrust-15};
      db.ref("economy").update(a);
      addLog("Кризис",b,a);
    });
  }

  if(t==="boom"){
    db.ref("economy").once("value").then(s=>{
      const b=s.val();
      const a={inflation:Math.max(0,b.inflation-5),bankTrust:b.bankTrust+10};
      db.ref("economy").update(a);
      addLog("Рост",b,a);
    });
  }

  if(t==="taxi"){
    db.ref("taxi").once("value").then(s=>{
      const b=s.val();
      const a={...b,chance:Math.max(1,b.chance-50),basePrice:b.basePrice*2};
      db.ref("taxi").update(a);
      addLog("Забастовка такси",b,a);
    });
  }

  alert("Событие применено");
}
</script>
