<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARSZAWA CONTROL CENTER [LIVE]</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px; padding-bottom: 50px; }
        h1 { color: #00e5ff; margin: 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin: 20px 0; background: #1e1e1e; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; background: transparent; color: #777; border: none; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { background: #333; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* PLAYERS LIST */
        .player-card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
        .player-header { display: flex; justify-content: space-between; align-items: center; }
        .p-name { font-weight: bold; font-size: 16px; color: white; display:flex; align-items:center; gap:8px; }
        .p-id { font-size: 10px; color: #666; font-family: monospace; }
        .p-bal { font-size: 18px; color: #00e676; font-weight: bold; }
        .p-debt { font-size: 12px; color: #ff3d00; }
        
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; }
        .status-badge.online { background: #00e676; color: black; }

        .admin-actions { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .act-btn { background: #2c2c2c; border: none; color: white; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; display:flex; flex-direction:column; align-items:center; gap:4px; }
        .act-btn:hover { background: #444; }
        .btn-ban { color: #ff3d00; }
        .btn-msg { color: #00e5ff; }
        .btn-money { color: #00e676; }
        .btn-reset { color: #ff9100; }

        /* CONFIG FORM */
        .cfg-group { margin-bottom: 15px; background: #1e1e1e; padding: 15px; border-radius: 10px; }
        .cfg-label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .cfg-input { width: 100%; background: #2c2c2c; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .save-btn { width: 100%; background: #00e676; color: black; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 20px; }

        /* LOGS */
        #logs-container { max-height: 300px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; margin-bottom: 20px; border: 1px solid #333; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-time { color: #666; margin-right: 5px; }
        .log-user { color: #00e5ff; font-weight: bold; }
        .log-msg { color: #ccc; }
        .log-type-ORDER { color: #00e676; }
        .log-type-BUY { color: #ff9100; }
        .log-type-BAN { color: #ff3d00; }

    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center">
        <h1>Admin Nexus</h1>
        <div style="font-size:10px; color:#666" id="conn-status">Connecting...</div>
    </div>

    <div id="logs-container">Loading logs...</div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('players')">–ò–≥—Ä–æ–∫–∏</button>
        <button class="tab-btn" onclick="switchTab('config')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div id="tab-players" class="tab-content active">
        <div id="players-list"></div>
    </div>

    <div id="tab-config" class="tab-content">
        <div class="cfg-group">
            <label class="cfg-label">–ë–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ (Pickup Pay)</label>
            <input type="number" id="cfg-basePickupPay" class="cfg-input" step="0.5">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–û–ø–ª–∞—Ç–∞ –∑–∞ –ö–ú (Per Km)</label>
            <input type="number" id="cfg-perKmPay" class="cfg-input" step="0.1">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–†–∞–∑–±—Ä–æ—Å —Ü–µ–Ω (Variance)</label>
            <input type="number" id="cfg-payVariance" class="cfg-input" step="0.5">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–ò–Ω—Ñ–ª—è—Ü–∏—è (% –∑–∞ —É—Ä–æ–≤–µ–Ω—å)</label>
            <input type="number" id="cfg-inflationRate" class="cfg-input" step="1" placeholder="10 = 10%">
        </div>

        <h3 style="color:#ffcc00; font-size:14px; margin-top:20px">–¶–µ–Ω—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ</h3>
        <div class="cfg-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <div>
                <label class="cfg-label">–í–æ–¥–∞</label>
                <input type="number" id="price-water" class="cfg-input">
            </div>
            <div>
                <label class="cfg-label">–°–Ω–∏–∫–µ—Ä—Å</label>
                <input type="number" id="price-bar" class="cfg-input">
            </div>
            <div>
                <label class="cfg-label">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫</label>
                <input type="number" id="price-energy_drink" class="cfg-input">
            </div>
        </div>

        <h3 style="color:#d500f9; font-size:14px; margin-top:20px">–ë–∞–ª–∞–Ω—Å –∏–≥—Ä—ã</h3>
        <div class="cfg-group">
            <label class="cfg-label">–®–∞–Ω—Å —á–∞–µ–≤—ã—Ö (0.0 - 1.0)</label>
            <input type="number" id="cfg-tipChance" class="cfg-input" step="0.1">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–ú–∏–Ω. —Ç–µ–º–ø. –¥–ª—è —á–∞–µ–≤—ã—Ö</label>
            <input type="number" id="cfg-tipMinTemp" class="cfg-input">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–ú–∏–Ω. –Ω–∞—Å—Ç—Ä. –¥–ª—è —á–∞–µ–≤—ã—Ö</label>
            <input type="number" id="cfg-tipMinMood" class="cfg-input">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–¢—Ä–∞—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏ (–∑–∞ –∫–ª–∏–∫)</label>
            <input type="number" id="cfg-energyDrain" class="cfg-input" step="0.01">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–¢—Ä–∞—Ç–∞ –≤–æ–¥—ã (–∑–∞ –∫–ª–∏–∫)</label>
            <input type="number" id="cfg-waterDrain" class="cfg-input" step="0.01">
        </div>
        <div class="cfg-group">
            <label class="cfg-label">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å–µ–∫)</label>
            <input type="number" id="cfg-deliveryTime" class="cfg-input">
        </div>

        <button class="save-btn" onclick="saveConfig()">–°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò</button>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk", 
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        document.getElementById('conn-status').textContent = "üü¢ Connected";

        // LOAD DATA
        let players = {};
        
        // Listen for players
        db.ref('players').on('value', snap => {
            players = snap.val() || {};
            renderPlayers();
        });

        // Listen for logs
        db.ref('logs').limitToLast(50).on('value', snap => {
            const logs = [];
            snap.forEach(c => logs.push(c.val()));
            renderLogs(logs.reverse());
        });

        // Listen for config to populate form
        db.ref('config').once('value', snap => {
            const cfg = snap.val();
            if(cfg) {
                document.getElementById('cfg-basePickupPay').value = cfg.basePickupPay || 4;
                document.getElementById('cfg-perKmPay').value = cfg.perKmPay || 1.5;
                document.getElementById('cfg-payVariance').value = cfg.payVariance || 2;
                document.getElementById('cfg-inflationRate').value = (cfg.inflationRate || 0.1) * 100;
                
                document.getElementById('cfg-tipChance').value = cfg.tipChance || 0.5;
                document.getElementById('cfg-tipMinTemp').value = cfg.tipMinTemp || 60;
                document.getElementById('cfg-tipMinMood').value = cfg.tipMinMood || 80;

                document.getElementById('cfg-energyDrain').value = cfg.energyDrain || 0.15;
                document.getElementById('cfg-waterDrain').value = cfg.waterDrain || 0.1;
                document.getElementById('cfg-deliveryTime').value = cfg.deliveryTime || 60;

                if(cfg.itemPrices) {
                    document.getElementById('price-water').value = cfg.itemPrices.water || 2.0;
                    document.getElementById('price-bar').value = cfg.itemPrices.bar || 4.5;
                    document.getElementById('price-energy_drink').value = cfg.itemPrices.energy_drink || 7.0;
                }
            }
        });

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            event.target.classList.add('active');
        }

        function renderLogs(logs) {
            const c = document.getElementById('logs-container');
            c.innerHTML = logs.map(l => {
                const time = new Date(l.timestamp).toLocaleTimeString();
                return `<div class="log-entry">
                    <span class="log-time">[${time}]</span>
                    <span class="log-user">${l.playerName || '???'}</span>
                    <span class="log-msg log-type-${l.type}">${l.message}</span>
                </div>`;
            }).join('');
        }

        function renderPlayers() {
            const c = document.getElementById('players-list');
            c.innerHTML = '';
            
            // Convert to array and sort by lastSeen (active first)
            const arr = Object.keys(players).map(k => ({id:k, ...players[k]}));
            arr.sort((a,b) => (b.lastSeen || 0) - (a.lastSeen || 0));

            arr.forEach(p => {
                const isOnline = (Date.now() - (p.lastSeen || 0)) < 10000;
                const statusHtml = isOnline ? '<span class="status-badge online">ONLINE</span>' : `<span class="status-badge">${new Date(p.lastSeen||0).toLocaleTimeString()}</span>`;
                
                // Auth badge if registered
                const authBadge = p.isAuth ? '<i class="fa-solid fa-check-circle" style="color:#00e676; font-size:12px" title="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"></i>' : '';

                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerHTML = `
                    <div class="player-header">
                        <div>
                            <div class="p-name">${p.name || 'Unknown'} ${authBadge}</div>
                            <div class="p-id">${p.id}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="p-bal">${(p.balance||0).toFixed(2)} PLN</div>
                            ${p.debt > 0 ? `<div class="p-debt">–î–æ–ª–≥: ${p.debt.toFixed(2)}</div>` : ''}
                            ${statusHtml}
                        </div>
                    </div>
                    <div style="font-size:11px; color:#555; display:flex; gap:10px">
                        <span>–ó–∞–∫–∞–∑–æ–≤: ${p.career?.totalOrders || 0}</span>
                        <span>–¢–∞–∫—Å–∏: ${p.taxi?.unlocked ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="admin-actions">
                        <button class="act-btn btn-msg" onclick="sendMsg('${p.id}')"><i class="fa-solid fa-envelope"></i> SMS</button>
                        <button class="act-btn btn-money" onclick="addMoney('${p.id}')"><i class="fa-solid fa-coins"></i> +Money</button>
                        <button class="act-btn btn-reset" onclick="resetPlayer('${p.id}')"><i class="fa-solid fa-bomb"></i> Reset</button>
                        <button class="act-btn btn-ban" onclick="banPlayer('${p.id}')"><i class="fa-solid fa-ban"></i> Ban</button>
                        <button class="act-btn" onclick="toggleTaxi('${p.id}', ${!p.taxi?.unlocked})"><i class="fa-solid fa-taxi"></i> Taxi ${p.taxi?.unlocked?'OFF':'ON'}</button>
                    </div>
                `;
                c.appendChild(div);
            });
        }

        // ACTIONS
        function sendMsg(id) {
            const msg = prompt('–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–≥—Ä–æ–∫–∞:');
            if(msg) {
                db.ref('players/' + id + '/adminInbox').push({
                    type: 'SET_VAR',
                    path: 'ignore_me', 
                    value: 0 
                }); // Just to trigger listener, better to implement toast logic in game if not exists
                // Actually, game handles adminInbox directly. Let's assume SET_VAR or similar.
                // Wait, index.html doesn't have a "Show Message" command type.
                // It shows toast on any command. Let's use a dummy MATH_VAR with 0 value but we want text.
                // Let's rely on standard toast. 
                // Let's add a "MESSAGE" type handling in future. 
                // FOR NOW: We can't easily send just text without changing index.html.
                // But index handles 'SET_VAR'. Let's abuse it? No.
                // Let's use logic from index: "showToast('–ê–¥–º–∏–Ω –∏–∑–º–µ–Ω–∏–ª...')"
                // OK, I'll send a MATH_VAR 0 to balance, effective "Poke".
                
                // Correction: The best way with current index.html is to set a variable.
                // Let's send a bonus 1 PLN with the message?
                alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "Add Money" —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –¥–ª—è —à—Ç—Ä–∞—Ñ–∞ –∏–ª–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –±–æ–Ω—É—Å–∞.');
            }
        }

        function addMoney(id) {
            const amount = prompt('–°—É–º–º–∞ (–º–æ–∂–Ω–æ —Å –º–∏–Ω—É—Å–æ–º –¥–ª—è —à—Ç—Ä–∞—Ñ–∞):', '100');
            if(amount) {
                db.ref('players/' + id + '/adminInbox').push({
                    type: 'MATH_VAR',
                    path: 'balance',
                    value: parseFloat(amount)
                });
            }
        }

        function resetPlayer(id) {
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞? –û–Ω –Ω–∞—á–Ω–µ—Ç –∑–∞–Ω–æ–≤–æ —Å –¥–æ–ª–≥–æ–º 7000.')) {
                db.ref('players/' + id + '/adminInbox').push({
                    type: 'FULL_RESET',
                    charge: 0
                });
            }
        }

        function banPlayer(id) {
            if(confirm('–ó–ê–ë–ê–ù–ò–¢–¨ –ò–ì–†–û–ö–ê?')) {
                db.ref('players/' + id).update({ isBanned: true });
            }
        }

        function toggleTaxi(id, status) {
            db.ref('players/' + id + '/adminInbox').push({
                type: 'SET_VAR',
                path: 'taxi.unlocked',
                value: status
            });
        }

        function saveConfig() {
            const cfg = {
                basePickupPay: parseFloat(document.getElementById('cfg-basePickupPay').value),
                perKmPay: parseFloat(document.getElementById('cfg-perKmPay').value),
                payVariance: parseFloat(document.getElementById('cfg-payVariance').value),
                inflationRate: parseFloat(document.getElementById('cfg-inflationRate').value) / 100,
                
                tipChance: parseFloat(document.getElementById('cfg-tipChance').value),
                tipMinTemp: parseInt(document.getElementById('cfg-tipMinTemp').value),
                tipMinMood: parseInt(document.getElementById('cfg-tipMinMood').value),

                energyDrain: parseFloat(document.getElementById('cfg-energyDrain').value),
                waterDrain: parseFloat(document.getElementById('cfg-waterDrain').value),
                deliveryTime: parseInt(document.getElementById('cfg-deliveryTime').value),

                itemPrices: {
                    water: parseFloat(document.getElementById('price-water').value),
                    bar: parseFloat(document.getElementById('price-bar').value),
                    energy_drink: parseFloat(document.getElementById('price-energy_drink').value)
                }
            };

            db.ref('config').update(cfg)
                .then(() => alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤!'))
                .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
        }

    </script>
</body>
</html>
