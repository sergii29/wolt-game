<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WARSZAWA LIVE COMMANDER ‚ö°</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f0f13; --card: #1e1e24; --accent: #00e5ff; --green: #00e676; --red: #ff3d00; }
        body { background: var(--bg); color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px; padding-bottom: 50px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 22px; color: var(--accent); letter-spacing: 1px; }
        .status { font-size: 11px; padding: 4px 8px; border-radius: 6px; background: #333; color: #777; font-weight: bold; }
        .status.connected { background: rgba(0, 230, 118, 0.1); color: var(--green); }

        /* Search */
        .search-bar { width: 100%; padding: 12px; background: var(--card); border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; outline: none; }
        .search-bar:focus { border-color: var(--accent); }

        /* Player List */
        .player-card { background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #444; transition: all 0.2s; cursor: pointer; }
        .player-card:active { transform: scale(0.98); }
        .player-card.online { border-left-color: var(--green); box-shadow: 0 0 10px rgba(0, 230, 118, 0.1); }
        .player-card.banned { border-left-color: var(--red); opacity: 0.6; }

        .p-main { flex: 1; }
        .p-name { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
        .p-id { font-size: 11px; color: #666; font-family: monospace; }
        .p-bal { font-size: 14px; color: var(--accent); font-weight: bold; margin-top: 5px; }
        
        .p-stats-mini { display: flex; gap: 8px; font-size: 10px; color: #aaa; margin-top: 5px; }
        .p-stats-mini i { width: 12px; text-align: center; }

        .btn-mini { background: #333; color: white; border: none; padding: 8px 14px; border-radius: 8px; font-weight: bold; font-size: 12px; }

        /* MODAL (Live Editor) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: flex-end; justify-content: center; }
        .modal.open { display: flex; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .editor-sheet { background: #18181b; width: 100%; max-width: 500px; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .sheet-title { font-size: 18px; font-weight: bold; color: white; }
        .live-tag { background: var(--red); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Controls */
        .control-group { background: #222; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: block; }
        
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .val-disp { font-family: monospace; font-size: 14px; color: var(--accent); }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; color: white; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-act { background: #333; }
        .btn-act:active { background: #444; transform: scale(0.98); }
        .btn-blue { background: #009de0; }
        .btn-green { background: var(--green); color: black; }
        .btn-red { background: rgba(255, 61, 0, 0.15); color: var(--red); border: 1px solid var(--red); }

        input[type=range] { width: 100%; accent-color: var(--accent); }
        .inv-row { display: flex; align-items: center; background: #2a2a2a; padding: 8px; border-radius: 8px; margin-bottom: 5px; }
        .inv-icon { width: 30px; font-size: 16px; text-align: center; }
        .inv-name { flex: 1; font-size: 13px; }
        .inv-qty { font-weight: bold; color: white; width: 30px; text-align: center; }
        .inv-btn { width: 25px; height: 25px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ADMIN <span style="font-size:12px; color:#555">LIVE</span></h1>
        <div id="status" class="status">Connecting...</div>
    </div>

    <input type="text" id="search" class="search-bar" placeholder="üîç –ü–æ–∏—Å–∫ –∫—É—Ä—å–µ—Ä–∞..." onkeyup="filterList()">
    
    <div id="player-list">
        <div style="text-align:center; padding:20px; color:#555">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã...</div>
    </div>

    <div id="editor" class="modal" onclick="if(event.target===this) closeEditor()">
        <div class="editor-sheet">
            <div class="sheet-header">
                <div>
                    <div class="sheet-title" id="ed-name">Player</div>
                    <div style="font-size:11px; color:#666" id="ed-id">ID: ...</div>
                </div>
                <div><span class="live-tag">LIVE SYNC</span></div>
            </div>

            <div class="control-group">
                <span class="label">–§–∏–Ω–∞–Ω—Å—ã</span>
                <div class="row">
                    <span>üí∞ –ë–∞–ª–∞–Ω—Å:</span>
                    <span id="ed-balance" class="val-disp">0.00 PLN</span>
                </div>
                <div class="action-grid" style="margin-bottom:15px">
                    <button class="btn btn-act" onclick="cmd('MATH_VAR', 'balance', 100)">+100</button>
                    <button class="btn btn-act" onclick="cmd('MATH_VAR', 'balance', 1000)">+1k</button>
                    <button class="btn btn-act" onclick="cmd('MATH_VAR', 'balance', -100)">-100</button>
                    <button class="btn btn-act" onclick="cmd('SET_VAR', 'balance', 0)">–°–ë–†–û–°</button>
                </div>
                
                <div class="row">
                    <span>üè¶ –î–æ–ª–≥:</span>
                    <span id="ed-debt" class="val-disp" style="color:orange">0.00</span>
                </div>
                <button class="btn btn-green" style="width:100%" onclick="cmd('SET_VAR', 'debt', 0); cmd('SET_VAR', 'debtOverdue', false)">‚úÖ –ü–†–û–°–¢–ò–¢–¨ –î–û–õ–ì</button>
            </div>

            <div class="control-group">
                <span class="label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
                <div id="inv-list"></div>
            </div>

            <div class="control-group">
                <span class="label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</span>
                <div style="margin-bottom:10px">
                    <div class="row"><span>‚ö° –≠–Ω–µ—Ä–≥–∏—è</span> <span id="disp-energy">100%</span></div>
                    <input type="range" id="rng-energy" onchange="cmd('SET_VAR', 'needs.energy', parseInt(this.value))">
                </div>
                <div style="margin-bottom:10px">
                    <div class="row"><span>üíß –í–æ–¥–∞</span> <span id="disp-water">100%</span></div>
                    <input type="range" id="rng-water" onchange="cmd('SET_VAR', 'needs.water', parseInt(this.value))">
                </div>
                <div style="margin-bottom:10px">
                    <div class="row"><span>üòé –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span> <span id="disp-mood">100%</span></div>
                    <input type="range" id="rng-mood" onchange="cmd('SET_VAR', 'needs.mood', parseInt(this.value))">
                </div>
            </div>

            <div class="action-grid">
                <button class="btn btn-blue" onclick="cmd('SET_VAR', 'taxi.unlocked', true)">üöñ –û—Ç–∫—Ä—ã—Ç—å –¢–∞–∫—Å–∏</button>
                <button class="btn btn-act" onclick="cmd('EVAL_CODE', 'location.reload()', 0)">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ</button>
                <button id="btn-ban" class="btn btn-red" style="grid-column:span 2" onclick="toggleBan()">üö´ –ó–ê–ë–ê–ù–ò–¢–¨</button>
            </div>

            <button class="btn btn-act" style="width:100%; margin-top:20px; background:#111" onclick="closeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allPlayers = [];
        let activePlayerId = null;
        let activeListener = null;

        // 1. GLOBAL LISTENER
        db.ref('.info/connected').on('value', s => {
            const el = document.getElementById('status');
            if(s.val()) { el.textContent = "CONNECTED"; el.classList.add('connected'); }
            else { el.textContent = "OFFLINE"; el.classList.remove('connected'); }
        });

        db.ref('players').on('value', snap => {
            const data = snap.val();
            allPlayers = [];
            const list = document.getElementById('player-list');
            list.innerHTML = '';

            if(!data) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#555">–ü—É—Å—Ç–æ...</div>'; return; }

            Object.entries(data).forEach(([id, p]) => {
                allPlayers.push({id, ...p});
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –û–Ω–ª–∞–π–Ω –≤—ã—à–µ, –ø–æ—Ç–æ–º –±–æ–≥–∞—Ç—ã–µ
            allPlayers.sort((a,b) => {
                const aOnline = (Date.now() - (a.lastSeen||0) < 15000);
                const bOnline = (Date.now() - (b.lastSeen||0) < 15000);
                if(aOnline && !bOnline) return -1;
                if(!aOnline && bOnline) return 1;
                return (b.balance||0) - (a.balance||0);
            });

            renderList(allPlayers);
        });

        function renderList(arr) {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            arr.forEach(p => {
                const isOnline = (Date.now() - (p.lastSeen||0)) < 15000;
                const name = p.name || p.username || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                const bal = parseFloat(p.balance||0).toFixed(2);
                const s = p.stats || {energy:100, water:100, mood:100};
                
                const div = document.createElement('div');
                div.className = `player-card ${isOnline?'online':''} ${p.isBanned?'banned':''}`;
                div.onclick = () => openEditor(p.id);
                div.innerHTML = `
                    <div class="p-main">
                        <div class="p-name">${name} ${p.isBanned ? '<span style="color:red">[BAN]</span>' : ''}</div>
                        <div class="p-id">ID: ${p.id}</div>
                        <div class="p-bal">${bal} PLN</div>
                        <div class="p-stats-mini">
                            <span><i class="fa-solid fa-bolt"></i> ${Math.floor(s.energy||100)}%</span>
                            <span><i class="fa-solid fa-droplet"></i> ${Math.floor(s.water||100)}%</span>
                            <span><i class="fa-solid fa-circle-check"></i> ${isOnline ? 'ONLINE' : 'OFFLINE'}</span>
                        </div>
                    </div>
                    <button class="btn-mini">EDIT</button>
                `;
                list.appendChild(div);
            });
        }

        function filterList() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allPlayers.filter(p => 
                (p.name && p.name.toLowerCase().includes(term)) || 
                p.id.toString().includes(term)
            );
            renderList(filtered);
        }

        // 2. LIVE EDITOR LOGIC
        function openEditor(id) {
            activePlayerId = id;
            document.getElementById('editor').classList.add('open');
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –∏–≥—Ä–æ–∫–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª–∫–µ
            if(activeListener) db.ref('players/' + id).off('value', activeListener);
            
            activeListener = db.ref('players/' + id).on('value', snap => {
                const p = snap.val();
                if(!p) return;
                
                // Header
                document.getElementById('ed-name').textContent = p.name || '–ò–≥—Ä–æ–∫';
                document.getElementById('ed-id').textContent = id;
                
                // Finance
                document.getElementById('ed-balance').textContent = (p.balance||0).toFixed(2) + ' PLN';
                document.getElementById('ed-debt').textContent = (p.debt||0).toFixed(2) + ' PLN';

                // Stats
                const s = p.stats || p.needs || {energy:100, water:100, mood:100};
                updateSlider('energy', s.energy);
                updateSlider('water', s.water);
                updateSlider('mood', s.mood);

                // Inventory
                renderInventory(p.inventory || {});

                // Ban Button
                const btnBan = document.getElementById('btn-ban');
                if(p.isBanned) {
                    btnBan.textContent = "‚úÖ –†–ê–ó–ë–ê–ù–ò–¢–¨";
                    btnBan.style.background = "#00e676";
                    btnBan.style.color = "black";
                } else {
                    btnBan.textContent = "üö´ –ó–ê–ë–ê–ù–ò–¢–¨";
                    btnBan.style.background = "rgba(255, 61, 0, 0.15)";
                    btnBan.style.color = "#ff3d00";
                }
            });
        }

        function closeEditor() {
            document.getElementById('editor').classList.remove('open');
            if(activePlayerId && activeListener) {
                db.ref('players/' + activePlayerId).off('value', activeListener);
            }
            activePlayerId = null;
        }

        function updateSlider(key, val) {
            val = Math.floor(val || 0);
            document.getElementById('disp-'+key).textContent = val + '%';
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ (—á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞–ª—Å—è –ø–æ–∫–∞ —Ç—è–Ω–µ—à—å)
            if(document.activeElement !== document.getElementById('rng-'+key)) {
                document.getElementById('rng-'+key).value = val;
            }
        }

        function renderInventory(inv) {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            
            const items = [
                {id: 'water', icon: 'üíß', name: '–í–æ–¥–∞'},
                {id: 'bar', icon: 'üç´', name: '–°–Ω–∏–∫–µ—Ä—Å'},
                {id: 'energy_drink', icon: 'üöÄ', name: 'Red Bull'},
                {id: 'coffee', icon: '‚òï', name: '–ö–æ—Ñ–µ'}
            ];

            items.forEach(it => {
                const qty = inv[it.id] || 0;
                const div = document.createElement('div');
                div.className = 'inv-row';
                div.innerHTML = `
                    <div class="inv-icon">${it.icon}</div>
                    <div class="inv-name">${it.name}</div>
                    <div class="inv-qty">${qty}</div>
                    <div style="display:flex; gap:5px; margin-left:10px">
                        <button class="inv-btn" style="background:#444; color:white" onclick="cmd('MATH_VAR', 'inventory.${it.id}', 1)">+</button>
                        <button class="inv-btn" style="background:#222; color:#aaa" onclick="cmd('MATH_VAR', 'inventory.${it.id}', -1)">-</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // 3. COMMAND SENDER (The Magic)
        function cmd(type, path, value) {
            if(!activePlayerId) return;
            
            // –ï—Å–ª–∏ –º—ã –±–∞–Ω–∏–º, –º–µ–Ω—è–µ–º –≤ –±–∞–∑–µ –ù–ê–ü–†–Ø–ú–£–Æ, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –≤—ã–ª–µ—Ç–µ–ª
            // (Client listener –≤ index.html –ª–æ–≤–∏—Ç —ç—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            if(type === 'BAN_TOGGLE') {
                // –õ–æ–≥–∏–∫–∞ –±–∞–Ω–∞ –Ω–∏–∂–µ
                return;
            }

            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º Inbox –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            const payload = { type, path, value, timestamp: Date.now() };
            db.ref('players/' + activePlayerId + '/adminInbox').push(payload);
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
            if(navigator.vibrate) navigator.vibrate(20);
        }

        function toggleBan() {
            if(!activePlayerId) return;
            // –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ—Ç–æ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
            db.ref('players/' + activePlayerId + '/isBanned').once('value', s => {
                const isBanned = s.val();
                db.ref('players/' + activePlayerId).update({ isBanned: !isBanned });
            });
        }

    </script>
</body>
</html>
